<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculadora Penal</title>
<link rel="manifest" href="manifest.json">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<style>
/* TUS ESTILOS ORIGINALES */
body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 15px; color: #333; margin: 0; }
.header-app { text-align: center; padding: 25px 10px; background: white; margin-bottom: 20px; border-bottom: 3px solid #1a73e8; }
.header-app h1 { font-size: 1.5em; color: #1a73e8; margin: 0; text-transform: uppercase; letter-spacing: 1px; }
.header-app p { margin: 5px 0 0; font-weight: bold; color: #555; font-size: 1em; }

/* BARRA DE USUARIO ACTUALIZADA */
.user-status-bar { 
background: #f8f9fa; 
padding: 8px 15px; 
border-radius: 8px; 
margin: -10px 10px 20px 10px; 
display: flex; 
justify-content: space-between; 
align-items: center;
font-size: 0.75em; 
color: #666;
border: 1px solid #e1e4e8;
}
.btn-logout { background: #fee2e2; color: #dc2626; border: 1px solid #fca5a5; padding: 4px 8px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-left: 10px; }

/* ESTILO PARA EL INTERRUPTOR DE NUBE */
.switch-container {
display: flex;
align-items: center;
justify-content: space-between;
background: #e8f0fe;
padding: 10px 15px;
border-radius: 10px;
margin-bottom: 15px;
border: 1px solid #1a73e8;
}
.switch { position: relative; display: inline-block; width: 40px; height: 22px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
.slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: #1a73e8; }
input:checked + .slider:before { transform: translateX(18px); }

.modulo { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
.sub-modulo { background: #f8f9fa; border: 1px dashed #1a73e8; padding: 15px; border-radius: 10px; margin-top: 15px; display: none; }
h2 { color: #1a73e8; font-size: 1em; margin-top: 0; border-bottom: 2px solid #e8f0fe; padding-bottom: 10px; text-transform: uppercase; }
label { display: block; margin-top: 12px; font-weight: 600; font-size: 0.85em; color: #555; }
input, select, textarea { width: 100%; padding: 12px; margin-top: 5px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; font-size: 1em; }
#listaCasos, #listaCasosGestion { max-height: 200px; overflow-y: auto; margin-top: 10px; border-radius: 8px; background: #fff; }
.btn-principal { width: 100%; background: #1a73e8; color: white; border: none; padding: 18px; border-radius: 12px; font-weight: bold; font-size: 1.1em; margin-top: 10px; cursor: pointer; }
.btn-whatsapp { width: 100%; background: #25D366; color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; margin-top: 5px; display: flex; align-items: center; justify-content: center; text-decoration: none; font-size: 1em; }
.btn-pdf { width: 100%; background: #e74c3c; color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; margin-top: 10px; cursor: pointer; font-size: 1em; display: none; }
.btn-add { background: #34a853; color: white; border: none; padding: 8px 12px; border-radius: 8px; margin-top: 10px; font-size: 0.8em; cursor: pointer; font-weight: bold; }
.btn-calc-red { background: #6c757d; color: white; border: none; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.9em; cursor: pointer; width: 100%; }
.btn-save { background: #28a745; margin-bottom: 10px; }
.btn-delete { background: #dc3545; color: white; border: none; padding: 5px 8px; border-radius: 5px; cursor: pointer; font-size: 0.8em; }
.grid-3 { display: flex; gap: 8px; }
.grid-red { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 8px; align-items: center; margin-top: 10px; }
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.beneficio-item { margin-bottom: 15px; padding: 12px; border-radius: 10px; background: #fff; border: 1px solid #e1e4e8; font-size: 0.9em; line-height: 1.4; }
.case-card { border-left: 5px solid #1a73e8; background: #f8f9fa; padding: 10px; margin-bottom: 5px; border-radius: 8px; font-size: 0.85em; display: flex; justify-content: space-between; align-items: center; }
.search-box { background: #e8f0fe; padding: 15px; border-radius: 15px; margin-bottom: 20px; }
.res-box { background: #f0f7ff; padding: 15px; border-radius: 10px; margin-top: 10px; border-left: 5px solid #1a73e8; }
.txt-destaque { color: #d93025; font-weight: bold; }
.txt-cumplido { color: #28a745; font-weight: bold; }
.db-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
.btn-db { background: #6c757d; color: white; border: none; padding: 10px; border-radius: 8px; font-size: 0.8em; cursor: pointer; font-weight: bold; }
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow-y: auto; }
.modal-content { background-color: white; margin: 5% auto; padding: 20px; border-radius: 15px; width: 90%; max-width: 600px; line-height: 1.5; font-size: 0.85em; position: relative; }
.close-modal { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }

.tabs-container { display: flex; background: #fff; margin-bottom: 20px; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
.tab-button { flex: 1; padding: 15px; border: none; background: #eee; cursor: pointer; font-weight: bold; color: #666; transition: 0.3s; font-size: 0.8em; }
.tab-button.active { background: #1a73e8; color: white; }
.tab-content { display: none; }
.tab-content.active { display: block; }
.calc-res { background: #fff3cd; padding: 10px; border-radius: 8px; margin-top: 10px; border-left: 5px solid #ffc107; font-weight: bold; color: #856404; }

.report-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.8em; }
.report-table th, .report-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
.report-table th { background-color: #f2f2f2; }

/* ESTILOS PARA EL CONTRATO */
.contrato-scroll {
height: 300px;
overflow-y: scroll;
border: 1px solid #ccc;
padding: 15px;
background: #f9f9f9;
text-align: justify;
font-size: 0.9em;
margin-bottom: 15px;
border-radius: 8px;
}

/* Agrega esto a tus estilos CSS */
.grid-4 { 
    display: grid; 
    grid-template-columns: 1fr 1fr 1fr 1fr; 
    gap: 8px; 
}
</style>
</head>
<body>

<div id="auth-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#1a2a40; z-index:9999; display:flex; align-items:center; justify-content:center; color:white; font-family:sans-serif;">
<div style="background:white; padding:30px; border-radius:20px; width:85%; max-width:350px; text-align:center; color:#333;">
<h2 style="margin:0; color:#1a73e8;">IURIS PENAL</h2>
<p id="auth-title" style="margin-bottom:20px; font-size:0.9em; color:#666;">Inicie Sesi√≥n para continuar</p>

<input type="email" id="f_email" placeholder="Correo electr√≥nico" style="width:100%; padding:12px; margin:8px 0; border:1px solid #ddd; border-radius:8px;">
<input type="password" id="f_pass" placeholder="Contrase√±a (m√≠n. 6 caracteres)" style="width:100%; padding:12px; margin:8px 0; border:1px solid #ddd; border-radius:8px;">

<button id="btn-login" onclick="loginFirebase()" style="width:100%; padding:15px; background:#1a73e8; color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer; margin-top:10px;">ENTRAR</button>
<p style="margin-top:10px;"><a href="#" onclick="olvideClave()" style="color:#1a73e8; font-size:0.8em; text-decoration:none;">¬øOlvid√≥ su contrase√±a?</a></p>

<div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
<p style="font-size:0.8em; color:#666;">¬øNo tienes cuenta?</p>
<input type="text" id="f_referido" placeholder="¬øQui√©n lo refiri√≥? (Opcional)" style="width:100%; padding:12px; margin:8px 0; border:1px solid #ddd; border-radius:8px; background: #fffde7;">
<button onclick="registroFirebase()" style="width:100%; padding:10px; background:#34a853; color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer;">CREAR CUENTA NUEVA</button>
</div>

<p id="f_error" style="color:red; font-size:12px; margin-top:15px; min-height:15px;"></p>
</div>
</div>

<div id="app-container">
<div class="header-app">
<h1>Calculadora Penal</h1>
<p>Consultora Iuris</p>
</div>

<div id="status-bar" class="user-status-bar" style="display:none;">
<div>üë§ <b id="user-display">Cargando...</b> <button class="btn-logout" onclick="logoutFirebase()">Salir</button></div>
<span>‚è≥ <b id="days-display">--</b></span>
</div>

<div class="tabs-container no-print">
<button class="tab-button active" onclick="openTab(event, 'gestion')">üìÅ Gesti√≥n de Expedientes</button>
<button class="tab-button" onclick="openTab(event, 'principal')">C√≥mputo de Pena</button>
<button class="tab-button" onclick="openTab(event, 'calculadora')">Herramientas para Dosimetr√≠a y C√≥mputo</button>
<button id="tab-admin" class="tab-button" style="display:none; background: #991b1b; color: white;" onclick="openTab(event, 'adminPanel')">üõ°Ô∏è Admin</button>
</div>

<div id="gestion" class="tab-content active">
    <div class="modulo search-box">
        <h2>üìÇ Todos los Casos</h2>
        <div class="switch-container">
            <span>‚òÅÔ∏è Sincronizar con la  Nube</span>
            <label class="switch">
                <input type="checkbox" id="syncToggleGestion" onchange="actualizarEstadoSync(this.checked)">
                <span class="slider"></span>
            </label>
        </div>
        <input type="text" id="busquedaGestion" placeholder="Buscar por nombre o c√©dula..." onkeyup="listarCasosGestion()">
        
        <div id="listaCasosGestion" style="max-height: 150px; overflow-y: auto; margin-top: 10px;"></div>
        <button class="btn-principal" style="background:#107c41; margin-top:10px; padding: 10px; font-size: 0.85em;" onclick="exportarTodaLaDataExcel()">
            üìó EXPORTAR TODA LA BASE DE DATOS A EXCEL
        </button>
    </div>



    <div class="modulo">
        <h2>üìù Registro de Informaci√≥n</h2>
        <input type="hidden" id="idCasoGestion">
        
        <div class="grid-2">
            <div><label>Nombre Completo:</label><input type="text" id="gNombre" oninput="document.getElementById('pNombre').value = this.value"></div>
            <div><label>C√©dula:</label><input type="text" id="gCedula" oninput="document.getElementById('pCedula').value = this.value"></div>
        </div>

        <div class="grid-3">
            <div><label>Exp. Judicial:</label><input type="text" id="gExpJud"></div>
            <div><label>Exp. Fiscal√≠a:</label><input type="text" id="gExpFis"></div>
            <div><label>Exp. Carcelario:</label><input type="text" id="gExpCar"></div>
        </div>

        <div class="grid-2">
            <div><label>Fiscal√≠a N¬∫:</label><input type="text" id="gNumFis"></div>
            <div><label>Tribunal:</label><input type="text" id="gTribunal"></div>
        </div>

        <label>Centro de Reclusi√≥n:</label><input type="text" id="gLugar">

        <div class="grid-2">
            <div>
                <label>Fase Procesal:</label>
                <select id="gFase">
                    <option value="Preparatoria">Preparatoria</option>
                    <option value="Intermedia">Intermedia</option>
                    <option value="Juicio">Juicio</option>
                    <option value="Ejecuci√≥n">Ejecuci√≥n</option>
                </select>
            </div>
            <div><label>Delito:</label><input type="text" id="gDelito"></div>
        </div>

        <div style="background: #fdf2f2; padding: 10px; border-radius: 8px; margin-top: 10px; border: 1px solid #fca5a5;">
            <label>¬øCaso de Drogas?</label>
            <select id="gEsDrogas" onchange="document.getElementById('gDivDrogas').style.display = (this.value=='si'?'block':'none')">
                <option value="no">No</option>
                <option value="si">S√≠</option>
            </select>
            <div id="gDivDrogas" style="display:none; margin-top:10px;">
                <div class="grid-2">
                    <div><label>Tipo de Droga:</label><input type="text" id="gTipoDroga" placeholder="Ej: Coca√≠na"></div>
                    <div><label>Cantidad:</label><input type="text" id="gCantDroga" placeholder="Ej: 500g"></div>
                </div>
            </div>
        </div>

        <div id="seccionEjecucionGestion" style="background: #fff9db; padding: 10px; border-radius: 8px; margin-top: 10px;">
            <label>Fecha de Detenci√≥n Inicial:</label>
            <input type="date" id="gFechaIni" oninput="document.getElementById('fDetencionUnica').value = this.value">
        </div>

        <div class="grid-2">
            <div><label>Familiar:</label><input type="text" id="gFamiliar"></div>
            <div><label>Tel√©fono:</label><input type="text" id="gTel"></div>
        </div>

        <button class="btn-principal btn-save" onclick="guardarCasoCompleto()">üíæ GUARDAR EXPEDIENTE</button>
        <button class="btn-add" style="background:#dc3545; width:100%; margin-top:10px;" onclick="nuevoExpedienteGestion()">NUEVO / LIMPIAR</button>
    </div>

    <div class="modulo">
        <h2>üìÖ Bit√°cora y Agenda</h2>
        <div class="grid-2">
            <div>
                <label>Fecha del Evento:</label>
                <input type="datetime-local" id="evFecha">
            </div>
            <div>
                <label>üîî Avisarme el d√≠a y hora:</label>
                 <input type="datetime-local" id="evRecordatorio">
            </div>
        </div>
        <label>Descripci√≥n:</label>
        <input type="text" id="evMinuta" placeholder="Ej: Audiencia Preliminar...">
        <button class="btn-add" style="width: 100%; margin-top: 10px;" onclick="agregarEvento()">+ Registrar Evento y Recordatorio</button>
        
        <div id="scrollEventos" style="margin-top: 15px; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 8px; background: #fafafa;">
            <p style="text-align: center; color: #999;">Seleccione un caso para ver sus eventos</p>
        </div>
    </div>
</div>

<div id="principal" class="tab-content">
    <div class="modulo search-box no-print">
        <h2>üìÇ Casos de Privados Condenados</h2>

        <div class="switch-container">
            <span style="font-size: 0.85em; font-weight: bold; color: #1a73e8;">‚òÅÔ∏è Sincronizar con la Nube</span>
            <label class="switch">
                <input type="checkbox" id="syncToggle" onchange="actualizarEstadoSync(this.checked)">
                <span class="slider"></span>
            </label>
        </div>

        <input type="text" id="busqueda" placeholder="Escriba nombre o c√©dula..." onkeyup="listarCasos()">
        <div id="listaCasos"></div>
    </div>

    <div class="modulo">
        <input type="hidden" id="casoActivoId" value="">
        <h2>0. Datos del Privado de Libertad</h2>
        <div class="grid-2">
            <div><label>Nombre:</label><input type="text" id="pNombre" required oninput="document.getElementById('gNombre').value = this.value"></div>
            <div><label>C√©dula:</label><input type="text" id="pCedula" required oninput="document.getElementById('pCedula').value = this.value"></div>
        </div>
        <div class="grid-2">
            <div><label>Exp. Judicial:</label><input type="text" id="pExpJud"></div>
            <div><label>Exp. Carcelario:</label><input type="text" id="pExpCar"></div>
        </div>
        <label>Delito:</label><input type="text" id="pDelito" placeholder="Ej: Robo Agravado">
        <label>Lugar de Reclusi√≥n:</label><input type="text" id="pLugar">
    </div>

    <div class="modulo">
        <h2>1. Condena y Fechas de Detencion</h2>
        <div class="grid-3">
            <div><label>A√±os</label><input type="number" id="cAno" placeholder="0"></div>
            <div><label>Meses</label><input type="number" id="cMes" placeholder="0"></div>
            <div><label>D√≠as</label><input type="number" id="cDia" placeholder="0"></div>
        </div>
        <label>¬øAcumulaci√≥n de Penas / Periodos?</label>
        <select id="esAcum" onchange="toggleAcumulacion()"><option value="no">No</option><option value="si">S√≠</option></select>

        <div id="seccionUnica">
            <label>Fecha Detenci√≥n:</label>
            <input type="date" id="fDetencionUnica" oninput="document.getElementById('gFechaIni').value = this.value">
        </div>

        <div style="margin-top: 15px; padding: 10px; background: #fffbe6; border: 1px solid #ffe58f; border-radius: 8px;">
            <label style="color: #856404; margin-top: 0;">üìÖ Realizar c√≥mputo a la fecha de:</label>
            <input type="date" id="fFechaCorte">
            <small style="color: #666;">(Por defecto es hoy, pero puede cambiarla)</small>
        </div>

        <div id="seccionAcumulada" style="display:none;">
            <div id="contenedorPeriodos"></div>
            <button class="btn-add no-print" onclick="agregarPeriodo()">+ Agregar Periodo Anterior</button>
            <label>Detenci√≥n Actual (Desde):</label><input type="date" id="fDetencionActual">
        </div>
    </div>

    <div class="modulo no-print">
        <h2>2. Tiempo Redimido</h2>
        <div id="listaRedenciones"></div>
        <button class="btn-add" onclick="agregarFilaRedencion(0,0,0)">+ A√±adir Manualmente</button>
        <button class="btn-calc-red" onclick="toggleSubModulo()">Calculadora de redenciones</button>
        <div id="subModuloRedencion" class="sub-modulo">
            <h3>C√°lculo de Redencion</h3>
            <label>Fecha de Inicio de Labores:</label><input type="date" id="redInicio">
            <label>Fecha de Fin de Labores:</label><input type="date" id="redFin">
            <div class="grid-2">
                <div><label>D√≠as/Semana:</label><input type="number" id="redDiasSemana" value="5"></div>
                <div><label>Horas/D√≠a:</label><input type="number" id="redHorasDia" value="8"></div>
            </div>
            <button class="btn-principal" style="background:#28a745; padding:10px;" onclick="procesarRedencionAutomatica()">Procesar</button>
            <div id="resultadoMiniRed"></div>
        </div>
    </div>

    <div id="controles-principales" style="padding: 0 15px;" class="no-print">
        <button class="btn-principal btn-save" id="btnGuardar" onclick="guardarCasoCompleto()">üíæ GUARDAR EXPEDIENTE</button>
        <button class="btn-principal" onclick="validarYCalcular()">CALCULAR C√ìMPUTO Y BENEFICIOS</button>
        <button class="btn-add" style="background:#dc3545; width:100%; margin-top:10px;" onclick="nuevoExpediente()">NUEVO / LIMPIAR</button>
    </div>

    <div id="resultado" class="modulo" style="display:none;">
        <h2 id="resTitulo">Resultados</h2>
        <button onclick="copiarResultados(event)" class="btn-principal" style="background: #6c757d; margin: 10px 0; width: 100%; font-size: 0.85em;">
    Copiar Resultados al Portapapeles üìã
</button>

        <div id="resResumen"></div><hr>
        <h3>Proyecci√≥n de Beneficios Penales</h3>
        <div id="resBeneficios"></div>
    </div>
</div>

<div id="calculadora" class="tab-content">
<div class="modulo">
    <h2>C√°lculo de T√©rmino Medio (Dosimetr√≠a)</h2>
    
    <label>L√≠mite M√≠nimo (L√≠mite Inferior):</label>
    <div class="grid-4">
        <input type="number" id="tm_min_a" placeholder="A√±os">
        <input type="number" id="tm_min_m" placeholder="Meses">
        <input type="number" id="tm_min_d" placeholder="D√≠as">
        <input type="number" id="tm_min_h" placeholder="Horas">
    </div>

    <label style="margin-top:10px;">L√≠mite M√°ximo (L√≠mite Superior):</label>
    <div class="grid-4">
        <input type="number" id="tm_max_a" placeholder="A√±os">
        <input type="number" id="tm_max_m" placeholder="Meses">
        <input type="number" id="tm_max_d" placeholder="D√≠as">
        <input type="number" id="tm_max_h" placeholder="Horas">
    </div>

    <button class="btn-principal" style="padding:10px; background:#1a73e8; margin-top:10px;" onclick="calcularTerminoMedio()">Calcular T√©rmino Medio</button>
    <div id="resTM" class="calc-res"></div>
</div>

<div class="modulo">
    <h2>Concurso Ideal de Delitos</h2>
    <p><small>Pena del delito m√°s grave:</small></p>
    <div class="grid-4">
        <input type="number" id="ideal_a" placeholder="A√±os">
        <input type="number" id="ideal_m" placeholder="Meses">
        <input type="number" id="ideal_d" placeholder="D√≠as">
        <input type="number" id="ideal_h" placeholder="Horas">
    </div>
    
    <label style="margin-top:20px;">Deslice para ajustar el incremento:</label>
    <div style="padding: 10px 0;">
        <input type="range" id="sliderIncremento" min="0" max="50" step="0.01" value="16.66" style="width: 100%;" oninput="actualizarLabelIncremento(this.value)">
        <div style="text-align: center; margin-top: 10px; font-weight: bold; color: #e67e22;">
            Aumento: <span id="labelProporcionInc">1/6</span> (<span id="labelPorcentajeInc">16.66</span>%)
        </div>
    </div>

    <button class="btn-principal" style="padding:10px; background:#e67e22;" onclick="calcularConcursoIdeal()">Calcular Pena Resultante</button>
    <div id="resIdeal" class="calc-res" style="border-left: 5px solid #e67e22;"></div>
</div>

<div class="modulo">
    <h2>Concurso Real de Delitos</h2>
    <p><small>Regla: Pena mayor + mitad de la suma de las penas restantes.</small></p>
    <div id="listaPenasReal">
        <div class="grid-4" style="margin-bottom: 8px;">
            <input type="number" class="ra" placeholder="A√±os">
            <input type="number" class="rm" placeholder="Meses">
            <input type="number" class="rd" placeholder="D√≠as">
            <input type="number" class="rh" placeholder="Horas"> </div>
    </div>
    <button class="btn-add" onclick="agregarFilaPenaReal()">+ Agregar otra condena</button>
    <button class="btn-principal" style="padding:10px; background:#8e44ad; margin-top: 15px;" onclick="calcularConcursoReal()">Calcular Pena Resultante</button>
    <div id="resReal" class="calc-res" style="border-left: 5px solid #8e44ad;"></div>
</div>

<div class="modulo">
    <h2>Rebaja por Admisi√≥n de los Hechos</h2>
    <label>Pena impuesta o estimada:</label>
    <div class="grid-4">
        <input type="number" id="adm_a" placeholder="A√±os">
        <input type="number" id="adm_m" placeholder="Meses">
        <input type="number" id="adm_d" placeholder="D√≠as">
        <input type="number" id="adm_h" placeholder="Horas">
    </div>
    
    <label style="margin-top:20px;">Deslice para ajustar la rebaja:</label>
    <div style="padding: 10px 0;">
        <input type="range" id="sliderRebaja" min="0" max="50" step="0.01" value="33.33" style="width: 100%;" oninput="actualizarLabelRebaja(this.value)">
        <div style="text-align: center; margin-top: 10px; font-weight: bold; color: #1a73e8;">
            Proporci√≥n: <span id="labelProporcion">1/3</span> (<span id="labelPorcentaje">33.33</span>%)
        </div>
    </div>

    <button class="btn-principal" style="padding:10px; background:#27ae60;" onclick="calcularAdmision()">Calcular Pena con Rebaja</button>
    <div id="resAdmision" class="calc-res"></div>
</div>

<div class="modulo">
<h2>7.1 Calcular lapso entre dos fechas</h2>
<div class="grid-2">
<div><label>Fecha Inicial:</label><input type="date" id="calc71_inicio"></div>
<div><label>Fecha Final:</label><input type="date" id="calc71_fin"></div>
</div>
<button class="btn-principal" style="padding:10px;" onclick="calc71()">Calcular Lapso</button>
<div id="res71" class="calc-res"></div>
</div>

<div class="modulo">
<h2>7.2 Sumar lapsos de tiempo</h2>
<div id="listaLapsosSuma">
<div class="grid-3"><input type="number" class="sa" placeholder="A√±os"><input type="number" class="sm" placeholder="M"><input type="number" class="sd" placeholder="D"></div>
</div>
<button class="btn-add" onclick="agregarFilaSuma()">+ Agregar otro lapso</button>
<button class="btn-principal" style="padding:10px;" onclick="calc72()">Sumar Lapsos</button>
<div id="res72" class="calc-res"></div>
</div>

<div class="modulo">
<h2>7.3 Restar dos lapsos</h2>
<p><small>Ingrese el lapso mayor arriba y el que desea restar abajo</small></p>
<div class="grid-3">
<input type="number" id="r1a" placeholder="A√±os">
<input type="number" id="r1m" placeholder="Meses">
<input type="number" id="r1d" placeholder="D√≠as">
</div>
<div style="text-align:center; margin: 5px 0; font-weight:bold; color:#1a73e8;">MENOS</div>
<div class="grid-3">
<input type="number" id="r2a" placeholder="A√±os">
<input type="number" id="r2m" placeholder="Meses">
<input type="number" id="r2d" placeholder="D√≠as">
</div>
<button class="btn-principal" style="padding:10px;" onclick="calc73()">Restar Lapsos</button>
<div id="res73" class="calc-res"></div>
</div>

<div class="modulo">
<h2>7.4 y 7.5 Sumar/Restar Lapso a una Fecha</h2>
<label>Fecha Base:</label><input type="date" id="fBase745">
<div class="grid-3"><input type="number" id="la745" placeholder="A√±os"><input type="number" id="lm745" placeholder="Meses"><input type="number" id="ld745" placeholder="D√≠as"></div>
<div class="grid-2">
<button class="btn-principal" style="padding:10px; background:#e67e22;" onclick="calc745('restar')">Restar Lapso</button>
<button class="btn-principal" style="padding:10px; background:#27ae60;" onclick="calc745('sumar')">Sumar Lapso</button>
</div>
<div id="res745" class="calc-res"></div>
</div>

<div class="modulo">
<h2>7.6 Fragmentar una pena</h2>
<div class="grid-3"><input type="number" id="fra" placeholder="A√±os"><input type="number" id="frm" placeholder="Meses"><input type="number" id="frd" placeholder="D√≠as"></div>
<label>Fracci√≥n (Ejemplo: 1/3 o 3/4):</label>
<input type="text" id="fraccion" placeholder="1/2">
<button class="btn-principal" style="padding:10px;" onclick="calc76()">Calcular Fracci√≥n</button>
<div id="res76" class="calc-res"></div>
</div>
</div>

<div id="adminPanel" class="tab-content">
    <div class="modulo">
        <h2>üë• Gesti√≥n de Usuarios y Suscripciones</h2>
        <button class="btn-principal" onclick="cargarUsuariosAdmin()" style="background:#4b5563; margin-bottom:15px;">üîÑ Refrescar Lista de Usuarios</button>
        
        <div style="overflow-x: auto;">
            <table class="report-table" id="tablaUsuarios">
                <thead>
                    <tr>
                        <th>Email / Registro</th>
                        <th>Referido por</th>
                        <th>Estado</th>
                        <th>Vencimiento</th>
                        <th>Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="bodyUsuariosAdmin">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modulo no-print" style="text-align: center;">
<p style="margin-bottom: 5px; font-weight: bold; color: #1a73e8;">Consulta legal, Soporte Tecnico, Pagos</p>
<button onclick="abrirWhatsApp()" class="btn-whatsapp">WhatsApp Dr. Charles Reyes</button>
</div>

<div class="modulo" style="background: #e8f5e9; border: 2px dashed #2e7d32; text-align: center;">
    <h3 style="color: #2e7d32; margin-top: 0;">üéÅ ¬°Gana 30 d√≠as GRATIS!</h3>
    <p style="font-size: 0.85em;">Recomienda la App a un colega. Si tu referido se suscribe, ambos reciben un mes de regalo.</p>
    <button onclick="compartirReferido()" class="btn-principal" style="background: #2e7d32; padding: 12px;">
        Recomendar a un Colega üì≤
    </button>
</div>

</div>

<div id="modalTerminos" class="modal" style="background: rgba(0,0,0,0.8);">
<div class="modal-content" style="max-width: 700px;">
<h2 style="font-size: 1.2em; text-align: center;">T√âRMINOS Y CONDICIONES DE USO DE LA APLICACI√ìN CALCULADORA PENAL DEL DR. CHARLES REYES</h2>
<p style="font-size: 0.8em; color: #666; text-align: center;">Fecha de √öltima Actualizaci√≥n: 26 de Diciembre de 2025</p>

<div class="contrato-scroll">
<p><strong>IMPORTANTE:</strong> La aceptaci√≥n de estos T&C es obligatoria para el uso de la Aplicaci√≥n. Al hacer clic en "Aceptar" o al utilizar la Aplicaci√≥n, el Usuario declara haber le√≠do, entendido y aceptado plenamente todas las cl√°usulas aqu√≠ contenidas.</p>

<p><strong>1. DEFINICIONES Y OBJETO</strong><br>
1.1. Aplicaci√≥n: Se refiere al software Calculadora Penal del Dr. Charles Reyes...<br>
1.2. Desarrollador: Dr. Charles Reyes, creador y propietario de la Aplicaci√≥n.<br>
1.3. Usuario: Cualquier persona que acceda o utilice la Aplicaci√≥n...<br>
1.5. Cifrado de Extremo a Extremo (E2EE): Mecanismo de seguridad que garantiza que la Data del Usuario es cifrada en el dispositivo del Usuario , utilizando el correo electronico para cifrar los datos, esta ap√±icacion no utiliza llave maestra para cifrar datos, en consexuencia no se garantiza la seguridad total de los datos</p>

<p><strong>2. PROPIEDAD INTELECTUAL</strong><br>
2.1. Titularidad: El Desarrollador es el √∫nico y exclusivo propietario de todos los derechos de propiedad intelectual e industrial sobre la Aplicaci√≥n...</p>

<p><strong>3. RESPONSABILIDADES Y ADVERTENCIAS LEGALES DEL USUARIO</strong><br>
El Usuario reconoce que la Aplicaci√≥n es una herramienta de apoyo y que no sustituye el criterio profesional.<br>
3.1. Advertencia para el Abogado Litigante (Secreto Profesional): El Usuario que act√∫e como Abogado Litigante en el libre ejercicio de su profesion, declara conocer y aceptar que es el √∫nico responsable de garantizar el cumplimiento del Secreto Profesional y que cuenta con la autorizacion para enviar data sensible a servidores externos, en este caso encriptada a los servidores de firebase de google, sin embargo el usuario puese escogwr a traves de un interruptor si guarda la informacion en la nube o localmente en su dispositivo.<br>
3.2. Advertencia para el Funcionario P√∫blico (Riesgo Administrativo y Penal): La Aplicaci√≥n no es un sistema de informaci√≥n oficial ni est√° homologada por las autoridades competentes de la Rep√∫blica Bolivariana de Venezuela, no cumple con las formalidades de la Ley de Infogobierno y el servidor se encuentra alojado fuera de la Republica, aunque la informacion se graba de manera encriptada, la legislacion venezolana prohibe que los servidores esten en custodia y control de un tercero, en consecuencia, todo usuario que se registre y haga uso de esta aplicacion declara QUE NO ES FUNCIONARIO PUBLICO DE LA REPUBLICA BOLIVARIANA DE VENEZUELA relacionado con data sensible de los privados de libertad y libra de toda responsabilidad civil, administrativa y penal al propietario y administrador de esta aplicacion, en conclusion si usted es funcionario publico, por favor ABSTENERSE de usar esta aplicacion.<br>
3.3. Advertencia para el Familiar del Detenido: La Aplicaci√≥n no proporciona asesor√≠a legal; los resultados son meramente indicativos.</p>

<p><strong>4. ALMACENAMIENTO DE DATOS Y SEGURIDAD (E2EE)</strong><br>
4.1. Cifrado de Extremo a extremo (E2EE) y Clave de Usuario: Toda la Data del Usuario ingresada en la Aplicaci√≥n es cifrada mediante E2EE...<br>
4.2. No Acceso al Contenido: El Desarrollador no posee las claves de descifrado y, por lo tanto, no tiene acceso al contenido de la Data del Usuario...<br>
4.4. Exoneraci√≥n por Contenido: El Desarrollador queda totalmente exonerado de cualquier responsabilidad penal, civil o administrativa derivada del contenido de la Data del Usuario.</p>

<p><strong>5. LIMITACI√ìN DE RESPONSABILIDAD</strong><br>
5.1. Exoneraci√≥n por P√©rdida de Datos: El Desarrollador no ser√° responsable por la p√©rdida, corrupci√≥n o inaccesibilidad de la Data del Usuario...<br>
5.2. Exoneraci√≥n por Resultados de C√°lculo: El Desarrollador no garantiza la exactitud absoluta de los c√°lculos generados por la Aplicaci√≥n.</p>

<p><strong>6. USOS PROHIBIDOS</strong><br>
El Usuario se compromete a no utilizar la Aplicaci√≥n para fines il√≠citos o fraudulentos.</p>

<p><strong>7. CIERRE Y TERMINACI√ìN DE CUENTA</strong><br>
El Desarrollador se reserva el derecho de suspender o terminar la cuenta de cualquier Usuario sin previo aviso.</p>

<p><strong>8. LEY APLICABLE Y JURISDICCI√ìN</strong><br>
Estos T&C se rigen e interpretan de conformidad con las leyes de la Rep√∫blica Bolivariana de Venezuela. Cualquier controversia ser√° sometida a la jurisdicci√≥n exclusiva de los tribunales civilew competentes de la ciudad de San Crist√≥bal, Estado T√°chira Venezuela.</p>
</div>

<button class="btn-principal" onclick="aceptarTerminos()" style="padding:15px; background: #34a853;">HE LE√çDO, ENTIENDO Y ACEPTO LOS T√âRMINOS Y CONDICIONES</button>
</div>
</div>

<div id="modalVencimiento" class="modal" style="background-color: rgba(0,0,0,0.9);">
<div class="modal-content" style="text-align: center; margin-top: 15%;">
<h2 style="color: #d93025;">PERIODO DE PRUEBA FINALIZADO</h2>
<p>Para continuar utilizando las herramientas de <b>Iuris Penal</b> y mantener el acceso a sus expedientes, por favor contacte al administrador para activar un plan de suscripci√≥n.</p>
<button onclick="abrirWhatsAppSuscripcion()" class="btn-whatsapp">
üì≤ Contactar al Dr. Charles Reyes
</button>
</div>
</div>

<div id="plantilla-pdf" style="display: none; padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #333;">
    <div style="text-align: center; border-bottom: 2px solid #1a73e8; padding-bottom: 10px; margin-bottom: 20px;">
        <h2 style="margin: 0; color: #1a73e8;">INFORME T√âCNICO DE C√ìMPUTO PENAL</h2>
        <p style="margin: 5px 0; font-weight: bold;">Consultora Iuris - Dr. Charles Reyes</p>
    </div>

    <h3 style="background: #f0f2f5; padding: 8px;">I. DATOS DEL PRIVADO DE LIBERTAD</h3>
    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
        <tr>
            <td style="padding: 5px; border: 1px solid #ddd; width: 30%;"><strong>Nombre:</strong></td>
            <td id="pdf-nombre" style="padding: 5px; border: 1px solid #ddd;"></td>
        </tr>
        <tr>
            <td style="padding: 5px; border: 1px solid #ddd;"><strong>C√©dula:</strong></td>
            <td id="pdf-cedula" style="padding: 5px; border: 1px solid #ddd;"></td>
        </tr>
        <tr>
            <td style="padding: 5px; border: 1px solid #ddd;"><strong>Exp. Judicial:</strong></td>
            <td id="pdf-exp" style="padding: 5px; border: 1px solid #ddd;"></td>
        </tr>
        <tr>
            <td style="padding: 5px; border: 1px solid #ddd;"><strong>Delito:</strong></td>
            <td id="pdf-delito" style="padding: 5px; border: 1px solid #ddd;"></td>
        </tr>
        <tr id="pdf-fila-drogas" style="display: none;">
            <td style="padding: 5px; border: 1px solid #ddd;"><strong>Drogas:</strong></td>
            <td id="pdf-drogas" style="padding: 5px; border: 1px solid #ddd;"></td>
        </tr>
    </table>

    <h3 style="background: #f0f2f5; padding: 8px;">II. RESUMEN DEL C√ìMPUTO</h3>
    <div id="pdf-resumen-calculo" style="margin-bottom: 20px; line-height: 1.6;">
        </div>

    <h3 style="background: #f0f2f5; padding: 8px;">III. PROYECCI√ìN DE BENEFICIOS PENALES</h3>
    <div id="pdf-beneficios">
        </div>

    <div style="margin-top: 50px; text-align: center;">
        <div style="width: 200px; border-top: 1px solid #000; margin: 0 auto;"></div>
        <p style="font-size: 0.8em;">Firma Autorizada<br>Especialista en Derecho Penal</p>
    </div>
</div>

<script>
// FUNCI√ìN DE AYUDA PARA FORMATO DE FECHA LATINO
function formatFechaLatina(fechaStr) {
    if(!fechaStr) return "";
    const [y, m, d] = fechaStr.split('-');
    return `${d}/${m}/${y}`;
}

// CONFIGURACI√ìN DE FIREBASE
const firebaseConfig = {
apiKey: "AIzaSyBvqlV6yj-V1GMkTiOL2pDBg0VHFanJRa4",
authDomain: "calculadora-penal-dffb3.firebaseapp.com",
projectId: "calculadora-penal-dffb3",
storageBucket: "calculadora-penal-dffb3.firebasestorage.app",
messagingSenderId: "293337226624",
appId: "1:293337226624:web:7b5acb2356faa8842f3555"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// --- INICIO DE NUEVA L√ìGICA DE SINCRONIZACI√ìN DE INTERRUPTORES ---
function actualizarEstadoSync(estado) {
    localStorage.setItem('preferenciaSync', estado);
    const checkGestion = document.getElementById('syncToggleGestion');
    const checkPrincipal = document.getElementById('syncToggle');
    if (checkGestion) checkGestion.checked = estado;
    if (checkPrincipal) checkPrincipal.checked = estado;
    console.log("Sincronizaci√≥n de nube: " + (estado ? "ACTIVADA" : "DESACTIVADA"));
}

function cargarPreferenciaSync() {
    const preference = localStorage.getItem('preferenciaSync');
    const estadoInicial = (preference === null) ? true : (preference === 'true');
    actualizarEstadoSync(estadoInicial);
}
// --- FIN DE NUEVA L√ìGICA DE SINCRONIZACI√ìN DE INTERRUPTORES ---

// HELPER DE CIFRADO AUTOM√ÅTICO E2EE
const encryptionHelper = {
getSecretKey: (uid) => CryptoJS.SHA256(uid).toString(),
encrypt: (data, uid) => {
if (!data || data.toString().trim() === "") return "";
return CryptoJS.AES.encrypt(data.toString(), encryptionHelper.getSecretKey(uid)).toString();
},
decrypt: (ciphertext, uid) => {
if (!ciphertext || ciphertext.toString().trim() === "") return "";
try {
const bytes = CryptoJS.AES.decrypt(ciphertext.toString(), encryptionHelper.getSecretKey(uid));
return bytes.toString(CryptoJS.enc.Utf8);
} catch (e) { return "Error de lectura"; }
}
};

// --- NUEVA L√ìGICA DE GESTI√ìN DE EXPEDIENTES ---
let eventosTemporales = [];

// --- FUNCI√ìN DE LIMPIEZA UNIFICADA (Resetea Gesti√≥n y C√≥mputo) ---
function nuevoExpediente() {
    // 1. Limpiar Identificadores
    document.getElementById('casoActivoId').value = ""; 
    document.getElementById('idCasoGestion').value = "";

    // 2. Limpiar todos los inputs, selects y textareas de ambas secciones
    const contenedores = ['#gestion', '#principal'];
    contenedores.forEach(selector => {
        const elementoRaiz = document.querySelector(selector);
        if (elementoRaiz) {
            elementoRaiz.querySelectorAll('input, select, textarea').forEach(i => {
                if (i.tagName === 'SELECT') {
                    i.selectedIndex = 0;
                } else {
                    i.value = "";
                }
            });
        }
    });

    // 3. Limpiar elementos din√°micos espec√≠ficos de C√≥mputo
    document.getElementById('listaRedenciones').innerHTML = "";
    document.getElementById('contenedorPeriodos').innerHTML = "";
    document.getElementById('resultado').style.display = 'none';
    
    // Resetear fecha de corte a hoy por defecto
    const hoy = new Date().toISOString().split('T')[0];
    if (document.getElementById('fFechaCorte')) {
        document.getElementById('fFechaCorte').value = hoy;
    }

    // 4. Limpiar elementos din√°micos espec√≠ficos de Gesti√≥n
    eventosTemporales = [];
    renderizarEventos();
    document.getElementById('gDivDrogas').style.display = 'none';

    // 5. Resetear estados visuales (como la acumulaci√≥n de penas)
    toggleAcumulacion(); 

    console.log("Sistema reseteado: Ambas pesta√±as han sido limpiadas.");
}

// Para mantener compatibilidad con los botones que ya tienes creados:
function nuevoExpedienteGestion() {
    nuevoExpediente();
}

// FUNCI√ìN DE AGREGAR EVENTO ADAPTADA A LOS NUEVOS CAMPOS (Fecha/Hora y Recordatorio)
function agregarEvento() {
    const fecha = document.getElementById('evFecha').value;
    const recordatorio = document.getElementById('evRecordatorio').value;
    const minuta = document.getElementById('evMinuta').value;
    
    if(!fecha || !minuta) return alert("Complete al menos la fecha del evento y la descripci√≥n.");
    
    // Formateamos para que se vea limpio (quitando la T de datetime-local)
    const recordatorioFormateado = recordatorio ? recordatorio.replace('T', ' ') : "Sin recordatorio";
    
    eventosTemporales.push({ 
        fecha: fecha.replace('T', ' '), 
        recordatorio: recordatorioFormateado, 
        minuta 
    });
    
    // Ordenar por fecha (el m√°s reciente o pr√≥ximo primero)
    eventosTemporales.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
    renderizarEventos();
    
    // Limpiar campos despu√©s de agregar
    document.getElementById('evMinuta').value = "";
    document.getElementById('evFecha').value = "";
    document.getElementById('evRecordatorio').value = "";
}

function renderizarEventos() {
    const container = document.getElementById('scrollEventos');
    container.innerHTML = "";
    if(eventosTemporales.length === 0) {
        container.innerHTML = "No hay eventos registrados.";
        return;
    }

    eventosTemporales.forEach((ev, index) => {
        const item = document.createElement('div');
        item.className = "beneficio-item";
        item.style.padding = "10px";
        
        // Capturamos los datos actuales para el recordatorio
        const nombreCliente = document.getElementById('gNombre').value || "Cliente";
        const expediente = document.getElementById('gExpJud').value || "Sin Exp.";

        const fEvento = new Date(ev.fecha);
        const fFormat = fEvento.toLocaleDateString('es-ES') + ' ' + fEvento.toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'});

        item.innerHTML = `
        <div style="display:flex; justify-content: space-between; align-items:center;">
            <div style="flex-grow:1;">
                <b>üìÖ Evento:</b> ${fFormat}<br>
                <b>üîî Aviso:</b> ${ev.recordatorio}<br>
                <b>üìù:</b> ${ev.minuta}
            </div>
            <div style="display:flex; flex-direction:column; gap:5px; margin-left:10px;">
                <button onclick="enviarAGoogleCalendar('${nombreCliente}', '${ev.minuta}', '${ev.recordatorio}', '${expediente}')" 
                        style="background:#1a73e8; color:white; border:none; padding:8px; border-radius:5px; cursor:pointer; font-size:0.75em; font-weight:bold;">
                    üóìÔ∏è SINCRONIZAR
                </button>
                <button onclick="eventosTemporales.splice(${index},1); renderizarEventos();" 
                        style="background:#fee2e2; border:none; cursor:pointer; padding:5px; border-radius:5px; color:#dc2626; font-size:0.75em;">Eliminar</button>
            </div>
        </div>`;
        container.appendChild(item);
    });
}
function listarCasosGestion() {
    const busq = document.getElementById('busquedaGestion').value.toLowerCase();
    const div = document.getElementById('listaCasosGestion');
    if (!div) return; 
    
    div.innerHTML = "";

    casos.filter(c => 
        (c.nombre || "").toLowerCase().includes(busq) || 
        (c.cedula || "").includes(busq)
    ).forEach(c => {
        const idActual = c.id || c.tempId;
        const card = document.createElement('div');
        card.className = "case-card";
        
        card.style.display = "flex";
        card.style.justifyContent = "space-between";
        card.style.alignItems = "center";
        card.style.padding = "10px";

        card.innerHTML = `
            <div style="flex-grow:1;">
                <b>${c.nombre}</b><br>
                <small style="color:#666;">V-${c.cedula}</small>
            </div>
            <div style="display: flex; gap: 8px; align-items: center;">
                <button onclick="cargarCaso('${idActual}')" 
                        style="background:#1a73e8; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:0.85em;">
                    Abrir
                </button>
                <button class="btn-delete" onclick="eliminarCaso('${idActual}')">
                    üóëÔ∏è
                </button>
            </div>
        `;
        div.appendChild(card);
    });
}

function cargarCasoEnGestion(id) {
    cargarCaso(id);
}

// LOGICA DE ACCESO
function loginFirebase() {
const email = document.getElementById('f_email').value;
const pass = document.getElementById('f_pass').value;
const errorDom = document.getElementById('f_error');

if(!email || !pass) return errorDom.innerText = "Complete todos los campos.";

auth.signInWithEmailAndPassword(email, pass).catch(e => {
if(e.code === 'auth/user-not-found') {
errorDom.innerText = "El usuario no existe. Use 'Crear Cuenta'.";
} else if(e.code === 'auth/wrong-password') {
errorDom.innerText = "Contrase√±a incorrecta.";
} else {
errorDom.innerText = "Error: Acceso denegado.";
}
});
}

function logoutFirebase() {
if(confirm("¬øSeguro que desea cerrar sesi√≥n?")) {
auth.signOut().then(() => {
localStorage.removeItem('terminosAceptados'); 
window.location.reload();
});
}
}

function olvideClave() {
const email = document.getElementById('f_email').value;
if(!email) return alert("Por favor, escriba su correo electr√≥nico arriba.");
auth.sendPasswordResetEmail(email)
.then(() => alert("Se ha enviado un enlace de recuperaci√≥n a su correo."))
.catch(e => alert("Error: Aseg√∫rese de que el correo sea v√°lido."));
}

function registroFirebase() {
    const email = document.getElementById('f_email').value;
    const pass = document.getElementById('f_pass').value;
    const referidoPor = document.getElementById('f_referido').value;
    const errorDom = document.getElementById('f_error');

    if(!email || !pass) return errorDom.innerText = "Ingrese correo y clave.";
    if(pass.length < 6) return errorDom.innerText = "M√≠nimo 6 caracteres.";

    auth.createUserWithEmailAndPassword(email, pass)
    .then(async (userCredential) => {
        const uid = userCredential.user.uid;
        await db.collection('usuarios').doc(uid).set({
            email: email,
            vencimiento: new Date(Date.now() + (15 * 24 * 60 * 60 * 1000)).toISOString(),
            rol: 'prueba',
            referidoPor: referidoPor || "Ninguno",
            fechaRegistro: new Date().toISOString()
        });
        console.log("Usuario registrado con referido");
    })
    .catch(e => {
        if(e.code === 'auth/email-already-in-use') {
            errorDom.innerText = "El correo ya est√° registrado.";
        } else {
            errorDom.innerText = "Error al registrar.";
        }
    });
}

function aceptarTerminos() {
localStorage.setItem('terminosAceptados', 'true');
document.getElementById('modalTerminos').style.display = 'none';
}

auth.onAuthStateChanged(user => {
if(user) {
document.getElementById('auth-overlay').style.display = 'none';
document.getElementById('status-bar').style.display = 'flex';
document.getElementById('user-display').innerText = user.email.split('@')[0].toUpperCase();
if (!localStorage.getItem('terminosAceptados')) {
document.getElementById('modalTerminos').style.display = 'block';
}
obtenerSuscripcion(user.uid);
cargarPreferenciaSync();
sincronizarConNube();
} else {
document.getElementById('auth-overlay').style.display = 'flex';
document.getElementById('status-bar').style.none;
}
});

// Variable global para controlar el acceso
let suscripcionVencida = false;

async function obtenerSuscripcion(uid) {
try {
const docRef = db.collection('usuarios').doc(uid);
const doc = await docRef.get();
let venc;
if (doc.exists && doc.data().vencimiento) {
venc = new Date(doc.data().vencimiento);
} else {
const user = auth.currentUser;
const fechaCreacion = new Date(user.metadata.creationTime);
venc = new Date(fechaCreacion.getTime() + (10 * 24 * 60 * 60 * 1000));
await docRef.set({
email: user.email,
vencimiento: venc.toISOString(),
rol: 'prueba',
fechaRegistro: new Date().toISOString()
}, { merge: true });
}
const hoy = new Date();
const diff = Math.ceil((venc - hoy) / (1000 * 60 * 60 * 24));

if (diff <= 0) {
document.getElementById('days-display').innerText = "Suscripci√≥n Vencida";
suscripcionVencida = true; // Marcamos como vencida
} else {
document.getElementById('days-display').innerText = "Prueba: " + diff + " d√≠as restantes";
suscripcionVencida = false;
document.getElementById('modalVencimiento').style.display = 'none';
}
} catch (e) { console.error(e); }
}

// Funci√≥n auxiliar para validar antes de ejecutar tareas premium
function validarAccesoPremium() {
if (suscripcionVencida) {
document.getElementById('modalVencimiento').style.display = 'block';
return false;
}
return true;
}

function abrirWhatsAppSuscripcion() {
const email = auth.currentUser ? auth.currentUser.email : "Usuario no identificado";
const mensaje = encodeURIComponent(`Hola Dr. Charles Reyes, mi correo es ${email} y deseo conocer los planes de suscripci√≥n para Iuris Penal.`);
window.open(`https://wa.me/584247640846?text=${mensaje}`, '_blank');
}

let casos = JSON.parse(localStorage.getItem('casosIuris')) || [];
const DIAS_A√ëO = 360;
const DIAS_MES = 30;

function openTab(evt, tabName) {
let i, tabcontent, tablinks;
tabcontent = document.getElementsByClassName("tab-content");
for (i = 0; i < tabcontent.length; i++) tabcontent[i].style.display = "none";
tablinks = document.getElementsByClassName("tab-button");
for (i = 0; i < tablinks.length; i++) tablinks[i].className = tablinks[i].className.replace(" active", "");
document.getElementById(tabName).style.display = "block";
evt.currentTarget.className += " active";
}

function exportarDB() {
if (casos.length === 0) return alert("No hay expedientes.");
const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(casos));
const dl = document.createElement('a'); dl.setAttribute("href", dataStr);
dl.setAttribute("download", "C√≥mputos_Iuris_" + new Date().toLocaleDateString() + ".json");
dl.click();
}

function importarDB(event) {
const reader = new FileReader();
reader.onload = (e) => {
try {
const importados = JSON.parse(e.target.result);
if (confirm(`¬øImportar ${importados.length} expedientes?`)) {
casos = importados; localStorage.setItem('casosIuris', JSON.stringify(casos));
listarCasos(); listarCasosGestion(); alert("√âxito.");
}
} catch (err) { alert("Archivo inv√°lido."); }
};
reader.readAsText(event.target.files[0]);
}

// --- FUNCI√ìN DE GUARDADO UNIFICADA ---
// --- FUNCI√ìN DE GUARDADO MEJORADA ---
async function guardarCasoCompleto() {
    if (!validarAccesoPremium()) return;
    const userId = auth.currentUser.uid;
    
    // 1. Identificar o generar ID
    let idActivo = document.getElementById('casoActivoId').value || document.getElementById('idCasoGestion').value;
    if (!idActivo) idActivo = "local_" + Date.now();

    // 2. Captura de datos unificada
    const nombre = document.getElementById('gNombre').value || document.getElementById('pNombre').value;
    const cedula = document.getElementById('gCedula').value || document.getElementById('pCedula').value;
    
    if(!nombre || !cedula) return alert("Nombre y C√©dula son obligatorios.");

    // Objeto con la informaci√≥n recolectada
    const datosCasoBase = {
        id: idActivo,
        nombre: nombre,
        cedula: cedula,
        fase: document.getElementById('gFase').value,
        expJud: document.getElementById('gExpJud').value,
        expFis: document.getElementById('gExpFis').value,
        expCar: document.getElementById('gExpCar').value,
        numFis: document.getElementById('gNumFis').value,
        tribunal: document.getElementById('gTribunal').value,
        lugar: document.getElementById('gLugar').value,
        delito: document.getElementById('gDelito').value,
        fIni: document.getElementById('gFechaIni').value,
        familiar: document.getElementById('gFamiliar').value,
        tel: document.getElementById('gTel').value,
        esDrogas: document.getElementById('gEsDrogas').value,
        pTipoDroga: document.getElementById('gTipoDroga').value,
        pCantDroga: document.getElementById('gCantDroga').value,
        // Datos de c√≥mputo
        cAno: document.getElementById('cAno').value,
        cMes: document.getElementById('cMes').value,
        cDia: document.getElementById('cDia').value,
        esAcum: document.getElementById('esAcum').value,
        fDetencionActual: document.getElementById('fDetencionActual').value,
        eventos: eventosTemporales,
        fechaMod: Date.now()
    };

    // 3. ACTUALIZACI√ìN DE LA VARIABLE GLOBAL Y LOCALSTORAGE
    // Buscamos si ya existe para reemplazarlo o a√±adirlo
    const index = casos.findIndex(c => c.id === idActivo);
    if (index !== -1) {
        casos[index] = datosCasoBase;
    } else {
        casos.push(datosCasoBase);
    }

    // Guardamos el array global actualizado en el almacenamiento local
    localStorage.setItem('casosIuris', JSON.stringify(casos));

    // 4. GUARDADO EN LA NUBE (Opcional seg√∫n interruptor)
    const syncActiva = document.getElementById('syncToggle').checked;
    if (syncActiva) {
        try {
            const datosCifrados = {
                ...datosCasoBase,
                nombre: encryptionHelper.encrypt(nombre, userId),
                cedula: encryptionHelper.encrypt(cedula, userId)
                // Aqu√≠ podr√≠as cifrar m√°s campos si lo deseas
            };

            if(idActivo.startsWith("local_")) {
                const docRef = await db.collection('usuarios').doc(userId).collection('expedientes').add(datosCifrados);
                // Actualizamos el ID real de Firebase en nuestro objeto local
                datosCasoBase.id = docRef.id;
                actualizarIdEnPantalla(docRef.id);
                localStorage.setItem('casosIuris', JSON.stringify(casos));
            } else {
                await db.collection('usuarios').doc(userId).collection('expedientes').doc(idActivo).set(datosCifrados);
            }
            alert("Sincronizado con la nube ‚úÖ");
        } catch(e) {
            console.error(e);
            alert("Error de conexi√≥n. Guardado solo en este dispositivo.");
        }
    } else {
        alert("Guardado localmente con √©xito üíæ");
    }

    // 5. Refrescar las listas visuales
    listarCasos();
    listarCasosGestion();
}


function actualizarIdEnPantalla(nuevoId) {
    document.getElementById('casoActivoId').value = nuevoId;
    document.getElementById('idCasoGestion').value = nuevoId;
}



async function sincronizarConNube() {
    const userId = auth.currentUser.uid;
    const estaSincronizado = document.getElementById('syncToggle').checked;

    // Si el usuario NO quiere sincronizar, solo cargamos lo local
    if (!estaSincronizado) {
        casos = JSON.parse(localStorage.getItem('casosIuris')) || [];
        listarCasos();
        listarCasosGestion();
        return;
    }

    try {
        const snap = await db.collection('usuarios').doc(userId).collection('expedientes').get();
        let casosLocales = JSON.parse(localStorage.getItem('casosIuris')) || [];
        const mapCasos = new Map();

        // 1. Cargamos primero lo local al mapa
        casosLocales.forEach(c => mapCasos.set(c.id, c));

        // 2. Procesamos lo de la nube
        snap.forEach(doc => {
            const dataNube = doc.data();
            const idNube = doc.id;
            
            // Desencriptamos datos sensibles
            const casoNubeDecodificado = {
                ...dataNube,
                id: idNube,
                nombre: encryptionHelper.decrypt(dataNube.nombre, userId),
                cedula: encryptionHelper.decrypt(dataNube.cedula, userId),
                origen: 'nube'
            };

            if (mapCasos.has(idNube)) {
                // SI EL CASO EXISTE EN AMBOS: Comparamos fecha de modificaci√≥n
                const casoLocal = mapCasos.get(idNube);
                if ((dataNube.fechaMod || 0) > (casoLocal.fechaMod || 0)) {
                    mapCasos.set(idNube, casoNubeDecodificado); // Gana la nube por ser m√°s reciente
                }
            } else {
                // SI SOLO EXISTE EN LA NUBE: Lo agregamos
                mapCasos.set(idNube, casoNubeDecodificado);
            }
        });

        // 3. Guardamos la uni√≥n final
        casos = Array.from(mapCasos.values());
        localStorage.setItem('casosIuris', JSON.stringify(casos));
        
        listarCasos();
        listarCasosGestion();
        console.log("Sincronizaci√≥n inteligente completada.");
    } catch(e) {
        console.error("Error en sincronizaci√≥n, operando en modo local:", e);
    }
}




function listarCasos() {
    const b = document.getElementById('busqueda').value.toLowerCase();
    const div = document.getElementById('listaCasos'); 
    if (!div) return;
    
    div.innerHTML = "";

    const casosFiltrados = casos.filter(c => {
        const coincideBusqueda = (c.nombre || "").toLowerCase().includes(b) || (c.cedula || "").includes(b);
        const esEjecucion = (c.fase === "Ejecuci√≥n");
        return coincideBusqueda && esEjecucion;
    });

    casosFiltrados.sort((a, b) => b.fechaMod - a.fechaMod).forEach(c => {
        const card = document.createElement('div'); 
        card.className = "case-card";
        card.innerHTML = `
            <span><b>${c.nombre}</b><br><small>${c.cedula}</small></span>
            <div>
                <button onclick="cargarCaso('${c.id}')" style="background:#1a73e8; color:white; border:none; padding:5px 10px; border-radius:5px;">Abrir</button>
                <button onclick="eliminarCaso('${c.id}')" class="btn-delete">üóëÔ∏è</button>
            </div>`;
        div.appendChild(card);
    });

    if (casosFiltrados.length === 0 && b === "") {
        div.innerHTML = "<p style='text-align:center; color:#666; font-size:0.8em; padding:10px;'>No hay privados en Fase de Ejecuci√≥n registrados.</p>";
    }
}

// --- FUNCI√ìN DE CARGA MEJORADA ---
function cargarCaso(id) {
    const c = casos.find(i => i.id == id); 
    if(!c) return;

    // Sincronizar IDs activos en ambos campos ocultos
    document.getElementById('casoActivoId').value = c.id; 
    document.getElementById('idCasoGestion').value = c.id;

    // --- CARGA EN PESTA√ëA GESTI√ìN ---
    document.getElementById('gNombre').value = c.nombre || "";
    document.getElementById('gCedula').value = c.cedula || "";
    document.getElementById('gExpJud').value = c.expJud || "";
    document.getElementById('gExpFis').value = c.expFis || "";
    document.getElementById('gExpCar').value = c.expCar || "";
    document.getElementById('gNumFis').value = c.numFis || "";
    document.getElementById('gTribunal').value = c.tribunal || "";
    document.getElementById('gLugar').value = c.lugar || "";
    document.getElementById('gFase').value = c.fase || "Preparatoria";
    document.getElementById('gDelito').value = c.delito || "";
    document.getElementById('gFechaIni').value = c.fIni || ""; 
    document.getElementById('gFamiliar').value = c.familiar || "";
    document.getElementById('gTel').value = c.tel || "";
    
    // Cargar Drogas
    document.getElementById('gEsDrogas').value = c.esDrogas || 'no';
    document.getElementById('gTipoDroga').value = c.pTipoDroga || '';
    document.getElementById('gCantDroga').value = c.pCantDroga || '';
    document.getElementById('gDivDrogas').style.display = (c.esDrogas === 'si' ? 'block' : 'none');

    // Cargar Eventos/Bit√°cora
    eventosTemporales = c.eventos || [];
    renderizarEventos();

    // --- CARGA EN PESTA√ëA C√ìMPUTO ---
    document.getElementById('pNombre').value = c.nombre || ""; 
    document.getElementById('pCedula').value = c.cedula || "";
    document.getElementById('pExpJud').value = c.expJud || ""; 
    document.getElementById('pExpCar').value = c.expCar || "";
    document.getElementById('pDelito').value = c.delito || ""; 
    document.getElementById('pLugar').value = c.lugar || "";
    
    // C√≥mputo espec√≠fico
    document.getElementById('cAno').value = c.cAno || ""; 
    document.getElementById('cMes').value = c.cMes || ""; 
    document.getElementById('cDia').value = c.cDia || "";
    document.getElementById('fDetencionUnica').value = c.fIni || ""; // Sincroniza fecha
    document.getElementById('esAcum').value = c.esAcum || "no"; 
    document.getElementById('fDetencionActual').value = c.fDetencionActual || "";

    // Limpiar y cargar Redenciones
    document.getElementById('listaRedenciones').innerHTML = '';
    if(c.redenciones) c.redenciones.forEach(r => agregarFilaRedencion(r.a, r.m, r.d));

    // Limpiar y cargar Periodos Previos
    document.getElementById('contenedorPeriodos').innerHTML = "";
    if(c.periodosPrevios) {
        c.periodosPrevios.forEach(p => {
            const div = document.createElement('div');
            div.className = 'modulo';
            div.style.background = "#f0f7ff";
            div.innerHTML = `<label>Desde:</label><input type="date" class="pInicio" value="${p.inicio}"><label>Hasta:</label><input type="date" class="pFin" value="${p.fin}">`;
            document.getElementById('contenedorPeriodos').appendChild(div);
        });
    }
    
    // Actualizar visibilidad de secciones (Drogas, Acumulaci√≥n, etc.)
    toggleAcumulacion();
    
    // Ocultar resultados previos de la otra pesta√±a si existen
    document.getElementById('resultado').style.display = 'none';

    console.log("Expediente cargado y sincronizado en todas las pesta√±as.");
}

function agregarFilaRedencion(a, m, d) {
const div = document.createElement('div'); div.className = 'grid-red';
div.innerHTML = `<input type="number" class="rAno" value="${a}" placeholder="A"><input type="number" class="rMes" value="${m}" placeholder="M"><input type="number" class="rDia" value="${d}" placeholder="D">
<button class="btn-delete" onclick="this.parentElement.remove()">üóëÔ∏è</button>`;
document.getElementById('listaRedenciones').appendChild(div);
}

function obtenerDiasCalendarioReal(fechaInicio, fechaFin) {
    let f1 = new Date(fechaInicio + "T12:00:00");
    let f2 = new Date(fechaFin + "T12:00:00");
    if (isNaN(f1.getTime()) || isNaN(f2.getTime())) return 0;
    if (f1 > f2) return 0;
    let anio1 = f1.getFullYear();
    let mes1 = f1.getMonth();
    let dia1 = f1.getDate();
    let anio2 = f2.getFullYear();
    let mes2 = f2.getMonth();
    let dia2 = f2.getDate();
    if (dia1 > 30) dia1 = 30;
    if (dia2 > 30) dia2 = 30;
    let d = dia2 - dia1;
    let m = mes2 - mes1;
    let a = anio2 - anio1;
    if (d < 0) { m--; d += 30; }
    if (m < 0) { a--; m += 12; }
    return (a * 360) + (m * 30) + d;
}

function procesarRedencionAutomatica() {
const f1 = new Date(document.getElementById('redInicio').value);
const f2 = new Date(document.getElementById('redFin').value);
const ds = parseInt(document.getElementById('redDiasSemana').value) || 5;
const hd = parseInt(document.getElementById('redHorasDia').value) || 8;
if (isNaN(f1.getTime()) || isNaN(f2.getTime())) return alert("Fechas inv√°lidas");
const diasCronologicos = Math.ceil(Math.abs(f2 - f1) / 86400000);
const totalHoras = (diasCronologicos / 7) * ds * hd;
const diasTrabajados = Math.floor(totalHoras / 8);
const diasRedimidosTotal = Math.floor(diasTrabajados / 2);
if (diasRedimidosTotal >= 0) {
const a√±os = Math.floor(diasRedimidosTotal / 360);
const meses = Math.floor((diasRedimidosTotal % 360) / 30);
const dias = Math.floor((diasRedimidosTotal % 360) % 30);
agregarFilaRedencion(a√±os, meses, dias);
document.getElementById('resultadoMiniRed').innerHTML = `
<div class="info-red">
<b>D√≠as Cronol√≥gicos:</b> ${diasCronologicos}<br><hr>
<b>D√≠as Laborados:</b> ${diasTrabajados}<br><b>Lapso Laborado:</b> ${desglosar(diasTrabajados)}<br><hr>
<b>D√≠as Redimidos (TOTAL):</b> ${diasRedimidosTotal}<br>
<b style="color:#1a73e8;">Lapso a Redimir:</b> ${a√±os}a, ${meses}m, ${dias}d
</div>`;
}
}

function desglosar(t) { 
let a = Math.floor(t / 360); let m = Math.floor((t % 360) / 30); let d = Math.floor((t % 360) % 30);
let res = [];
if (a > 0) res.push(a + (a == 1 ? " a√±o" : " a√±os"));
if (m > 0) res.push(m + (m == 1 ? " mes" : " meses"));
if (d > 0) res.push(d + (d == 1 ? " d√≠a" : " d√≠as"));
return res.length > 0 ? res.join(", ") : "0 d√≠as";
}

function desglosarBreve(totalDias) { 
if (totalDias <= 0) return "0d";
let a = Math.floor(totalDias / 360); let restoDias = totalDias % 360;
let m = Math.floor(restoDias / 30); let d = Math.floor(restoDias % 30);
let resultado = "";
if (a > 0) resultado += a + "a ";
if (m > 0) resultado += m + "m ";
if (d > 0 || resultado === "") resultado += Math.round(d) + "d";
return resultado.trim();
}

function exportarAPDF() {
    const plantilla = document.getElementById('plantilla-pdf');
    const resumenHTML = document.getElementById('resResumen').innerHTML;
    const beneficiosHTML = document.getElementById('resBeneficios').innerHTML;

    if (!resumenHTML || resumenHTML.trim() === "") {
        alert("Primero debe realizar el c√°lculo de la pena para generar un informe.");
        return;
    }

    document.getElementById('pdf-nombre').innerText = document.getElementById('pNombre').value || "No especificado";
    document.getElementById('pdf-cedula').innerText = document.getElementById('pCedula').value || "No especificado";
    document.getElementById('pdf-exp').innerText = document.getElementById('pExpJud').value || "No especificado";
    document.getElementById('pdf-delito').innerText = document.getElementById('pDelito').value || "No especificado";

    const esDrogas = document.getElementById('gEsDrogas').value;
    if(esDrogas === 'si') {
        document.getElementById('pdf-fila-drogas').style.display = 'table-row';
        document.getElementById('pdf-drogas').innerText = 
            (document.getElementById('gTipoDroga').value || "N/A") + " (" + (document.getElementById('gCantDroga').value || "N/A") + ")";
    } else {
        document.getElementById('pdf-fila-drogas').style.display = 'none';
    }

    document.getElementById('pdf-resumen-calculo').innerHTML = resumenHTML;
    document.getElementById('pdf-beneficios').innerHTML = beneficiosHTML;

    const opciones = {
        margin: [15, 15, 15, 15],
        filename: `Informe_Penal_${document.getElementById('pNombre').value || 'Sin_Nombre'}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, logging: false, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    plantilla.style.display = 'block';
    
    html2pdf().set(opciones).from(plantilla).save().then(() => {
        plantilla.style.display = 'none';
    }).catch(err => {
        console.error("Error al generar PDF:", err);
        plantilla.style.display = 'none';
    });
}

function toggleAcumulacion() { const esA = document.getElementById('esAcum').value === 'si'; document.getElementById('seccionUnica').style.display = esA ? 'none' : 'block'; document.getElementById('seccionAcumulada').style.display = esA ? 'block' : 'none'; }
function toggleSubModulo() { const sm = document.getElementById('subModuloRedencion'); sm.style.display = sm.style.display === 'block' ? 'none' : 'block'; }
function agregarPeriodo() {
    const div = document.createElement('div');
    div.className = 'modulo';
    div.style.background = "#f0f7ff";
    div.style.position = "relative";
    div.style.marginBottom = "10px";
    div.innerHTML = `
        <div style="display: flex; justify-content:Âª∫ËÆæ; align-items: center; gap: 10px;">
            <div style="flex-grow: 1;">
                <label>Desde:</label>
                <input type="date" class="pInicio">
                <label>Hasta:</label>
                <input type="date" class="pFin">
            </div>
            <button class="btn-delete" 
                    onclick="this.parentElement.parentElement.remove()" 
                    style="height: fit-content; margin-top: 20px;">
                üóëÔ∏è
            </button>
        </div>
    `;
    
    document.getElementById('contenedorPeriodos').appendChild(div);
}

function abrirWhatsApp() { window.open(`https://wa.me/584247640846`, '_blank'); }

function calcularTodo() {
    const fechaCorteInput = document.getElementById('fFechaCorte').value;
    const hoyStr = fechaCorteInput || new Date().toISOString().split('T')[0];
    
    let df_total_dias = 0; 
    let desgloseHTML = '<div style="font-size: 0.85em; margin-top: 5px; border-top: 1px solid #ccc; padding-top: 5px;">';
    const esAcumulado = document.getElementById('esAcum').value === 'si';

    if (!esAcumulado) {
        const fDetStr = document.getElementById('fDetencionUnica').value;
        if (fDetStr) {
            const dias = obtenerDiasCalendarioReal(fDetStr, hoyStr);
            df_total_dias = dias;
            desgloseHTML += `<b>Detenci√≥n √∫nica:</b> ${formatFechaLatina(fDetStr)} al ${formatFechaLatina(hoyStr)} <br>¬ª Lapso: ${desglosar(dias)}<br>`;
        } else {
            alert("Por favor, ingrese la Fecha de Detenci√≥n.");
            return;
        }
    } else {
        const inis = document.getElementsByClassName('pInicio');
        const fins = document.getElementsByClassName('pFin');
        let contador = 1;

        for (let i = 0; i < inis.length; i++) {
            if (inis[i].value && fins[i].value) {
                const diasLapso = obtenerDiasCalendarioReal(inis[i].value, fins[i].value);
                df_total_dias += diasLapso;
                desgloseHTML += `<b>${contador}¬™ Detenci√≥n:</b> ${formatFechaLatina(inis[i].value)} al ${formatFechaLatina(fins[i].value)} <br>¬ª Lapso: ${desglosar(diasLapso)}<br>`;
                contador++;
            }
        }
        
        const fActStr = document.getElementById('fDetencionActual').value;
        if (fActStr) {
            const diasActual = obtenerDiasCalendarioReal(fActStr, hoyStr);
            df_total_dias += diasActual;
            desgloseHTML += `<b>Detenci√≥n Actual:</b> ${formatFechaLatina(fActStr)} al ${formatFechaLatina(hoyStr)} <br>¬ª Lapso: ${desglosar(diasActual)}<br>`;
        } else {
            alert("En modo acumulado, debe ingresar la 'Detenci√≥n Actual (Desde)'.");
            return;
        }
    }
    desgloseHTML += '</div>';

    let dr = 0;
    const rAnos = document.getElementsByClassName('rAno'),
          rMeses = document.getElementsByClassName('rMes'),
          rDias = document.getElementsByClassName('rDia');
    
    for (let i = 0; i < rAnos.length; i++) {
        dr += (parseInt(rAnos[i].value) || 0) * 360 + 
              (parseInt(rMeses[i].value) || 0) * 30 + 
              (parseInt(rDias[i].value) || 0);
    }

    const pt = (parseInt(document.getElementById('cAno').value) || 0) * 360 + 
               (parseInt(document.getElementById('cMes').value) || 0) * 30 + 
               (parseInt(document.getElementById('cDia').value) || 0);

    if (pt === 0) {
        alert("La pena impuesta no puede ser 0.");
        return;
    }

    const tc = df_total_dias + dr;

    document.getElementById('resultado').style.display = 'block';
    document.getElementById('resTitulo').innerText = "C√≥mputo: " + (document.getElementById('pNombre').value || "S/N");
    document.getElementById('resResumen').innerHTML = `
        <div class="res-box">
            <b>F√≠sico Total:</b> ${desglosar(df_total_dias)}
            ${desgloseHTML}
        </div>
        <div class="res-box"><b>Redimido:</b> ${desglosar(dr)}</div>
        <div class="res-box" style="background:#e6ffed;"><b>TOTAL CUMPLIDO (F√≠sico + Redimido):</b> ${desglosar(tc)}</div>
    `;

    document.getElementById('resBeneficios').innerHTML = `
        ${crearFichaDoble("100% (Fin de Condena)", pt, df_total_dias, dr)}
        ${crearFichaDoble("1/2 (Destacamento de Trabajo)", pt * 0.5, df_total_dias, dr)}
        ${crearFichaDoble("2/3 (R√©gimen Abierto)", pt * (2 / 3), df_total_dias, dr)}
        ${crearFichaDoble("3/4 (Libertad Condicional)", pt * 0.75, df_total_dias, dr)}
    `;
}

function crearFichaDoble(titulo, metaDiasEnBase360, fisicoActual, redimidoActual) {
const fechaCorteInput = document.getElementById('fFechaCorte').value;
let fechaReferencia = fechaCorteInput ? new Date(fechaCorteInput + "T12:00:00") : new Date();
fechaReferencia.setHours(12, 0, 0, 0, 0); 
const opcionesFecha = { day: '2-digit', month: '2-digit', year: 'numeric' };
const diffFisicoTotalDias = Math.round(metaDiasEnBase360 - fisicoActual);
const diffMixtoTotalDias = Math.round(metaDiasEnBase360 - (fisicoActual + redimidoActual));
function proyectarFechaCalendario(diasFaltantes) {
let fechaResultante = new Date(fechaReferencia.getTime());
const signo = diasFaltantes >= 0 ? 1 : -1;
const diasAbs = Math.abs(diasFaltantes);
let anios = Math.floor(diasAbs / 360) * signo;
let meses = Math.floor((diasAbs % 360) / 30) * signo;
let dias = Math.floor(diasAbs % 30) * signo;
fechaResultante.setFullYear(fechaResultante.getFullYear() + anios);
fechaResultante.setMonth(fechaResultante.getMonth() + meses);
fechaResultante.setDate(fechaResultante.getDate() + dias);
return fechaResultante;
}
const fechaFisico = proyectarFechaCalendario(diffFisicoTotalDias);
const fechaMixto = proyectarFechaCalendario(diffMixtoTotalDias);
const diasFisicoTexto = diffFisicoTotalDias > 0 ? diffFisicoTotalDias : 0;
const diasMixtoTexto = diffMixtoTotalDias > 0 ? diffMixtoTotalDias : 0;
return `
<div class="beneficio-item">
<b style="color: #1a73e8; font-size: 1.1em;">${titulo}</b><hr style="border: 0; border-top: 1px solid #eee;">
<div style="margin-bottom: 10px;"><b style="color: #555; font-size: 0.9em;">üîπ Escenario: Solo tiempo f√≠sico</b><br>
<b>Tiempo faltante:</b> ${desglosarBreve(diasFisicoTexto)}<br>
<b>${diffFisicoTotalDias <= 0 ? '‚úÖ Cumplido el:' : 'üìÖ Fecha de cumplimiento:'}</b> 
<span class="${diffFisicoTotalDias <= 0 ? 'txt-cumplido' : 'txt-destaque'}">${fechaFisico.toLocaleDateString('es-ES', opcionesFecha)}</span></div>
<div><b style="color: #555; font-size: 0.9em;">üîπ Escenario: F√≠sico + Redenciones</b><br>
<b>Tiempo faltante:</b> ${desglosarBreve(diasMixtoTexto)}<br>
<b>${diffMixtoTotalDias <= 0 ? '‚úÖ Cumplido el:' : 'üìÖ Fecha de cumplimiento:'}</b> 
<span class="${diffMixtoTotalDias <= 0 ? 'txt-cumplido' : 'txt-destaque'}">${fechaMixto.toLocaleDateString('es-ES', opcionesFecha)}</span></div></div>`;
}

async function eliminarCaso(id) { 
    if(confirm(`¬øEst√° seguro de que desea eliminar este expediente de forma permanente?`)) { 
        try {
            // 1. Intentar eliminar de la nube si el usuario est√° autenticado y tiene ID de Firebase
            if (auth.currentUser && !id.startsWith("local_")) {
                await db.collection('usuarios')
                        .doc(auth.currentUser.uid)
                        .collection('expedientes')
                        .doc(id)
                        .delete();
                console.log("Eliminado de la nube ‚úÖ");
            }

            // 2. ELIMINACI√ìN LOCAL (Obligatoria para que desaparezca de la vista)
            // Filtramos el array global 'casos' para quitar el ID seleccionado
            casos = casos.filter(i => i.id !== id); 
            
            // 3. Actualizar el almacenamiento del navegador
            localStorage.setItem('casosIuris', JSON.stringify(casos));

            // 4. REFRESCAR AMBAS VISTAS
            listarCasos();        // Refresca pesta√±a de C√≥mputo
            listarCasosGestion(); // Refresca pesta√±a de Gesti√≥n
            
            alert("Expediente eliminado con √©xito.");

        } catch(e) {
            console.error("Error al eliminar:", e);
            alert("Hubo un problema al eliminar. Int√©ntelo de nuevo.");
        }
    } 
}


function validarYCalcular() { 
    if (!validarAccesoPremium()) return; // <--- Bloqueo
    if(!document.getElementById('cAno').value) return alert("Ingrese la pena."); 
    calcularTodo(); 
}

function calc71() {
const f1 = new Date(document.getElementById('calc71_inicio').value), f2 = new Date(document.getElementById('calc71_fin').value);
if(isNaN(f1)||isNaN(f2)) return;
let a=f2.getFullYear()-f1.getFullYear(), m=f2.getMonth()-f1.getMonth(), d=f2.getDate()-f1.getDate();
if(d<0){m--;d+=30}if(m<0){a--;m+=12}
document.getElementById('res71').innerText = `Lapso: ${a}a, ${m}m, ${d}d`;
}
function agregarFilaSuma() {
const div = document.createElement('div'); div.className = 'grid-3'; div.style.marginTop = '5px';
div.innerHTML = `<input type="number" class="sa" placeholder="A"><input type="number" class="sm" placeholder="M"><input type="number" class="sd" placeholder="D">`;
document.getElementById('listaLapsosSuma').appendChild(div);
}
function calc72() {
let a=0, m=0, d=0; document.querySelectorAll('.sa').forEach(i=>a+=parseInt(i.value||0)); document.querySelectorAll('.sm').forEach(i=>m+=parseInt(i.value||0)); document.querySelectorAll('.sd').forEach(i=>d+=parseInt(i.value||0));
m+=Math.floor(d/30); d=d%30; a+=Math.floor(m/12); m=m%12; document.getElementById('res72').innerText = `Total: ${a}a, ${m}m, ${d}d`;
}
function calc73() {
const a1 = parseInt(document.getElementById('r1a').value || 0), m1 = parseInt(document.getElementById('r1m').value || 0), d1 = parseInt(document.getElementById('r1d').value || 0);
const a2 = parseInt(document.getElementById('r2a').value || 0), m2 = parseInt(document.getElementById('r2m').value || 0), d2 = parseInt(document.getElementById('r2d').value || 0);
const totalDias1 = (a1 * 360) + (m1 * 30) + d1, totalDias2 = (a2 * 360) + (m2 * 30) + d2;
const diferencia = totalDias1 - totalDias2;
if (diferencia < 0) { document.getElementById('res73').innerText = "Resultado: El segundo lapso no puede ser mayor al primero."; document.getElementById('res73').style.color = "red"; }
else { document.getElementById('res73').innerText = "Resultado: " + desglosar(diferencia); document.getElementById('res73').style.color = "#856404"; }
}
function calc745(op) {
const dateInput = document.getElementById('fBase745').value;
if (!dateInput) return alert("Por favor, seleccione una fecha base.");
const partes = dateInput.split('-'); const anioBase = parseInt(partes[0], 10), mesBase = parseInt(partes[1], 10) - 1, diaBase = parseInt(partes[2], 10);
const a√±osAdd = parseInt(document.getElementById('la745').value || 0), mesesAdd = parseInt(document.getElementById('lm745').value || 0), d√≠asAdd = parseInt(document.getElementById('ld745').value || 0);
let f = new Date(anioBase, mesBase, diaBase);
if (op === 'sumar') { f.setFullYear(f.getFullYear() + a√±osAdd); f.setMonth(f.getMonth() + mesesAdd); f.setDate(f.getDate() + d√≠asAdd); }
else { f.setFullYear(f.getFullYear() - a√±osAdd); f.setMonth(f.getMonth() - mesesAdd); f.setDate(f.getDate() - d√≠asAdd); }
document.getElementById('res745').innerText = "Fecha Resultante: " + f.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
}
function calc76() {
const t = (parseInt(document.getElementById('fra').value||0)*360) + (parseInt(document.getElementById('frm').value||0)*30) + (parseInt(document.getElementById('frd').value||0));
const p = document.getElementById('fraccion').value.split('/'); 
document.getElementById('res76').innerText = "Producto: " + desglosarBreve(Math.floor((t*parseInt(p[0]))/parseInt(p[1])));
}

function generarReporteFiltrado() {
const fDelito = document.getElementById('repDelito').value.toLowerCase();
const fLugar = document.getElementById('repLugar').value.toLowerCase();
const fDesde = document.getElementById('repDesde').value, fHasta = document.getElementById('repHasta').value;
const filtrados = casos.filter(c => {
const cumpleDelito = !fDelito || (c.delito && c.delito.toLowerCase().includes(fDelito));
const cumpleLugar = !fLugar || (c.lugar && c.lugar.toLowerCase().includes(fLugar));
let cumpleFecha = true; if(fDesde || fHasta) { const fechaMod = new Date(c.fechaMod); if(fDesde && fechaMod < new Date(fDesde)) cumpleFecha = false; if(fHasta && fechaMod > new Date(fHasta)) cumpleFecha = false; }
return cumpleDelito && cumpleLugar && cumpleFecha;
});
if (filtrados.length === 0) return alert("No hay datos.");
let html = `<div style="padding:20px; font-family:sans-serif;"><h1 style="color:#1a73e8; text-align:center;">REPORTE DE EXPEDIENTES</h1><table border="1" style="width:100%; border-collapse:collapse; font-size:10px;"><thead><tr style="background:#f2f2f2;"><th>NOMBRE</th><th>C√âDULA</th><th>DELITO</th><th>LUGAR</th><th>CONDENA</th></tr></thead><tbody>${filtrados.map(c => `<tr><td>${c.nombre}</td><td>${c.cedula}</td><td>${c.delito || ''}</td><td>${c.lugar || ''}</td><td>${c.cAno||0}a ${c.cMes||0}m ${c.cDia||0}d</td></tr>`).join('')}</tbody></table></div>`;
const el = document.createElement('div'); el.innerHTML = html;
html2pdf().set({ margin: 10, filename: 'Reporte_Iuris.pdf', html2canvas: { scale: 2 } }).from(el).save();
}

function generarExcelFiltrado() {
const fDelito = document.getElementById('repDelito').value.toLowerCase();
const fLugar = document.getElementById('repLugar').value.toLowerCase();
const fDesde = document.getElementById('repDesde').value, fHasta = document.getElementById('repHasta').value;
const camposSeleccionados = Array.from(document.querySelectorAll('.col-excel:checked')).map(cb => cb.value);
if (camposSeleccionados.length === 0) return alert("Seleccione al menos un campo.");
const filtrados = casos.filter(c => {
const cumpleDelito = !fDelito || (c.delito && c.delito.toLowerCase().includes(fDelito));
const cumpleLugar = !fLugar || (c.lugar && c.lugar.toLowerCase().includes(fLugar));
let cumpleFecha = true; if(fDesde || fHasta) { const fechaMod = new Date(c.fechaMod); if(fDesde && fechaMod < new Date(fDesde)) cumpleFecha = false; if(fHasta && fechaMod > new Date(fHasta)) cumpleFecha = false; }
return cumpleDelito && cumpleLugar && cumpleFecha;
});
const cabeceras = { nombre: "NOMBRE", cedula: "C√âDULA", delito: "DELITO", lugar: "LUGAR", expJud: "EXP. JUDICIAL", expCar: "EXP. CARCELARIO" };
const dataExcel = filtrados.map(c => { let fila = {}; camposSeleccionados.forEach(campo => { fila[cabeceras[campo]] = c[campo] || ""; }); return fila; });
const ws = XLSX.utils.json_to_sheet(dataExcel); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Expedientes");
XLSX.writeFile(wb, `Reporte_Iuris_${new Date().toLocaleDateString()}.xlsx`);
}

document.getElementById('fFechaCorte').value = new Date().toISOString().split('T')[0];
listarCasos();
listarCasosGestion();

// 1. Modificamos el objeto de puntos magn√©ticos para incluir la fracci√≥n exacta
function actualizarLabelRebaja(valor) {
    let val = parseFloat(valor);
    const lblPorcentaje = document.getElementById('labelPorcentaje');
    const lblProporcion = document.getElementById('labelProporcion');
    const slider = document.getElementById('sliderRebaja');
    
    // Definimos la fracci√≥n matem√°tica real para el c√°lculo
    const puntosMagneticos = [
        { valor: 12.5, etiqueta: "1/8", fraccion: 1/8 },
        { valor: 16.66, etiqueta: "1/6", fraccion: 1/6 },
        { valor: 20, etiqueta: "1/5", fraccion: 1/5 },
        { valor: 25, etiqueta: "1/4", fraccion: 1/4 },
        { valor: 33.33, etiqueta: "1/3", fraccion: 1/3 },
        { valor: 50, etiqueta: "1/2", fraccion: 1/2 }
    ];

    let etiquetaActual = "Proporcional";
    let fraccionCalculo = val / 100; // Por defecto usa el porcentaje
    const umbral = 1.5; 

    puntosMagneticos.forEach(punto => {
        if (Math.abs(val - punto.valor) < umbral) {
            val = punto.valor;
            etiquetaActual = punto.etiqueta;
            fraccionCalculo = punto.fraccion; // <--- USAMOS LA FRACCI√ìN EXACTA
            slider.value = val;
        }
    });

    if (val === 0) {
        etiquetaActual = "0";
        fraccionCalculo = 0;
    }

    lblPorcentaje.innerText = val.toFixed(2);
    lblProporcion.innerText = etiquetaActual;
    
    // Guardamos la fracci√≥n exacta en un atributo del slider para usarla en el c√°lculo final
    slider.dataset.fraccionEfectiva = fraccionCalculo;
}

// 2. Ajustamos la funci√≥n de c√°lculo para usar esa fracci√≥n exacta
function calcularAdmision() {
    if (!validarAccesoPremium()) return;
    const totalHoras = aHoras(
        document.getElementById('adm_a').value,
        document.getElementById('adm_m').value,
        document.getElementById('adm_d').value,
        document.getElementById('adm_h').value
    );
    
    // Obtenemos la fracci√≥n exacta guardada o el valor del slider
    const slider = document.getElementById('sliderRebaja');
    const fraccion = slider.dataset.fraccionEfectiva ? parseFloat(slider.dataset.fraccionEfectiva) : (parseFloat(slider.value) / 100);
    
    if (totalHoras <= 0) return alert("Ingrese una pena.");
    
    // Ahora el c√°lculo es: 15 a√±os * (1/3) = 5 a√±os exactos (en horas)
    const rebaja = totalHoras * fraccion;
    const totalFinal = totalHoras - rebaja;

    document.getElementById('resAdmision').innerHTML = 
        `<small>Pena Original: ${desglosarHoras(totalHoras)}</small><br>` +
        `<small>Rebaja: -${desglosarHoras(rebaja)}</small><hr>` +
        `<div style="font-size: 1.2em; color: #27ae60; font-weight: bold;">Final: ${desglosarHoras(totalFinal)}</div>`;
}


function actualizarLabelIncremento(valor) {
    let val = parseFloat(valor);
    const lblPorcentaje = document.getElementById('labelPorcentajeInc');
    const lblProporcion = document.getElementById('labelProporcionInc');
    const slider = document.getElementById('sliderIncremento');

    const puntos = [
        { valor: 12.5, etiqueta: "1/8" },
        { valor: 16.66, etiqueta: "1/6" },
        { valor: 20, etiqueta: "1/5" },
        { valor: 25, etiqueta: "1/4" },
        { valor: 33.33, etiqueta: "1/3" },
        { valor: 50, etiqueta: "1/2" }
    ];

    let etiqueta = "Proporcional";
    const umbral = 1.5;

    puntos.forEach(p => {
        if (Math.abs(val - p.valor) < umbral) {
            val = p.valor;
            etiqueta = p.etiqueta;
            slider.value = val;
        }
    });

    if (val === 0) etiqueta = "0";

    if (lblPorcentaje) lblPorcentaje.innerText = val.toFixed(2);
    if (lblProporcion) lblProporcion.innerText = etiqueta;
}

function agregarFilaPenaReal() {
    const div = document.createElement('div');
    div.className = 'grid-4'; // Cambiado a grid-4
    div.style.marginBottom = '8px';
    div.innerHTML = `
        <input type="number" class="ra" placeholder="A√±os">
        <input type="number" class="rm" placeholder="Meses">
        <input type="number" class="rd" placeholder="D√≠as">
        <input type="number" class="rh" placeholder="Horas">
    `;
    document.getElementById('listaPenasReal').appendChild(div);
}

function calcularConcursoReal() {
    // Asumiendo que usas una funci√≥n aHoras para convertir todo a una unidad com√∫n
    const filas = document.querySelectorAll('#listaPenasReal .grid-4');
    let penasEnHoras = [];

    filas.forEach(fila => {
        const a = fila.querySelector('.ra').value || 0;
        const m = fila.querySelector('.rm').value || 0;
        const d = fila.querySelector('.rd').value || 0;
        const h = fila.querySelector('.rh').value || 0;
        
        // Convertir a horas (usando tu l√≥gica de aHoras)
        penasEnHoras.push(aHoras(a, m, d, h));
    });

    if (penasEnHoras.length === 0) return;

    // Ordenar de mayor a menor
    penasEnHoras.sort((a, b) => b - a);

    const penaMayor = penasEnHoras[0];
    const sumasRestantes = penasEnHoras.slice(1).reduce((acc, curr) => acc + curr, 0);
    
    // Regla: Pena mayor + mitad de la suma de las restantes
    const totalFinalHoras = penaMayor + (sumasRestantes / 2);

    document.getElementById('resReal').innerHTML = 
        `Pena Resultante: ${desglosarHoras(totalFinalHoras)}`; // Usando tu funci√≥n desglosarHoras
}


function exportarTodaLaDataExcel() {
    if (casos.length === 0) return alert("No hay expedientes para exportar.");
    const dataExcel = casos.map(c => {
        return {
            "NOMBRE": c.nombre || "",
            "C√âDULA": c.cedula || "",
            "EXP. JUDICIAL": c.expJud || "",
            "EXP. FISCAL√çA": c.expFis || "",
            "EXP. CARCELARIO": c.expCar || "",
            "FISCAL√çA N¬∫": c.numFis || "",
            "TRIBUNAL": c.tribunal || "",
            "LUGAR DE RECLUSI√ìN": c.lugar || "",
            "FASE PROCESAL": c.fase || "",
            "DELITO": c.delito || "",
            "FECHA DETENCI√ìN": formatFechaLatina(c.fIni),
            "FAMILIAR": c.familiar || "",
            "TEL√âFONO": c.tel || "",
            "FECHA REGISTRO": new Date(c.fechaMod).toLocaleDateString()
        };
    });
    const ws = XLSX.utils.json_to_sheet(dataExcel);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Base de Datos Iuris");
    XLSX.writeFile(wb, `Base_Datos_Completa_Iuris_${new Date().toISOString().split('T')[0]}.xlsx`);
}
async function copiarResultados(event) {
    const nombre = document.getElementById('pNombre')?.value || "N/A";
    const resumen = document.getElementById('resResumen')?.innerText || "";
    const beneficios = document.getElementById('resBeneficios')?.innerText || "";

    const textoACopiar = `INFORME DE C√ìMPUTO PENAL\n` +
                         `Privado: ${nombre}\n\n` +
                         `RESUMEN:\n${resumen}\n\n` +
                         `BENEFICIOS:\n${beneficios}`;

    const btn = event.currentTarget;
    const originalText = btn.innerHTML;

    try {
        await navigator.clipboard.writeText(textoACopiar);
        mostrarExito(btn, originalText);
    } catch (err) {
        try {
            const textArea = document.createElement("textarea");
            textArea.value = textoACopiar;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand("copy");
            document.body.removeChild(textArea);
            mostrarExito(btn, originalText);
        } catch (secondaryErr) {
            console.error('Error definitivo al copiar: ', secondaryErr);
            alert("Error al acceder al portapapeles.");
        }
    }
}

function mostrarExito(btn, textoOriginal) {
    btn.style.background = "#28a745";
    btn.innerHTML = "¬°Copiado con √©xito! ‚úÖ";
    
    setTimeout(() => {
        btn.style.background = "#6c757d";
        btn.innerHTML = textoOriginal;
    }, 2000);
}

function enviarAGoogleCalendar(cliente, descripcion, fechaRecordatorio, expediente) {
    if (!fechaRecordatorio || fechaRecordatorio === "No asignado" || fechaRecordatorio === "") {
        alert("Por favor, asigne una fecha en el campo 'Avisarme el d√≠a' antes de sincronizar.");
        return;
    }

    const fechaLimpia = fechaRecordatorio.replace(/-/g, '');
    const titulo = encodeURIComponent(`IURIS: Exp. ${expediente} - ${cliente}`);
    const detalles = encodeURIComponent(`Gesti√≥n Pendiente: ${descripcion}\n\nGenerado por Calculadora Penal Iuris.`);
    const fechas = `${fechaLimpia}/${fechaLimpia}`;

    const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${titulo}&details=${detalles}&dates=${fechas}`;
    window.open(url, '_blank');
}

function compartirReferido() {
    const emailUsuario = auth.currentUser ? auth.currentUser.email : "mi_correo";
    const mensaje = encodeURIComponent(
        `üìå *INVITACI√ìN ESPECIAL*\n\n` +
        `Colega, le recomiendo la *Calculadora Penal Iuris*. Es una herramienta excelente para c√≥mputos y dosimetr√≠a.\n\n` +
        `Reg√≠strese aqu√≠: https://consultoraiurislegal.github.io/calculadora-penal/\n\n` +
        `üéÅ *Diga que voy de su parte usando mi c√≥digo de referido:* ${emailUsuario}\n` +
        `y pida su mes de regalo al activar su plan.`
    );
    window.open(`https://wa.me/?text=${mensaje}`, '_blank');
}

// LOGICA DE ADMINISTRADOR (A√ëADIDA)
auth.onAuthStateChanged(async (user) => {
    if (user) {
        const doc = await db.collection('usuarios').doc(user.uid).get();
        if (doc.exists && doc.data().rol === 'admin') {
            document.getElementById('tab-admin').style.display = 'block';
        }
    }
});

async function cargarUsuariosAdmin() {
    const tbody = document.getElementById('bodyUsuariosAdmin');
    tbody.innerHTML = "<tr><td colspan='5'>Cargando usuarios...</td></tr>";
    
    try {
        const snapshot = await db.collection('usuarios').get();
        tbody.innerHTML = "";
        
        snapshot.forEach(doc => {
            const u = doc.data();
            const uid = doc.id;
            const hoy = new Date();
            const fechaVenc = new Date(u.vencimiento);
            const esVigente = fechaVenc > hoy;
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <b>${u.email}</b><br>
                    <small>${u.fechaRegistro ? new Date(u.fechaRegistro).toLocaleDateString() : 'S/F'}</small>
                </td>
                <td>${u.referidoPor || 'Directo'}</td>
                <td style="color: ${esVigente ? 'green' : 'red'}; font-weight: bold;">
                    ${esVigente ? 'VIGENTE' : 'VENCIDO'}
                </td>
                <td>
                    <input type="date" id="venc-${uid}" value="${u.vencimiento ? u.vencimiento.split('T')[0] : ''}" style="padding:5px; font-size:0.8em;">
                </td>
                <td>
                    <button onclick="actualizarSuscripcionManual('${uid}')" style="background:#1a73e8; color:white; border:none; padding:5px; border-radius:4px; cursor:pointer;">üíæ</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    } catch (e) {
        console.error("Error cargando usuarios:", e);
        alert("No tienes permisos para ver esta lista.");
    }
}

async function actualizarSuscripcionManual(uid) {
    const nuevaFecha = document.getElementById(`venc-${uid}`).value;
    if (!nuevaFecha) return alert("Seleccione una fecha v√°lida.");

    try {
        const fechaISO = new Date(nuevaFecha + "T23:59:59").toISOString();
        await db.collection('usuarios').doc(uid).update({
            vencimiento: fechaISO,
            rol: 'premium'
        });
        alert("Suscripci√≥n actualizada correctamente.");
        cargarUsuariosAdmin();
    } catch (e) {
        alert("Error al actualizar: " + e.message);
    }
}

// --- NUEVAS FUNCIONES PARA MANEJO DE HORAS ---

// Constantes basadas en a√±o de 360 d√≠as (est√°ndar laboral/penal habitual en tu c√≥digo)
const H_DIA = 24;
const H_MES = 30 * 24; // 720 horas
const H_ANO = 360 * 24; // 8640 horas

// Convierte A√±os, Meses, D√≠as, Horas a Total de Horas
function aHoras(a, m, d, h) {
    return (parseInt(a||0) * H_ANO) + 
           (parseInt(m||0) * H_MES) + 
           (parseInt(d||0) * H_DIA) + 
           parseInt(h||0);
}
function desglosarHoras(totalHoras) {
    totalHoras = Math.round(totalHoras); 
    if (totalHoras <= 0) return "0 horas";
    let a = Math.floor(totalHoras / H_ANO);
    let resto = totalHoras % H_ANO;
    let m = Math.floor(resto / H_MES);
    resto = resto % H_MES;
    let d = Math.floor(resto / H_DIA);
    let h = Math.floor(resto % H_DIA);
    let txt = [];
    if(a > 0) txt.push(a + "a");
    if(m > 0) txt.push(m + "m");
    if(d > 0) txt.push(d + "d");
    if(h > 0) txt.push(h + "h");
    return txt.join(" ");
}
function calcularTerminoMedio() {
    const minH = aHoras(
        document.getElementById('tm_min_a').value,
        document.getElementById('tm_min_m').value,
        document.getElementById('tm_min_d').value,
        document.getElementById('tm_min_h').value
    );
    const maxH = aHoras(
        document.getElementById('tm_max_a').value,
        document.getElementById('tm_max_m').value,
        document.getElementById('tm_max_d').value,
        document.getElementById('tm_max_h').value
    );
    if (minH === 0 && maxH === 0) return alert("Ingrese los l√≠mites.");
    const promedioHoras = (minH + maxH) / 2;
    document.getElementById('resTM').innerHTML = 
        `<b>T√©rmino Medio:</b> <br> ${desglosarHoras(promedioHoras)}`;
}
function calcularConcursoIdeal() {
    if (!validarAccesoPremium()) return; 
    const totalHoras = aHoras(
        document.getElementById('ideal_a').value,
        document.getElementById('ideal_m').value,
        document.getElementById('ideal_d').value,
        document.getElementById('ideal_h').value
    );
    const porcentaje = parseFloat(document.getElementById('sliderIncremento').value);
    if (totalHoras <= 0) return alert("Ingrese una pena base.");
    const aumento = totalHoras * (porcentaje / 100);
    const totalFinal = totalHoras + aumento;
    document.getElementById('resIdeal').innerHTML = 
        `Pena Base: ${desglosarHoras(totalHoras)}<br>` +
        `+ Aumento: ${desglosarHoras(aumento)}<br>` +
        `<strong>TOTAL: ${desglosarHoras(totalFinal)}</strong>`;
}
function calcularAdmision() {
    if (!validarAccesoPremium()) return;
    const totalHoras = aHoras(
        document.getElementById('adm_a').value,
        document.getElementById('adm_m').value,
        document.getElementById('adm_d').value,
        document.getElementById('adm_h').value
    );
    const porcentajeRebaja = parseFloat(document.getElementById('sliderRebaja').value);
    if (totalHoras <= 0) return alert("Ingrese una pena.");
    
    const rebaja = totalHoras * (porcentajeRebaja / 100);
    const totalFinal = totalHoras - rebaja;
    document.getElementById('resAdmision').innerHTML = 
        `<small>Pena Original: ${desglosarHoras(totalHoras)}</small><br>` +
        `<small>Rebaja: -${desglosarHoras(rebaja)}</small><hr>` +
        `<div style="font-size: 1.2em; color: #27ae60; font-weight: bold;">Final: ${desglosarHoras(totalFinal)}</div>`;
}
</script>
</body>
</html>
