<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculadora Penal</title>
<link rel="manifest" href="manifest.json">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<style>
/* TUS ESTILOS ORIGINALES */
body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 15px; color: #333; margin: 0; }
.header-app { text-align: center; padding: 25px 10px; background: white; margin-bottom: 20px; border-bottom: 3px solid #1a73e8; }
.header-app h1 { font-size: 1.5em; color: #1a73e8; margin: 0; text-transform: uppercase; letter-spacing: 1px; }
.header-app p { margin: 5px 0 0; font-weight: bold; color: #555; font-size: 1em; }

/* BARRA DE USUARIO ACTUALIZADA */
.user-status-bar { 
background: #f8f9fa; 
padding: 8px 15px; 
border-radius: 8px; 
margin: -10px 10px 20px 10px; 
display: flex; 
justify-content: space-between; 
align-items: center;
font-size: 0.75em; 
color: #666;
border: 1px solid #e1e4e8;
}
.btn-logout { background: #fee2e2; color: #dc2626; border: 1px solid #fca5a5; padding: 4px 8px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-left: 10px; }

/* ESTILO PARA EL INTERRUPTOR DE NUBE */
.switch-container {
display: flex;
align-items: center;
justify-content: space-between;
background: #e8f0fe;
padding: 10px 15px;
border-radius: 10px;
margin-bottom: 15px;
border: 1px solid #1a73e8;
}
.switch { position: relative; display: inline-block; width: 40px; height: 22px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
.slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: #1a73e8; }
input:checked + .slider:before { transform: translateX(18px); }

.modulo { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
.sub-modulo { background: #f8f9fa; border: 1px dashed #1a73e8; padding: 15px; border-radius: 10px; margin-top: 15px; display: none; }
h2 { color: #1a73e8; font-size: 1em; margin-top: 0; border-bottom: 2px solid #e8f0fe; padding-bottom: 10px; text-transform: uppercase; }
label { display: block; margin-top: 12px; font-weight: 600; font-size: 0.85em; color: #555; }
input, select, textarea { width: 100%; padding: 12px; margin-top: 5px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; font-size: 1em; }
#listaCasos, #listaCasosGestion { max-height: 200px; overflow-y: auto; margin-top: 10px; border-radius: 8px; background: #fff; }
.btn-principal { width: 100%; background: #1a73e8; color: white; border: none; padding: 18px; border-radius: 12px; font-weight: bold; font-size: 1.1em; margin-top: 10px; cursor: pointer; }
.btn-whatsapp { width: 100%; background: #25D366; color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; margin-top: 5px; display: flex; align-items: center; justify-content: center; text-decoration: none; font-size: 1em; }
.btn-pdf { width: 100%; background: #e74c3c; color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; margin-top: 10px; cursor: pointer; font-size: 1em; display: none; }
.btn-add { background: #34a853; color: white; border: none; padding: 8px 12px; border-radius: 8px; margin-top: 10px; font-size: 0.8em; cursor: pointer; font-weight: bold; }
.btn-calc-red { background: #6c757d; color: white; border: none; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.9em; cursor: pointer; width: 100%; }
.btn-save { background: #28a745; margin-bottom: 10px; }
.btn-delete { background: #dc3545; color: white; border: none; padding: 5px 8px; border-radius: 5px; cursor: pointer; font-size: 0.8em; }
.grid-3 { display: flex; gap: 8px; }
.grid-red { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 8px; align-items: center; margin-top: 10px; }
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.beneficio-item { margin-bottom: 15px; padding: 12px; border-radius: 10px; background: #fff; border: 1px solid #e1e4e8; font-size: 0.9em; line-height: 1.4; }
.case-card { border-left: 5px solid #1a73e8; background: #f8f9fa; padding: 10px; margin-bottom: 5px; border-radius: 8px; font-size: 0.85em; display: flex; justify-content: space-between; align-items: center; }
.search-box { background: #e8f0fe; padding: 15px; border-radius: 15px; margin-bottom: 20px; }
.res-box { background: #f0f7ff; padding: 15px; border-radius: 10px; margin-top: 10px; border-left: 5px solid #1a73e8; }
.txt-destaque { color: #d93025; font-weight: bold; }
.txt-cumplido { color: #28a745; font-weight: bold; }
.db-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
.btn-db { background: #6c757d; color: white; border: none; padding: 10px; border-radius: 8px; font-size: 0.8em; cursor: pointer; font-weight: bold; }
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow-y: auto; }
.modal-content { background-color: white; margin: 5% auto; padding: 20px; border-radius: 15px; width: 90%; max-width: 600px; line-height: 1.5; font-size: 0.85em; position: relative; }
.close-modal { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }

/* --- PEGAR ESTO EN LUGAR DE LO QUE BORRASTE (L√çNEAS 84-86 APROX) --- */

/* --- REEMPLAZA TU BLOQUE .tabs-container POR ESTE --- */
.tabs-container {
    display: flex;
    overflow-x: auto;
    white-space: nowrap;
    background: #fff;
    margin-bottom: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    -webkit-overflow-scrolling: touch;
    
    /* Espacio extra a la derecha para que el √∫ltimo bot√≥n no quede pegado */
    padding-right: 40px; 
    
    /* Espacio abajo para que quepa la barrita de scroll */
    padding-bottom: 5px; 
}

/* DISE√ëO DE LA BARRA DE SCROLL (Fina y Elegante) */
.tabs-container::-webkit-scrollbar {
    height: 4px; /* Altura de la barra horizontal */
    display: block; /* Hacemos que se vea */
}

.tabs-container::-webkit-scrollbar-track {
    background: transparent; 
}

.tabs-container::-webkit-scrollbar-thumb {
    background-color: #e0e0e0; /* Color gris suave */
    border-radius: 10px;
}

/* Al pasar el mouse o tocar, se pone azul */
.tabs-container:hover::-webkit-scrollbar-thumb {
    background-color: #1a73e8; 
}


.tab-button {
    flex: 0 0 auto;             /* IMPORTANTE: Mantiene el tama√±o del bot√≥n */
    padding: 15px 20px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-weight: bold;
    color: #666;
    transition: 0.3s;
    font-size: 0.85em;
    border-bottom: 3px solid transparent;
}

.tab-button.active {
    color: #1a73e8;
    background: #f8f9fa;
    border-bottom: 3px solid #1a73e8;
}

.tab-content { display: none; }
.tab-content.active { display: block; }
.calc-res { background: #fff3cd; padding: 10px; border-radius: 8px; margin-top: 10px; border-left: 5px solid #ffc107; font-weight: bold; color: #856404; }

.report-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.8em; }
.report-table th, .report-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
.report-table th { background-color: #f2f2f2; }

/* ESTILOS PARA EL CONTRATO */
.contrato-scroll {
height: 300px;
overflow-y: scroll;
border: 1px solid #ccc;
padding: 15px;
background: #f9f9f9;
text-align: justify;
font-size: 0.9em;
margin-bottom: 15px;
border-radius: 8px;
}

/* Agrega esto a tus estilos CSS */
.grid-4 { 
    display: grid; 
    grid-template-columns: 1fr 1fr 1fr 1fr; 
    gap: 8px; 
}
</style>
</head>
<body>
<div id="auth-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#1a2a40; z-index:9999; display:flex; align-items:center; justify-content:center; color:white; font-family:sans-serif;">
    
    <div style="background:white; padding:30px; border-radius:20px; width:85%; max-width:350px; text-align:center; color:#333;">
        <h2 style="margin:0; color:#1a73e8;">IURIS PENAL</h2>
        <p id="auth-title" style="margin-bottom:20px; font-size:0.9em; color:#666;">Inicie Sesi√≥n para continuar</p>

        <input type="email" id="f_email" placeholder="Correo electr√≥nico" style="width:100%; padding:12px; margin:8px 0; border:1px solid #ddd; border-radius:8px;">
        <input type="password" id="f_pass" placeholder="Contrase√±a (m√≠n. 6 caracteres)" style="width:100%; padding:12px; margin:8px 0; border:1px solid #ddd; border-radius:8px;">

        <div id="bloque-login">
            <button id="btn-login" onclick="loginFirebase()" style="width:100%; padding:15px; background:#1a73e8; color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer; margin-top:10px;">ENTRAR</button>
            <p style="margin-top:10px;"><a href="#" onclick="olvideClave()" style="color:#1a73e8; font-size:0.8em; text-decoration:none;">¬øOlvid√≥ su contrase√±a?</a></p>
            
            <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
                <p style="font-size:0.8em; color:#666;">¬øNo tienes cuenta?</p>
                <button onclick="toggleModoRegistro(true)" style="background:none; border:none; color:#34a853; font-weight:bold; cursor:pointer; font-size:1em;">Crear Cuenta Nueva</button>
            </div>
        </div>

        <div id="bloque-registro" style="display:none;">
            <div style="text-align:left; font-size:0.75em; color:#666; margin-top:10px; margin-left:5px;">
                Si viene recomendado, ingrese el <b>correo</b> de su colega:
            </div>
            <input type="email" id="f_referido" placeholder="ejemplo@correo.com (Opcional)" style="width:100%; padding:12px; margin:5px 0 15px 0; border:1px solid #ddd; border-radius:8px; background: #fffde7;">
            
            <button onclick="registroFirebase()" style="width:100%; padding:15px; background:#34a853; color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer;">REGISTRARME</button>
            
            <div style="margin-top:15px;">
                <button onclick="toggleModoRegistro(false)" style="background:none; border:none; color:#1a73e8; font-size:0.9em; cursor:pointer;">‚Üê Volver al Login</button>
            </div>
        </div>

        <p id="f_error" style="color:red; font-size:12px; margin-top:15px; min-height:15px;"></p>
    </div>

</div>

<div id="app-container">
<div class="header-app">
<h1>Calculadora Penal</h1>
<p>Consultora Iuris</p>
</div>

<div id="status-bar" class="user-status-bar" style="display:none;">
<div>üë§ <b id="user-display">Cargando...</b> <button class="btn-logout" onclick="logoutFirebase()">Salir</button></div>
<span>‚è≥ <b id="days-display">--</b></span>
</div>

<div class="tabs-container no-print">
<button class="tab-button active" onclick="openTab(event, 'gestion')">üìÅ Expedientes</button>
<button class="tab-button" onclick="openTab(event, 'principal')">‚ÄãüìÖC√≥mputo</button>
<button class="tab-button" onclick="openTab(event, 'calculadora')">‚Äãüßë‚Äç‚öñÔ∏è Dosimetr√≠a</button>
<button class="tab-button" onclick="openTab(event, 'prescripciones')">‚öñÔ∏è Prescripciones </button>
<button class="tab-button" onclick="openTab(event, 'conversiones')">üîÑ Conversiones</button>
<button class="tab-button" onclick="openTab(event, 'herramientas')">üõ†Ô∏è Herramientas</button>
<button id="tab-admin" class="tab-button" style="display:none; background: #991b1b; color: white;" onclick="openTab(event, 'adminPanel')">üõ°Ô∏è Admin</button>
</div>

<div id="gestion" class="tab-content active">
    <div class="modulo search-box">
        <h2>üìÇ Todos los Casos</h2>
        <div class="switch-container">
            <span>‚òÅÔ∏è Sincronizar con la  Nube</span>
            <label class="switch">
                <input type="checkbox" id="syncToggleGestion" onchange="actualizarEstadoSync(this.checked)">
                <span class="slider"></span>
            </label>
        </div>
        <input type="text" id="busquedaGestion" placeholder="Buscar por nombre o c√©dula..." onkeyup="listarCasosGestion()">
        
        <div id="listaCasosGestion" style="max-height: 150px; overflow-y: auto; margin-top: 10px;"></div>
        <button class="btn-principal" style="background:#107c41; margin-top:10px; padding: 10px; font-size: 0.85em;" onclick="exportarTodaLaDataExcel()">
            üìó EXPORTAR TODA LA BASE DE DATOS A EXCEL
        </button>
    </div>



    <div class="modulo">
        <h2>üìù Registro de Informaci√≥n</h2>
        <input type="hidden" id="idCasoGestion">
        
        <div class="grid-2">
            <div><label>Nombre Completo:</label><input type="text" id="gNombre" oninput="document.getElementById('pNombre').value = this.value"></div>
            <div><label>C√©dula:</label><input type="text" id="gCedula" oninput="document.getElementById('pCedula').value = this.value"></div>
        </div>

        <div class="grid-3">
            <div><label>Exp. Judicial:</label><input type="text" id="gExpJud"></div>
            <div><label>Exp. Fiscal√≠a:</label><input type="text" id="gExpFis"></div>
            <div><label>Exp. Carcelario:</label><input type="text" id="gExpCar"></div>
        </div>

        <div class="grid-2">
            <div><label>Fiscal√≠a N¬∫:</label><input type="text" id="gNumFis"></div>
            <div><label>Tribunal:</label><input type="text" id="gTribunal"></div>
        </div>

        <label>Centro de Reclusi√≥n:</label><input type="text" id="gLugar">

        <div class="grid-2">
            <div>
                <label>Fase Procesal:</label>
                <select id="gFase">
                    <option value="Preparatoria">Preparatoria</option>
                    <option value="Intermedia">Intermedia</option>
                    <option value="Juicio">Juicio</option>
                    <option value="Ejecuci√≥n">Ejecuci√≥n</option>
                </select>
            </div>
            <div><label>Delito:</label><input type="text" id="gDelito"></div>
        </div>

        <div style="background: #fdf2f2; padding: 10px; border-radius: 8px; margin-top: 10px; border: 1px solid #fca5a5;">
            <label>¬øCaso de Drogas?</label>
            <select id="gEsDrogas" onchange="document.getElementById('gDivDrogas').style.display = (this.value=='si'?'block':'none')">
                <option value="no">No</option>
                <option value="si">S√≠</option>
            </select>
            <div id="gDivDrogas" style="display:none; margin-top:10px;">
                <div class="grid-2">
                    <div><label>Tipo de Droga:</label><input type="text" id="gTipoDroga" placeholder="Ej: Coca√≠na"></div>
                    <div><label>Cantidad:</label><input type="text" id="gCantDroga" placeholder="Ej: 500g"></div>
                </div>
            </div>
        </div>

        <div id="seccionEjecucionGestion" style="background: #fff9db; padding: 10px; border-radius: 8px; margin-top: 10px;">
            <label>Fecha de Detenci√≥n Inicial:</label>
            <input type="date" id="gFechaIni" oninput="document.getElementById('fDetencionUnica').value = this.value">
        </div>

        <div class="grid-2">
            <div><label>Familiar:</label><input type="text" id="gFamiliar"></div>
            <div><label>Tel√©fono:</label><input type="text" id="gTel"></div>
        </div>

        <button class="btn-principal btn-save" onclick="guardarCasoCompleto()">üíæ GUARDAR EXPEDIENTE</button>
        <button class="btn-add" style="background:#dc3545; width:100%; margin-top:10px;" onclick="nuevoExpedienteGestion()">NUEVO / LIMPIAR</button>
    </div>

    <div class="modulo">
        <h2>üìÖ Bit√°cora y Agenda</h2>
        <div class="grid-2">
            <div>
                <label>Fecha del Evento:</label>
                <input type="datetime-local" id="evFecha">
            </div>
            <div>
                <label>üîî Avisarme el d√≠a y hora:</label>
                 <input type="datetime-local" id="evRecordatorio">
            </div>
        </div>
        <label>Descripci√≥n:</label>
        <input type="text" id="evMinuta" placeholder="Ej: Audiencia Preliminar...">
        <button class="btn-add" style="width: 100%; margin-top: 10px;" onclick="agregarEvento()">+ Registrar Evento y Recordatorio</button>
        
        <div id="scrollEventos" style="margin-top: 15px; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 8px; background: #fafafa;">
            <p style="text-align: center; color: #999;">Seleccione un caso para ver sus eventos</p>
        </div>
    </div>
</div>

<div id="principal" class="tab-content">
    <div class="modulo search-box no-print">
        <h2>üìÇ Casos de Privados Condenados</h2>

        <div class="switch-container">
            <span style="font-size: 0.85em; font-weight: bold; color: #1a73e8;">‚òÅÔ∏è Sincronizar con la Nube</span>
            <label class="switch">
                <input type="checkbox" id="syncToggle" onchange="actualizarEstadoSync(this.checked)">
                <span class="slider"></span>
            </label>
        </div>

        <input type="text" id="busqueda" placeholder="Escriba nombre o c√©dula..." onkeyup="listarCasos()">
        <div id="listaCasos"></div>
    </div>

    <div class="modulo">
        <input type="hidden" id="casoActivoId" value="">
        <h2>0. Datos del Privado de Libertad</h2>
        <div class="grid-2">
            <div><label>Nombre:</label><input type="text" id="pNombre" required oninput="document.getElementById('gNombre').value = this.value"></div>
            <div><label>C√©dula:</label><input type="text" id="pCedula" required oninput="document.getElementById('pCedula').value = this.value"></div>
        </div>
        <div class="grid-2">
            <div><label>Exp. Judicial:</label><input type="text" id="pExpJud"></div>
            <div><label>Exp. Carcelario:</label><input type="text" id="pExpCar"></div>
        </div>
        <label>Delito:</label><input type="text" id="pDelito" placeholder="Ej: Robo Agravado">
        <label>Lugar de Reclusi√≥n:</label><input type="text" id="pLugar">
    </div>

    <div class="modulo">
        <h2>1. Condena y Fechas de Detencion</h2>
        <div class="grid-3">
            <div><label>A√±os</label><input type="number" id="cAno" placeholder="0"></div>
            <div><label>Meses</label><input type="number" id="cMes" placeholder="0"></div>
            <div><label>D√≠as</label><input type="number" id="cDia" placeholder="0"></div>
        </div>
        <label>¬øAcumulaci√≥n de Penas / Periodos?</label>
        <select id="esAcum" onchange="toggleAcumulacion()"><option value="no">No</option><option value="si">S√≠</option></select>

        <div id="seccionUnica">
            <label>Fecha Detenci√≥n:</label>
            <input type="date" id="fDetencionUnica" oninput="document.getElementById('gFechaIni').value = this.value">
        </div>

        <div style="margin-top: 15px; padding: 10px; background: #fffbe6; border: 1px solid #ffe58f; border-radius: 8px;">
            <label style="color: #856404; margin-top: 0;">üìÖ Realizar c√≥mputo a la fecha de:</label>
            <input type="date" id="fFechaCorte">
            <small style="color: #666;">(Por defecto es hoy, pero puede cambiarla)</small>
        </div>

        <div id="seccionAcumulada" style="display:none;">
            <div id="contenedorPeriodos"></div>
            <button class="btn-add no-print" onclick="agregarPeriodo()">+ Agregar Periodo Anterior</button>
            <label>Detenci√≥n Actual (Desde):</label><input type="date" id="fDetencionActual">
        </div>
    </div>

    <div class="modulo no-print">
        <h2>2. Tiempo Redimido</h2>
        <div id="listaRedenciones"></div>
        <button class="btn-add" onclick="agregarFilaRedencion(0,0,0)">+ A√±adir Manualmente</button>
        <button class="btn-calc-red" onclick="toggleSubModulo()">Calculadora de redenciones</button>
        <div id="subModuloRedencion" class="sub-modulo">
            <h3>C√°lculo de Redencion</h3>
            <label>Fecha de Inicio de Labores:</label><input type="date" id="redInicio">
            <label>Fecha de Fin de Labores:</label><input type="date" id="redFin">
            <div class="grid-2">
                <div><label>D√≠as/Semana:</label><input type="number" id="redDiasSemana" value="5"></div>
                <div><label>Horas/D√≠a:</label><input type="number" id="redHorasDia" value="8"></div>
            </div>
            <button class="btn-principal" style="background:#28a745; padding:10px;" onclick="procesarRedencionAutomatica()">Procesar</button>
            <div id="resultadoMiniRed"></div>
        </div>
    </div>

    <div id="controles-principales" style="padding: 0 15px;" class="no-print">
        <button class="btn-principal btn-save" id="btnGuardar" onclick="guardarCasoCompleto()">üíæ GUARDAR EXPEDIENTE</button>
        <button class="btn-principal" onclick="validarYCalcular()">CALCULAR C√ìMPUTO Y BENEFICIOS</button>
        <button class="btn-add" style="background:#dc3545; width:100%; margin-top:10px;" onclick="nuevoExpediente()">NUEVO / LIMPIAR</button>
    </div>

    <div id="resultado" class="modulo" style="display:none;">
        <h2 id="resTitulo">Resultados</h2>
        <button onclick="copiarResultados(event)" class="btn-principal" style="background: #6c757d; margin: 10px 0; width: 100%; font-size: 0.85em;">
    Copiar Resultados al Portapapeles üìã
</button>

        <div id="resResumen"></div><hr>
        <h3>Proyecci√≥n de Beneficios Penales</h3>
        <div id="resBeneficios"></div>
    </div>
</div>

<div id="calculadora" class="tab-content">

    <div class="modulo" style="border-left: 5px solid #1a73e8; background: #fdfdfd;">
        <h2 style="color: #1565c0;">üßÆ Dosimetr√≠a Penal </h2>
        <div style="background: #f8f9fa; border: 1px solid #e1e4e8; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
    <h4 style="margin: 0 0 10px 0; color: #1a73e8; font-size: 0.95em; text-transform: uppercase; letter-spacing: 0.5px;">
        üìò Protocolo de C√°lculo Autom√°tico
    </h4>
    
    <div style="display: grid; gap: 8px; font-size: 0.9em; color: #555;">
        
        <div style="display: flex; align-items: start; gap: 10px;">
            <span style="background: #e8f0fe; color: #1a73e8; font-weight: bold; min-width: 20px; text-align: center; border-radius: 4px;">1</span>
            <div><b>Selecci√≥n:</b> Escoja el delito o delitos imputados del cat√°logo.</div>
        </div>

        <div style="display: flex; align-items: start; gap: 10px;">
            <span style="background: #e8f0fe; color: #1a73e8; font-weight: bold; min-width: 20px; text-align: center; border-radius: 4px;">2</span>
            <div><b>Individualizaci√≥n:</b> Aplique atenuantes/agravantes, genericas y especificas y fije la pena base.</div>
        </div>

        <div style="display: flex; align-items: start; gap: 10px;">
            <span style="background: #e8f0fe; color: #1a73e8; font-weight: bold; min-width: 20px; text-align: center; border-radius: 4px;">3</span>
            <div><b>Iter Criminis:</b> Determine el grado de ejecuci√≥n (Tentativa / Frustraci√≥n).</div>
        </div>

        <div style="display: flex; align-items: start; gap: 10px;">
            <span style="background: #e8f0fe; color: #1a73e8; font-weight: bold; min-width: 20px; text-align: center; border-radius: 4px;">4</span>
            <div><b>Participaci√≥n:</b> Establezca el grado de intervenci√≥n (Autor√≠a / Complicidad).</div>
        </div>

        <div style="display: flex; align-items: start; gap: 10px;">
            <span style="background: #e8f0fe; color: #1a73e8; font-weight: bold; min-width: 20px; text-align: center; border-radius: 4px;">5</span>
            <div><b>Pluralidad:</b> El sistema detectar√° y aplicar√° reglas de Concurso (Real / Ideal).</div>
        </div>

        <div style="display: flex; align-items: start; gap: 10px;">
            <span style="background: #e8f0fe; color: #1a73e8; font-weight: bold; min-width: 20px; text-align: center; border-radius: 4px;">6</span>
            <div><b>Procedimiento:</b> Aplique rebaja por Admisi√≥n de los Hechos si corresponde.</div>
        </div>

    </div>

    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ccc; font-weight: bold; color: #2e7d32; display: flex; align-items: center; gap: 5px;">
        üèÅ Resultado: <span style="font-weight: normal; color: #333;">Sentencia Definitiva Lista.</span>
    </div>
</div>

        
        <div id="contenedorDelitosDosimetria"></div>

        <button class="btn-add" style="width: 100%; padding: 15px; font-size: 1em; background: #1a73e8;" onclick="agregarBloqueDelito()">
            + AGREGAR DELITO AL CALCULO
        </button>

        <div id="seccionConcurso" style="display:none; margin-top: 20px; border: 2px solid #e67e22; padding: 15px; border-radius: 10px; background: #fffbf0;">
            <h3 style="color: #e67e22; margin-top: 0;">üîó Reglas de Concurso</h3>
            
            <label>Tipo de Concurso:</label>
           <select id="tipoConcurso" onchange="actualizarUIConcurso()">
    <option value="Real">Concurso Real (Art. 86 CP)</option>
    <option value="Ideal">Concurso Ideal (Art. 87 CP)</option>
    <option value="SinConcurso">Sin Concurso (Suma Aritm√©tica)</option> </select>


            <div id="uiConcursoIdeal" style="display:none; margin-top: 10px; background: #fff; padding: 10px; border-radius: 5px;">
                <label>Aumento por Concurso Ideal (Fracci√≥n):</label>
                <input type="text" id="fraccionIdeal" placeholder="Ej: 1/6">
                <small>Se aplicar√° a la pena m√°s grave.</small>
            </div>
        </div>

        <div class="modulo" style="margin-top: 20px; border-left: 5px solid #27ae60; background: #fff;">
            <h3>ü§ù Procedimiento Especial</h3>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <label style="margin:0;">¬øAplica Admisi√≥n de los Hechos?</label>
                <div class="switch-container" style="padding: 2px; margin:0; border:none; background:none;">
                    <label class="switch">
                        <input type="checkbox" id="chkAdmision">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <div id="uiAdmision" style="margin-top: 10px;">
                <label>Rebaja a aplicar:</label>
                <input type="text" id="fraccionAdmision" placeholder="Ej: 1/3">
            </div>
        </div>

        <button class="btn-principal" onclick="calcularDosimetriaFinal()">CALCULAR SENTENCIA DEFINITIVA</button>

        <div id="resDosimetria" class="modulo" style="display:none; margin-top: 20px; border-top: 5px solid #2e7d32; background: #fff;">
            <h2 style="color:#2e7d32;">‚öñÔ∏è Sentencia Estimada</h2>
            
            <div class="grid-2">
                <div style="text-align:center;">
                    <span style="font-size: 0.9em; color: #666;">Pena Total:</span><br>
                    <b id="lblPenaFinal" style="font-size: 1.5em;">--</b>
                </div>
                <div style="text-align:center;">
                    <span style="font-size: 0.9em; color: #666;">Fecha Cumplimiento:</span><br>
                    <b id="lblFechaFinal" style="color: #d93025;">--</b>
                </div>
            </div>

            <h3>üìù Iter Procesal (Fundamentaci√≥n)</h3>
            <div id="iterDosimetria" style="font-family: 'Courier New', Courier, monospace; font-size: 0.85em; background: #333; color: #fff; padding: 15px; border-radius: 8px; white-space: pre-wrap;"></div>
        </div>
    </div>
   


</div>

<div id="prescripciones" class="tab-content">
    
      <div class="modulo">
        <h2>1. Selecci√≥n del Delito</h2>
        
        <style>
            /* ESTO PERMITE QUE EL TEXTO BAJE DE L√çNEA */
.opcion-multilinea {
    white-space: normal !important;
    word-wrap: break-word !important;
    border-bottom: 1px solid #f0f0f0;
    padding: 8px 5px; /* Un poco m√°s de espacio */
    font-size: 0.9em;
    line-height: 1.2; /* Mejor lectura en varias l√≠neas */
}

/* ESTO HACE QUE LA CAJA SEA GRANDE SIEMPRE */
#selDelitoPresc {
    height: auto !important;
    min-height: 250px !important; /* Altura fija grande */
    overflow-y: auto;
}

        </style>

        <label>Buscar delito:</label>
        <input type="text" id="inputBusquedaDelito" placeholder="Escriba para filtrar (ej: robo...)" 
               onkeyup="filtrarDelitosUI()" style="margin-bottom:5px; background:#f0f8ff;">
        
        <select id="selDelitoPresc" onchange="cargarDatosDelitoSeleccionado()" size="7" style="height: auto; min-height: 180px;">
            <option value="">-- Resultados de la b√∫squeda --</option>
        </select>
        <small style="color:#666; display:block; margin-top:2px;">üëÜ Seleccione el delito en la lista</small>

        <div id="infoDelito" style="background:#e8f0fe; padding:10px; margin-top:10px; border-radius:8px; font-size:0.9em; display:none; border: 1px solid #b6d4fe;">
            <div class="grid-2">
                <div><b>Ley:</b> <span id="lblLey"></span></div>
                <div><b>Art√≠culo:</b> <span id="lblArticulo"></span></div>
            </div>
            
            <div style="margin-top:5px; padding-top:5px; border-top:1px dashed #ccc;">
                <b>Tipo de Pena:</b> <span id="lblSancion" style="color:#d93025; font-weight:bold; text-transform: uppercase;"></span>
            </div>

            <div class="grid-2" style="margin-top:5px;">
                <div><b>Acci√≥n:</b> <span id="lblAccion"></span></div>
                <div><b>Condici√≥n:</b> <span id="lblCondicion" style="font-weight:bold;"></span></div>
            </div>

            <div style="margin-top:5px; border-top:1px dashed #ccc; padding-top:5px;">
                <b>L√≠mites:</b> <span id="lblRango"></span> <br>
                <b>T√©rmino Medio:</b> <span id="lblMediaBase" style="color:#1a73e8; font-weight:bold;"></span>
                <br><small>(Base para el c√°lculo de prescripci√≥n)</small>
            </div>
            
            <span id="lblMin" style="display:none;"></span>
            <span id="lblMax" style="display:none;"></span>
            <span id="lblTiempoPresc" style="display:none;"></span>
        </div>
    </div>


    <div id="moduloAccionPenal" class="modulo">
        <h2>2. Prescripci√≥n de la Acci√≥n Penal</h2>
        
        <label>Grado de Ejecuci√≥n:</label>
        <select id="selGradoEjecucion" onchange="actualizarInterfazRebajas()">
            <option value="Consumado">Delito Consumado (Sin rebaja)</option>
            <option value="Frustrado">Delito Frustrado (Rebaja 1/3)</option>
            <option value="Tentativa">Tentativa (Rebaja de 1/2 a 2/3)</option>
        </select>

        <div id="divFraccionManual" style="display:none; background:#fff3cd; padding:10px; border-radius:5px; margin-top:5px;">
            <label>Fracci√≥n de rebaja a aplicar:</label>
            <div class="grid-2">
                <input type="text" id="fraccionEjecucion" placeholder="Ej: 1/3">
                <small style="align-self:center; color:#666;">(Puede editar ej: 1/2, 1/3, 2/3)</small>
            </div>
        </div>

        <label style="margin-top:15px;">Grado de Intervenci√≥n:</label>
        <select id="selGradoIntervencion">
            <option value="Perpetrador">Autor / Coautor / Coop. Inmediato (Igual pena)</option>
            <option value="Complice">C√≥mplice Simple / Facilitador (Rebaja 1/2)</option>
        </select>

        <hr style="border: 0; border-top: 1px solid #ddd; margin: 15px 0;">

       <div class="modulo-fechas">
    <label>Fecha de Comisi√≥n del Hecho / ultimo acto de ejecucion / cese de continuacion o permanencia del hecho/ interrupcion:</label>
    <input type="date" id="fHechoPresc">

    <div style="background: #fff3cd; padding: 10px; border-radius: 8px; margin-top: 15px; border: 1px solid #ffeeba;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <label style="margin:0; color:#856404;">¬øExisti√≥ Suspensi√≥n del Lapso?</label>
            <div class="switch-container" style="padding: 2px; margin:0; border:none; background:none;">
                <label class="switch">
                    <input type="checkbox" id="chkSuspension" onchange="document.getElementById('divFechasSuspension').style.display = this.checked ? 'block' : 'none'">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div id="divFechasSuspension" style="display:none; margin-top: 10px; border-top: 1px solid #eec;">
            <p style="font-size:0.8em; color:#666; margin-bottom:5px;">Ingrese el periodo donde el proceso estuvo detenido (Ej. Esperando antejuicio de m√©rito, extradici√≥n, etc.):</p>
            <div class="grid-2">
                <div><label>Inicio Suspensi√≥n:</label><input type="date" id="fSuspInicio"></div>
                <div><label>Fin Suspensi√≥n:</label><input type="date" id="fSuspFin"></div>
            </div>
        </div>
    </div>
</div>

<button class="btn-principal" style="margin-top: 15px;" onclick="calcularPrescripcionInteligente()">CALCULAR PRESCRIPCI√ìN</button>

    </div>

 <div class="modulo" style="border-top: 5px solid #d93025;">
    <h2>3. Prescripci√≥n de la Pena (Art. 112 C.P.)</h2>
    
    <div style="background: #fff5f5; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9em; color: #555;">
        <b>Instrucciones:</b> Ingrese la pena impuesta  en la sentencia definitivamente firme, o lo que falte por cumplirse, de acuerdo al ultimo computo. No requiere seleccionar el delito del cat√°logo.
    </div>

    <label>Pena Impuesta (Sentencia Firme):</label>
    <div class="grid-3">
        <input type="number" id="pen_a" placeholder="A√±os">
        <input type="number" id="pen_m" placeholder="Meses">
        <input type="number" id="pen_d" placeholder="D√≠as">
    </div>

    <div class="grid-2">
        <div>
            <label>Tipo de Sanci√≥n:</label>
            <select id="pen_tipo">
                <option value="Presidio">Presidio (+ 1/2)</option>
                <option value="Prisi√≥n">Prisi√≥n (+ 1/2)</option>
                <option value="Arresto">Arresto (+ 1/2)</option>
                <option value="Relegaci√≥n">Relegaci√≥n (+ 1/3)</option>
                <option value="Confinamiento">Confinamiento (+ 1/3)</option>
            </select>
        </div>
        <div>
            <label>Inicio del C√≥mputo:</label>
            <input type="date" id="pen_inicio" placeholder="Fecha Sentencia Firme o Quebrantamiento">
            <small style="color:#666; font-size:0.75em;">(Fecha Sentencia Firme o Quebrantamiento)</small>
        </div>
    </div>

    <div style="background: #e3f2fd; padding: 10px; border-radius: 8px; margin-top: 15px; border: 1px solid #bbdefb;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <b style="color:#1565c0;">¬øSentencia por Varios Delitos?</b><br>
                <small style="color:#555;">(Concurso Real o Ideal -> Suma 1/4 a la prescripci√≥n)</small>
            </div>
            <div class="switch-container" style="padding: 2px; margin:0; border:none; background:none;">
                <label class="switch">
                    <input type="checkbox" id="chkConcursoPena">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>

    <button class="btn-principal" style="background: #c62828; margin-top: 15px;" onclick="calcularPrescripcionPena()">CALCULAR PRESCRIPCI√ìN DE LA PENA</button>

    <div id="resPenaBox" style="display:none; margin-top: 20px; background: #fff; padding: 15px; border-radius: 10px; border-left: 5px solid #c62828; border: 1px solid #eee;">
        <h3 style="color:#c62828; margin-top:0;">üõë Resultado del C√°lculo</h3>
        
        <div class="grid-2">
            <div>
                <b>Tiempo Total Requerido:</b><br>
                <span id="lblTiempoPena" style="font-size: 1.2em; font-weight: bold;">--</span>
            </div>
            <div>
                <b>Fecha de Prescripci√≥n:</b><br>
                <span id="lblFechaPena" style="font-size: 1.2em; color: #d93025; font-weight: bold;">--</span>
            </div>
        </div>

        <h4 style="margin-top: 15px; border-bottom: 1px solid #ddd;">üìù Iter Procesal</h4>
        <div id="iterPena" style="font-family: 'Courier New', Courier, monospace; font-size: 0.85em; background: #333; color: #fff; padding: 10px; border-radius: 5px; white-space: pre-wrap;">
        </div>

        <div style="margin-top: 10px; background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; font-size: 0.85em; border: 1px solid #ffeeba;">
            <b>‚ö†Ô∏è ADVERTENCIA JURISPRUDENCIAL:</b><br>
            En aquellos delitos donde la acci√≥n penal es considerada <b>IMPRESCRIPTIBLE</b> (Ej. Lesa Humanidad, Patrimonio P√∫blico, Tr√°fico de Drogas Mayor Cuant√≠a seg√∫n criterio), se entiende jur√≠dicamente que la <b>Pena</b> tambi√©n es imprescriptible. Verifique la naturaleza del delito antes de aplicar este resultado.
        </div>
    </div>
</div>


    <div id="resPrescripcion" class="modulo" style="display:none; border-top: 5px solid #2e7d32;">
        <h2 style="color:#2e7d32;">‚öñÔ∏è Dictamen Jur√≠dico</h2>
        
        <div style="background:#f1f8e9; padding:15px; border-radius:10px; margin-bottom:15px;">
            <div class="grid-2">
                <div>
                    <b>Lapso Ordinario:</b><br>
                    <span id="resLapsoOrd" style="font-size:1.2em;">--</span>
                </div>
                <div>
                    <b>Fecha Prescribe:</b><br>
                    <span id="resFechaOrd" style="font-size:1.2em; font-weight:bold; color:#d93025;">--</span>
                </div>
            </div>
            <div id="resExtraordinarioBox" style="margin-top:10px; border-top:1px solid #c8e6c9; padding-top:10px;">
                <b>Lapso Extraordinario (Judicial):</b> <span id="resLapsoExtra">--</span><br>
                <b>Fecha Tope:</b> <span id="resFechaExtra" style="color:#d93025; font-weight:bold;">--</span>
            </div>
        </div>

        <h3>üìù Iter Procesal (Explicaci√≥n del C√°lculo)</h3>
        <div id="iterProcesal" style="font-family: 'Courier New', Courier, monospace; font-size: 0.85em; background: #333; color: #fff; padding: 15px; border-radius: 8px; white-space: pre-wrap;">
            Aqu√≠ aparecer√° el desglose paso a paso...
        </div>
    </div>
</div>
<div id="conversiones" class="tab-content">
    
    <div class="modulo" style="border-top: 5px solid #e67e22;">
        <h2 style="color:#e67e22;">‚öñÔ∏è Equivalencias entre Penas</h2>
        <p style="font-size:0.9em; color:#666;">Calcule la conversi√≥n de tiempo f√≠sico seg√∫n las reglas de proporci√≥n del C√≥digo Penal.</p>

        <label>Tiempo a Convertir:</label>
        <div class="grid-3">
            <input type="number" id="conv_a" placeholder="A√±os">
            <input type="number" id="conv_m" placeholder="Meses">
            <input type="number" id="conv_d" placeholder="D√≠as">
        </div>

                <label>Tipo de Conversi√≥n (Regla):</label>
        <select id="tipoConversion">
            <optgroup label="Hacia PRISI√ìN">
                <option value="arr_pri">Arresto ‚Üí Prisi√≥n (2 d√≠as Arresto = 1 Prisi√≥n)</option>
                <option value="rel_pri">Releg/Conf/Exp ‚Üí Prisi√≥n (2 d√≠as = 1 Prisi√≥n)</option>
            </optgroup>
            <optgroup label="Hacia PRESIDIO">
                <option value="arr_pres">Arresto ‚Üí Presidio (3 d√≠as Arresto = 1 Presidio)</option>
                <option value="rel_pres">Relegaci√≥n ‚Üí Presidio (4 d√≠as Releg. = 1 Presidio)</option>
                <option value="conf_pres">Conf/Exp ‚Üí Presidio (5 d√≠as Conf. = 1 Presidio)</option>
                <option value="pri_pres">Prisi√≥n ‚Üí Presidio (2 d√≠as Prisi√≥n = 1 Presidio)</option>
            </optgroup>
        </select>


        <button class="btn-principal" style="background:#e67e22; margin-top:15px;" onclick="calcularEquivalencia()">CALCULAR EQUIVALENCIA</button>
        
        <div id="resEquivalencia" class="calc-res" style="border-left: 5px solid #e67e22; display:none;"></div>
    </div>

    <div class="modulo" style="border-top: 5px solid #2980b9;">
        <h2 style="color:#2980b9;">üîÑ Conmutaci√≥n de Penas</h2>
        <p style="font-size:0.9em; color:#666;">C√°lculo del aumento de pena al cambiar la naturaleza de la sanci√≥n.</p>

        <label>Pena Original:</label>
        <div class="grid-3">
            <input type="number" id="conm_a" placeholder="A√±os">
            <input type="number" id="conm_m" placeholder="Meses">
            <input type="number" id="conm_d" placeholder="D√≠as">
        </div>

        <label>Operaci√≥n de Conmutaci√≥n:</label>
        <select id="tipoConmutacion">
            <option value="pres_a_pri">Presidio ‚ûî Prisi√≥n (Aumento de 1/3)</option>
            <option value="pri_a_arr">Prisi√≥n ‚ûî Arresto (Aumento de 1/4)</option>
            <option value="pri_a_conf">Prisi√≥n ‚ûî Confinamiento (Aumento de 1/3)</option>
        </select>

        <button class="btn-principal" style="background:#2980b9; margin-top:15px;" onclick="calcularConmutacion()">CALCULAR CONMUTACI√ìN</button>
        
        <div id="resConmutacion" class="calc-res" style="border-left: 5px solid #2980b9; display:none;"></div>
    </div>

</div>
<div id="herramientas" class="tab-content">
    
    <div class="modulo" style="border-top: 5px solid #607d8b;">
        <h2>üìÖ Calcular lapso entre dos fechas</h2>
        <div class="grid-2">
            <div><label>Fecha Inicial:</label><input type="date" id="calc71_inicio"></div>
            <div><label>Fecha Final:</label><input type="date" id="calc71_fin"></div>
        </div>
        <button class="btn-principal" style="padding:10px; background:#607d8b;" onclick="calc71()">Calcular Lapso</button>
        <div id="res71" class="calc-res"></div>
    </div>

    <div class="modulo" style="border-top: 5px solid #607d8b;">
        <h2>‚ûï Sumar lapsos de tiempo</h2>
        <div id="listaLapsosSuma">
            <div class="grid-3"><input type="number" class="sa" placeholder="A√±os"><input type="number" class="sm" placeholder="M"><input type="number" class="sd" placeholder="D"></div>
        </div>
        <button class="btn-add" onclick="agregarFilaSuma()">+ Agregar otro lapso</button>
        <button class="btn-principal" style="padding:10px; background:#607d8b;" onclick="calc72()">Sumar Lapsos</button>
        <div id="res72" class="calc-res"></div>
    </div>

    <div class="modulo" style="border-top: 5px solid #607d8b;">
        <h2>‚ûñ Restar dos lapsos</h2>
        <p><small>Ingrese el lapso mayor arriba y el que desea restar abajo</small></p>
        <div class="grid-3">
            <input type="number" id="r1a" placeholder="A√±os">
            <input type="number" id="r1m" placeholder="Meses">
            <input type="number" id="r1d" placeholder="D√≠as">
        </div>
        <div style="text-align:center; margin: 5px 0; font-weight:bold; color:#607d8b;">MENOS</div>
        <div class="grid-3">
            <input type="number" id="r2a" placeholder="A√±os">
            <input type="number" id="r2m" placeholder="Meses">
            <input type="number" id="r2d" placeholder="D√≠as">
        </div>
        <button class="btn-principal" style="padding:10px; background:#607d8b;" onclick="calc73()">Restar Lapsos</button>
        <div id="res73" class="calc-res"></div>
    </div>

    <div class="modulo" style="border-top: 5px solid #607d8b;">
        <h2>üìÖ Sumar/Restar Lapso a una Fecha</h2>
        <label>Fecha Base:</label><input type="date" id="fBase745">
        <div class="grid-3"><input type="number" id="la745" placeholder="A√±os"><input type="number" id="lm745" placeholder="Meses"><input type="number" id="ld745" placeholder="D√≠as"></div>
        <div class="grid-2">
            <button class="btn-principal" style="padding:10px; background:#e67e22;" onclick="calc745('restar')">Restar Lapso</button>
            <button class="btn-principal" style="padding:10px; background:#27ae60;" onclick="calc745('sumar')">Sumar Lapso</button>
        </div>
        <div id="res745" class="calc-res"></div>
    </div>

    <div class="modulo" style="border-top: 5px solid #607d8b;">
        <h2>üç∞ Fragmentar una pena (Solo Fracci√≥n)</h2>
        <div class="grid-3"><input type="number" id="fra" placeholder="A√±os"><input type="number" id="frm" placeholder="Meses"><input type="number" id="frd" placeholder="D√≠as"></div>
        <label>Fracci√≥n (Ejemplo: 1/3 o 3/4):</label>
        <input type="text" id="fraccion" placeholder="1/2">
        <button class="btn-principal" style="padding:10px; background:#607d8b;" onclick="calc76()">Calcular Fracci√≥n</button>
        <div id="res76" class="calc-res"></div>
    </div>

    <div class="modulo" style="border-top: 5px solid #8e44ad;">
        <h2 style="color:#8e44ad;">üßÆ Operar Fracci√≥n sobre Lapso</h2>
        <p><small>Ej: A 4 a√±os, restarle su cuarta parte (1/4).</small></p>
        
        <label>Lapso Base:</label>
        <div class="grid-3">
            <input type="number" id="op_a" placeholder="A√±os">
            <input type="number" id="op_m" placeholder="Meses">
            <input type="number" id="op_d" placeholder="D√≠as">
        </div>

        <div class="grid-2">
            <div>
                <label>Fracci√≥n (Ej: 1/4):</label>
                <input type="text" id="op_frac" placeholder="1/4">
            </div>
            <div>
                <label>Acci√≥n:</label>
                <select id="op_tipo">
                    <option value="sumar">Sumar (+)</option>
                    <option value="restar">Restar (-)</option>
                </select>
            </div>
        </div>

        <button class="btn-principal" style="background:#8e44ad; margin-top:10px;" onclick="calcularOperacionFraccion()">CALCULAR RESULTADO</button>
        <div id="resOperacionFrac" class="calc-res" style="border-left: 5px solid #8e44ad;"></div>
    </div>

</div>


<div id="adminPanel" class="tab-content">
    
    <div class="modulo" style="border-top: 5px solid #8e44ad;">
        <h2>‚öñÔ∏è Gesti√≥n del Cat√°logo de Delitos</h2>
        
        <div class="grid-2">
            <div><label>Nombre del Delito:</label><input type="text" id="admDelitoNombre" placeholder="Ej: Robo Agravado"></div>
            <div><label>Ley:</label><input type="text" id="admDelitoLey" placeholder="Ej: C√≥digo Penal"></div>
        </div>

        <div class="grid-3">
            <div><label>Art√≠culo:</label><input type="text" id="admDelitoArt"></div>
            <div><label>Pena M√≠nima (A√±os):</label><input type="number" id="admDelitoMin" step="0.01"></div>
            <div><label>Pena M√°xima (A√±os):</label><input type="number" id="admDelitoMax" step="0.01"></div>
        </div>

        <div class="grid-3">
            <div>
                <label>Tipo de Sanci√≥n:</label>
                <select id="admDelitoSancion">
                    <option value="Presidio">Presidio</option>
                    <option value="Prisi√≥n">Prisi√≥n</option>
                    <option value="Arresto">Arresto</option>
                    <option value="Confinamiento">Confinamiento</option>
                    <option value="Multa">Multa</option>
                </select>
            </div>
            <div>
                <label>Tipo de Acci√≥n:</label>
                <select id="admDelitoTipo">
                    <option value="P√∫blica">P√∫blica</option>
                    <option value="Privada">Privada</option>
                </select>
            </div>
            <div>
                <label>Condici√≥n:</label>
                <select id="admDelitoCondicion">
                    <option value="Prescriptible">Prescriptible</option>
                    <option value="Imprescriptible">Imprescriptible</option>
                </select>
            </div>
        </div>

        <button class="btn-principal" style="background: #4a148c; margin-top:20px;" onclick="guardarDelitoAvanzado()">+ GUARDAR EN CAT√ÅLOGO</button>
        <div class="modulo" style="border-top: 5px solid #107c41; margin-top: 20px; background: #f0fff4;">
    <h3 style="color: #107c41;">üìó Importaci√≥n Masiva desde Excel</h3>
    <p style="font-size: 0.9em;">
        <b>Paso 1:</b> Descargue la plantilla obligatoria.<br>
        <b>Paso 2:</b> Llene los datos en Excel (No cambie los t√≠tulos).<br>
        <b>Paso 3:</b> Suba el archivo aqu√≠.
    </p>

    <div class="grid-2">
        <button class="btn-principal" onclick="descargarPlantillaDelitos()" style="background: #fff; color: #107c41; border: 1px solid #107c41;">
            üì• Descargar Plantilla.xlsx
        </button>
        <div style="position: relative; overflow: hidden; display: inline-block;">
            <button class="btn-principal" style="background: #107c41;">üìÇ Subir Excel Lleno</button>
            <input type="file" id="inputExcelDelitos" accept=".xlsx, .xls" onchange="procesarExcelDelitos()" style="font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer;">
        </div>
    </div>
    <small id="statusExcel" style="color: #666; font-weight: bold;"></small>
</div>

        <div style="margin-top: 30px; border-top: 2px dashed #ccc; padding-top: 20px;">
    <h3 style="color: #d93025;">üöÄ Zona de Publicaci√≥n Masiva</h3>
    <p style="font-size: 0.9em;">
        Use este bot√≥n despu√©s de agregar o borrar delitos. 
        Empaqueta todo el cat√°logo en un solo archivo para que los usuarios lo descarguen con <b>1 sola lectura</b>.
    </p>
    <button class="btn-principal" onclick="publicarCatalogoMaestro()" style="background: #d93025; font-weight: bold;">
        üì¶ PUBLICAR CAT√ÅLOGO MAESTRO (JSON)
    </button>
</div>

        <h3 style="margin-top: 20px;">Lista de Delitos Registrados</h3>

<div style="text-align: center; margin-bottom: 10px;">
    <button class="btn-principal" style="background: #6c757d; padding: 12px; font-size: 0.9em;" onclick="cargarDelitosEnAdmin()">
        üìÇ VER/EDITAR LISTA DE DELITOS (Clic aqu√≠)
    </button>
    <small style="color: #666; font-size: 0.8em;">(Presione solo si necesita editar. Consume lecturas de la base de datos)</small>
</div>

<div id="listaDelitosAdmin" style="max-height: 300px; overflow-y: auto; background: #fff; padding: 10px; border: 1px solid #ddd; display: none;">
    </div>


    <div style="background:#f8f9fa; padding:15px; border-radius:10px; border:1px solid #ddd; margin-bottom:20px;">
        <label style="margin-top:0;">üîé Buscar abonado por correo:</label>
        <div class="grid-2">
            <input type="email" id="adminSearchEmail" placeholder="cliente@correo.com" style="margin-top:5px;">
            <button class="btn-principal" onclick="buscarUsuarioAdmin()" style="margin-top:5px; background:#4b5563;">BUSCAR</button>
        </div>
    </div>

    <div style="background:#e6ffed; padding:15px; border-radius:10px; border:1px solid #b7eb8f; text-align:center;">
        <p style="color:#2e7d32; font-weight:bold; margin-top:0;">‚ö° Novedades</p>
        <p id="lblUltimaRev" style="font-size:0.8em; color:#555; margin-bottom:10px;">Nunca has revisado las novedades.</p>
        
        <button class="btn-principal" onclick="verNuevosRegistros()" style="background:#2e7d32; padding: 12px;">
            VER QUI√âN SE REGISTR√ì DESDE MI √öLTIMA VISITA
        </button>
        
        <div style="margin-top:10px;">
            <small style="cursor:pointer; color:#1a73e8; text-decoration:underline;" onclick="resetearFechaAdmin()">
                (Resetear contador y ver los √∫ltimos 10 hist√≥ricos)
            </small>
        </div>
    </div>
    
    <h3 style="margin-top:20px; border-bottom:2px solid #eee;">Resultados de B√∫squeda:</h3>
    <div style="overflow-x: auto;">
        <table class="report-table">
            <thead>
                <tr>
                    <th>Usuario / Registro</th>
                    <th>Referido Por</th>
                    <th>Estado</th>
                    <th>Vencimiento</th>
                    <th>Acci√≥n</th>
                </tr>
            </thead>
            <tbody id="bodyUsuariosAdmin">
                <tr><td colspan="5" style="text-align:center; color:#999; padding:20px;">Seleccione una opci√≥n arriba</td></tr>
            </tbody>
        </table>
    </div>

</div>


<div class="modulo no-print" style="text-align: center;">
<p style="margin-bottom: 5px; font-weight: bold; color: #1a73e8;">Consulta legal, Soporte Tecnico, Pagos</p>
<button onclick="abrirWhatsApp()" class="btn-whatsapp">WhatsApp Dr. Charles Reyes</button>
</div>

<div class="modulo" style="background: #e8f5e9; border: 2px dashed #2e7d32; text-align: center;">
    <h3 style="color: #2e7d32; margin-top: 0;">üéÅ ¬°Gana 30 d√≠as GRATIS!</h3>
    <p style="font-size: 0.85em;">Recomienda la App a un colega. Si tu referido se suscribe, ambos reciben un mes de regalo.</p>
    <button onclick="compartirReferido()" class="btn-principal" style="background: #2e7d32; padding: 12px;">
        Recomendar a un Colega üì≤
    </button>
</div>

</div>

<div id="modalTerminos" class="modal" style="background: rgba(0,0,0,0.8);">
<div class="modal-content" style="max-width: 700px;">
<h2 style="font-size: 1.2em; text-align: center;">T√âRMINOS Y CONDICIONES DE USO DE LA APLICACI√ìN CALCULADORA PENAL DEL DR. CHARLES REYES</h2>
<p style="font-size: 0.8em; color: #666; text-align: center;">Fecha de √öltima Actualizaci√≥n: 26 de Diciembre de 2025</p>

<div class="contrato-scroll">
<p><strong>IMPORTANTE:</strong> La aceptaci√≥n de estos T&C es obligatoria para el uso de la Aplicaci√≥n. Al hacer clic en "Aceptar" o al utilizar la Aplicaci√≥n, el Usuario declara haber le√≠do, entendido y aceptado plenamente todas las cl√°usulas aqu√≠ contenidas.</p>

<p><strong>1. DEFINICIONES Y OBJETO</strong><br>
1.1. Aplicaci√≥n: Se refiere al software Calculadora Penal del Dr. Charles Reyes...<br>
1.2. Desarrollador: Dr. Charles Reyes, creador y propietario de la Aplicaci√≥n.<br>
1.3. Usuario: Cualquier persona que acceda o utilice la Aplicaci√≥n...<br>
1.5. Cifrado de Extremo a Extremo (E2EE): Mecanismo de seguridad que garantiza que la Data del Usuario es cifrada en el dispositivo del Usuario , utilizando el correo electronico para cifrar los datos, esta ap√±icacion no utiliza llave maestra para cifrar datos, en consexuencia no se garantiza la seguridad total de los datos</p>

<p><strong>2. PROPIEDAD INTELECTUAL</strong><br>
2.1. Titularidad: El Desarrollador es el √∫nico y exclusivo propietario de todos los derechos de propiedad intelectual e industrial sobre la Aplicaci√≥n...</p>

<p><strong>3. RESPONSABILIDADES Y ADVERTENCIAS LEGALES DEL USUARIO</strong><br>
El Usuario reconoce que la Aplicaci√≥n es una herramienta de apoyo y que no sustituye el criterio profesional.<br>
3.1. Advertencia para el Abogado Litigante (Secreto Profesional): El Usuario que act√∫e como Abogado Litigante en el libre ejercicio de su profesion, declara conocer y aceptar que es el √∫nico responsable de garantizar el cumplimiento del Secreto Profesional y que cuenta con la autorizacion para enviar data sensible a servidores externos, en este caso encriptada a los servidores de firebase de google, sin embargo el usuario puese escogwr a traves de un interruptor si guarda la informacion en la nube o localmente en su dispositivo.<br>
3.2. Advertencia para el Funcionario P√∫blico (Riesgo Administrativo y Penal): La Aplicaci√≥n no es un sistema de informaci√≥n oficial ni est√° homologada por las autoridades competentes de la Rep√∫blica Bolivariana de Venezuela, no cumple con las formalidades de la Ley de Infogobierno y el servidor se encuentra alojado fuera de la Republica, aunque la informacion se graba de manera encriptada, la legislacion venezolana prohibe que los servidores esten en custodia y control de un tercero, en consecuencia, todo usuario que se registre y haga uso de esta aplicacion declara QUE NO ES FUNCIONARIO PUBLICO DE LA REPUBLICA BOLIVARIANA DE VENEZUELA relacionado con data sensible de los privados de libertad y libra de toda responsabilidad civil, administrativa y penal al propietario y administrador de esta aplicacion, en conclusion si usted es funcionario publico, por favor ABSTENERSE de usar esta aplicacion.<br>
3.3. Advertencia para el Familiar del Detenido: La Aplicaci√≥n no proporciona asesor√≠a legal; los resultados son meramente indicativos.</p>

<p><strong>4. ALMACENAMIENTO DE DATOS Y SEGURIDAD (E2EE)</strong><br>
4.1. Cifrado de Extremo a extremo (E2EE) y Clave de Usuario: Toda la Data del Usuario ingresada en la Aplicaci√≥n es cifrada mediante E2EE...<br>
4.2. No Acceso al Contenido: El Desarrollador no posee las claves de descifrado y, por lo tanto, no tiene acceso al contenido de la Data del Usuario...<br>
4.4. Exoneraci√≥n por Contenido: El Desarrollador queda totalmente exonerado de cualquier responsabilidad penal, civil o administrativa derivada del contenido de la Data del Usuario.</p>

<p><strong>5. LIMITACI√ìN DE RESPONSABILIDAD</strong><br>
5.1. Exoneraci√≥n por P√©rdida de Datos: El Desarrollador no ser√° responsable por la p√©rdida, corrupci√≥n o inaccesibilidad de la Data del Usuario...<br>
5.2. Exoneraci√≥n por Resultados de C√°lculo: El Desarrollador no garantiza la exactitud absoluta de los c√°lculos generados por la Aplicaci√≥n.</p>

<p><strong>6. USOS PROHIBIDOS</strong><br>
El Usuario se compromete a no utilizar la Aplicaci√≥n para fines il√≠citos o fraudulentos.</p>

<p><strong>7. CIERRE Y TERMINACI√ìN DE CUENTA</strong><br>
El Desarrollador se reserva el derecho de suspender o terminar la cuenta de cualquier Usuario sin previo aviso.</p>

<p><strong>8. LEY APLICABLE Y JURISDICCI√ìN</strong><br>
Estos T&C se rigen e interpretan de conformidad con las leyes de la Rep√∫blica Bolivariana de Venezuela. Cualquier controversia ser√° sometida a la jurisdicci√≥n exclusiva de los tribunales civilew competentes de la ciudad de San Crist√≥bal, Estado T√°chira Venezuela.</p>
</div>

<button class="btn-principal" onclick="aceptarTerminos()" style="padding:15px; background: #34a853;">HE LE√çDO, ENTIENDO Y ACEPTO LOS T√âRMINOS Y CONDICIONES</button>
</div>
</div>

<div id="modalVencimiento" class="modal" style="background-color: rgba(0,0,0,0.9);">
<div class="modal-content" style="text-align: center; margin-top: 15%;">
<h2 style="color: #d93025;">PERIODO DE PRUEBA FINALIZADO</h2>
<p>Para continuar utilizando las herramientas de <b>Iuris Penal</b> y mantener el acceso a sus expedientes, por favor contacte al administrador para activar un plan de suscripci√≥n.</p>
<button onclick="abrirWhatsAppSuscripcion()" class="btn-whatsapp">
üì≤ Contactar al Dr. Charles Reyes
</button>
</div>
</div>

<div id="plantilla-pdf" style="display: none; padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #333;">
    <div style="text-align: center; border-bottom: 2px solid #1a73e8; padding-bottom: 10px; margin-bottom: 20px;">
        <h2 style="margin: 0; color: #1a73e8;">INFORME T√âCNICO DE C√ìMPUTO PENAL</h2>
        <p style="margin: 5px 0; font-weight: bold;">Consultora Iuris - Dr. Charles Reyes</p>
    </div>

    <h3 style="background: #f0f2f5; padding: 8px;">I. DATOS DEL PRIVADO DE LIBERTAD</h3>
    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
        <tr>
            <td style="padding: 5px; border: 1px solid #ddd; width: 30%;"><strong>Nombre:</strong></td>
            <td id="pdf-nombre" style="padding: 5px; border: 1px solid #ddd;"></td>
        </tr>
        <tr>
            <td style="padding: 5px; border: 1px solid #ddd;"><strong>C√©dula:</strong></td>
            <td id="pdf-cedula" style="padding: 5px; border: 1px solid #ddd;"></td>
        </tr>
        <tr>
            <td style="padding: 5px; border: 1px solid #ddd;"><strong>Exp. Judicial:</strong></td>
            <td id="pdf-exp" style="padding: 5px; border: 1px solid #ddd;"></td>
        </tr>
        <tr>
            <td style="padding: 5px; border: 1px solid #ddd;"><strong>Delito:</strong></td>
            <td id="pdf-delito" style="padding: 5px; border: 1px solid #ddd;"></td>
        </tr>
        <tr id="pdf-fila-drogas" style="display: none;">
            <td style="padding: 5px; border: 1px solid #ddd;"><strong>Drogas:</strong></td>
            <td id="pdf-drogas" style="padding: 5px; border: 1px solid #ddd;"></td>
        </tr>
    </table>

    <h3 style="background: #f0f2f5; padding: 8px;">II. RESUMEN DEL C√ìMPUTO</h3>
    <div id="pdf-resumen-calculo" style="margin-bottom: 20px; line-height: 1.6;">
        </div>

    <h3 style="background: #f0f2f5; padding: 8px;">III. PROYECCI√ìN DE BENEFICIOS PENALES</h3>
    <div id="pdf-beneficios">
        </div>

    <div style="margin-top: 50px; text-align: center;">
        <div style="width: 200px; border-top: 1px solid #000; margin: 0 auto;"></div>
        <p style="font-size: 0.8em;">Firma Autorizada<br>Especialista en Derecho Penal</p>
    </div>
</div>

<script>
  let idDelitoEnEdicion = null; // null = Nuevo, "ID" = Editando

// FUNCI√ìN DE AYUDA PARA FORMATO DE FECHA LATINO
function formatFechaLatina(fechaStr) {
    if(!fechaStr) return "";
    const [y, m, d] = fechaStr.split('-');
    return `${d}/${m}/${y}`;
}

// CONFIGURACI√ìN DE FIREBASE
const firebaseConfig = {
apiKey: "AIzaSyBvqlV6yj-V1GMkTiOL2pDBg0VHFanJRa4",
authDomain: "calculadora-penal-dffb3.firebaseapp.com",
projectId: "calculadora-penal-dffb3",
storageBucket: "calculadora-penal-dffb3.firebasestorage.app",
messagingSenderId: "293337226624",
appId: "1:293337226624:web:7b5acb2356faa8842f3555",
measurementId: "G-PN6ZDB6DZ9"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const analytics = firebase.analytics(); 
// --- INICIO DE NUEVA L√ìGICA DE SINCRONIZACI√ìN DE INTERRUPTORES ---
function actualizarEstadoSync(estado) {
    localStorage.setItem('preferenciaSync', estado);
    const checkGestion = document.getElementById('syncToggleGestion');
    const checkPrincipal = document.getElementById('syncToggle');
    if (checkGestion) checkGestion.checked = estado;
    if (checkPrincipal) checkPrincipal.checked = estado;
    console.log("Sincronizaci√≥n de nube: " + (estado ? "ACTIVADA" : "DESACTIVADA"));
}

function cargarPreferenciaSync() {
    const preference = localStorage.getItem('preferenciaSync');
    const estadoInicial = (preference === null) ? true : (preference === 'true');
    actualizarEstadoSync(estadoInicial);
}
// --- FIN DE NUEVA L√ìGICA DE SINCRONIZACI√ìN DE INTERRUPTORES ---

// HELPER DE CIFRADO AUTOM√ÅTICO E2EE
const encryptionHelper = {
getSecretKey: (uid) => CryptoJS.SHA256(uid).toString(),
encrypt: (data, uid) => {
if (!data || data.toString().trim() === "") return "";
return CryptoJS.AES.encrypt(data.toString(), encryptionHelper.getSecretKey(uid)).toString();
},
decrypt: (ciphertext, uid) => {
if (!ciphertext || ciphertext.toString().trim() === "") return "";
try {
const bytes = CryptoJS.AES.decrypt(ciphertext.toString(), encryptionHelper.getSecretKey(uid));
return bytes.toString(CryptoJS.enc.Utf8);
} catch (e) { return "Error de lectura"; }
}
};

// --- NUEVA L√ìGICA DE GESTI√ìN DE EXPEDIENTES ---
let eventosTemporales = [];

// --- FUNCI√ìN DE LIMPIEZA UNIFICADA (Resetea Gesti√≥n y C√≥mputo) ---
function nuevoExpediente() {
    // 1. Limpiar Identificadores
    document.getElementById('casoActivoId').value = ""; 
    document.getElementById('idCasoGestion').value = "";

    // 2. Limpiar todos los inputs, selects y textareas de ambas secciones
    const contenedores = ['#gestion', '#principal'];
    contenedores.forEach(selector => {
        const elementoRaiz = document.querySelector(selector);
        if (elementoRaiz) {
            elementoRaiz.querySelectorAll('input, select, textarea').forEach(i => {
                if (i.tagName === 'SELECT') {
                    i.selectedIndex = 0;
                } else {
                    i.value = "";
                }
            });
        }
    });

    // 3. Limpiar elementos din√°micos espec√≠ficos de C√≥mputo
    document.getElementById('listaRedenciones').innerHTML = "";
    document.getElementById('contenedorPeriodos').innerHTML = "";
    document.getElementById('resultado').style.display = 'none';
    
    // Resetear fecha de corte a hoy por defecto
    const hoy = new Date().toISOString().split('T')[0];
    if (document.getElementById('fFechaCorte')) {
        document.getElementById('fFechaCorte').value = hoy;
    }

    // 4. Limpiar elementos din√°micos espec√≠ficos de Gesti√≥n
    eventosTemporales = [];
    renderizarEventos();
    document.getElementById('gDivDrogas').style.display = 'none';

    // 5. Resetear estados visuales (como la acumulaci√≥n de penas)
    toggleAcumulacion(); 

    console.log("Sistema reseteado: Ambas pesta√±as han sido limpiadas.");
}

// Para mantener compatibilidad con los botones que ya tienes creados:
function nuevoExpedienteGestion() {
    nuevoExpediente();
}

// FUNCI√ìN DE AGREGAR EVENTO ADAPTADA A LOS NUEVOS CAMPOS (Fecha/Hora y Recordatorio)
function agregarEvento() {
    const fecha = document.getElementById('evFecha').value;
    const recordatorio = document.getElementById('evRecordatorio').value;
    const minuta = document.getElementById('evMinuta').value;
    
    if(!fecha || !minuta) return alert("Complete al menos la fecha del evento y la descripci√≥n.");
    
    // Formateamos para que se vea limpio (quitando la T de datetime-local)
    const recordatorioFormateado = recordatorio ? recordatorio.replace('T', ' ') : "Sin recordatorio";
    
    eventosTemporales.push({ 
        fecha: fecha.replace('T', ' '), 
        recordatorio: recordatorioFormateado, 
        minuta 
    });
    
    // Ordenar por fecha (el m√°s reciente o pr√≥ximo primero)
    eventosTemporales.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
    renderizarEventos();
    
    // Limpiar campos despu√©s de agregar
    document.getElementById('evMinuta').value = "";
    document.getElementById('evFecha').value = "";
    document.getElementById('evRecordatorio').value = "";
}

function renderizarEventos() {
    const container = document.getElementById('scrollEventos');
    container.innerHTML = "";
    if(eventosTemporales.length === 0) {
        container.innerHTML = "No hay eventos registrados.";
        return;
    }

    eventosTemporales.forEach((ev, index) => {
        const item = document.createElement('div');
        item.className = "beneficio-item";
        item.style.padding = "10px";
        
        // Capturamos los datos actuales para el recordatorio
        const nombreCliente = document.getElementById('gNombre').value || "Cliente";
        const expediente = document.getElementById('gExpJud').value || "Sin Exp.";

        const fEvento = new Date(ev.fecha);
        const fFormat = fEvento.toLocaleDateString('es-ES') + ' ' + fEvento.toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'});

        item.innerHTML = `
        <div style="display:flex; justify-content: space-between; align-items:center;">
            <div style="flex-grow:1;">
                <b>üìÖ Evento:</b> ${fFormat}<br>
                <b>üîî Aviso:</b> ${ev.recordatorio}<br>
                <b>üìù:</b> ${ev.minuta}
            </div>
            <div style="display:flex; flex-direction:column; gap:5px; margin-left:10px;">
                <button onclick="enviarAGoogleCalendar('${nombreCliente}', '${ev.minuta}', '${ev.recordatorio}', '${expediente}')" 
                        style="background:#1a73e8; color:white; border:none; padding:8px; border-radius:5px; cursor:pointer; font-size:0.75em; font-weight:bold;">
                    üóìÔ∏è SINCRONIZAR
                </button>
                <button onclick="eventosTemporales.splice(${index},1); renderizarEventos();" 
                        style="background:#fee2e2; border:none; cursor:pointer; padding:5px; border-radius:5px; color:#dc2626; font-size:0.75em;">Eliminar</button>
            </div>
        </div>`;
        container.appendChild(item);
    });
}
function listarCasosGestion() {
    const busq = document.getElementById('busquedaGestion').value.toLowerCase();
    const div = document.getElementById('listaCasosGestion');
    if (!div) return; 
    
    div.innerHTML = "";

    casos.filter(c => 
        (c.nombre || "").toLowerCase().includes(busq) || 
        (c.cedula || "").includes(busq)
    ).forEach(c => {
        const idActual = c.id || c.tempId;
        const card = document.createElement('div');
        card.className = "case-card";
        
        card.style.display = "flex";
        card.style.justifyContent = "space-between";
        card.style.alignItems = "center";
        card.style.padding = "10px";

        card.innerHTML = `
            <div style="flex-grow:1;">
                <b>${c.nombre}</b><br>
                <small style="color:#666;">V-${c.cedula}</small>
            </div>
            <div style="display: flex; gap: 8px; align-items: center;">
                <button onclick="cargarCaso('${idActual}')" 
                        style="background:#1a73e8; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:0.85em;">
                    Abrir
                </button>
                <button class="btn-delete" onclick="eliminarCaso('${idActual}')">
                    üóëÔ∏è
                </button>
            </div>
        `;
        div.appendChild(card);
    });
}

function cargarCasoEnGestion(id) {
    cargarCaso(id);
}

// LOGICA DE ACCESO
function loginFirebase() {
const email = document.getElementById('f_email').value;
const pass = document.getElementById('f_pass').value;
const errorDom = document.getElementById('f_error');

if(!email || !pass) return errorDom.innerText = "Complete todos los campos.";

auth.signInWithEmailAndPassword(email, pass).catch(e => {
if(e.code === 'auth/user-not-found') {
errorDom.innerText = "El usuario no existe. Use 'Crear Cuenta'.";
} else if(e.code === 'auth/wrong-password') {
errorDom.innerText = "Contrase√±a incorrecta.";
} else {
errorDom.innerText = "Error: Acceso denegado.";
}
});
}

function logoutFirebase() {
if(confirm("¬øSeguro que desea cerrar sesi√≥n?")) {
auth.signOut().then(() => {
localStorage.removeItem('terminosAceptados'); 
window.location.reload();
});
}
}

function olvideClave() {
const email = document.getElementById('f_email').value;
if(!email) return alert("Por favor, escriba su correo electr√≥nico arriba.");
auth.sendPasswordResetEmail(email)
.then(() => alert("Se ha enviado un enlace de recuperaci√≥n a su correo."))
.catch(e => alert("Error: Aseg√∫rese de que el correo sea v√°lido."));
}

// Funci√≥n visual para alternar pantallas
function toggleModoRegistro(mostrarRegistro) {
    const loginBlock = document.getElementById('bloque-login');
    const regBlock = document.getElementById('bloque-registro');
    const titulo = document.getElementById('auth-title');
    document.getElementById('f_error').innerText = ""; // Limpiar errores

    if (mostrarRegistro) {
        loginBlock.style.display = 'none';
        regBlock.style.display = 'block';
        titulo.innerText = "Crear Nueva Cuenta";
    } else {
        loginBlock.style.display = 'block';
        regBlock.style.display = 'none';
        titulo.innerText = "Inicie Sesi√≥n para continuar";
    }
}

// Funci√≥n de Registro Blindada
function registroFirebase() {
    const email = document.getElementById('f_email').value.trim();
    const pass = document.getElementById('f_pass').value;
    const referidoInput = document.getElementById('f_referido').value.trim();
    const errorDom = document.getElementById('f_error');

    if(!email || !pass) return errorDom.innerText = "Ingrese correo y contrase√±a.";
    if(pass.length < 6) return errorDom.innerText = "M√≠nimo 6 caracteres.";

    // --- AQU√ç EST√Å LA VALIDACI√ìN CLAVE ---
    let referidoFinal = "Ninguno";

    if (referidoInput !== "") {
        // 1. Verificar que parezca un correo real
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(referidoInput)) {
            return errorDom.innerText = "‚ö†Ô∏è El referido debe ser un CORREO v√°lido (ej: abogado@gmail.com).";
        }
        
        // 2. Verificar que no sea √©l mismo
        if (referidoInput.toLowerCase() === email.toLowerCase()) {
            return errorDom.innerText = "‚ö†Ô∏è No puede colocarse a s√≠ mismo como referido.";
        }

        referidoFinal = referidoInput.toLowerCase();
    }

    // Crear usuario
    auth.createUserWithEmailAndPassword(email, pass)
    .then(async (userCredential) => {
        const uid = userCredential.user.uid;
        await db.collection('usuarios').doc(uid).set({
            email: email,
            vencimiento: new Date(Date.now() + (15 * 24 * 60 * 60 * 1000)).toISOString(),
            rol: 'prueba',
            referidoPor: referidoFinal, 
            premioEntregado: false,
            fechaRegistro: new Date().toISOString()
        });
        alert("¬°Bienvenido! Su cuenta ha sido creada.");
    })
    .catch(e => {
        if(e.code === 'auth/email-already-in-use') errorDom.innerText = "El correo ya existe. Inicie sesi√≥n.";
        else if(e.code === 'auth/invalid-email') errorDom.innerText = "Correo inv√°lido.";
        else errorDom.innerText = "Error: " + e.message;
    });
}


function aceptarTerminos() {
localStorage.setItem('terminosAceptados', 'true');
document.getElementById('modalTerminos').style.display = 'none';
}

auth.onAuthStateChanged(user => {
if(user) {
document.getElementById('auth-overlay').style.display = 'none';
document.getElementById('status-bar').style.display = 'flex';
document.getElementById('user-display').innerText = user.email.split('@')[0].toUpperCase();
if (!localStorage.getItem('terminosAceptados')) {
document.getElementById('modalTerminos').style.display = 'block';
}
obtenerSuscripcion(user.uid);
cargarPreferenciaSync();
sincronizarConNube();
} else {
document.getElementById('auth-overlay').style.display = 'flex';
document.getElementById('status-bar').style.none;
}
});

// Variable global para controlar el acceso
let suscripcionVencida = false;

async function obtenerSuscripcion(uid) {
try {
const docRef = db.collection('usuarios').doc(uid);
const doc = await docRef.get();
let venc;
if (doc.exists && doc.data().vencimiento) {
venc = new Date(doc.data().vencimiento);
} else {
const user = auth.currentUser;
const fechaCreacion = new Date(user.metadata.creationTime);
venc = new Date(fechaCreacion.getTime() + (10 * 24 * 60 * 60 * 1000));
await docRef.set({
email: user.email,
vencimiento: venc.toISOString(),
rol: 'prueba',
fechaRegistro: new Date().toISOString()
}, { merge: true });
}
const hoy = new Date();
const diff = Math.ceil((venc - hoy) / (1000 * 60 * 60 * 24));

if (diff <= 0) {
document.getElementById('days-display').innerText = "Suscripci√≥n Vencida";
suscripcionVencida = true; // Marcamos como vencida
} else {
document.getElementById('days-display').innerText = "Prueba: " + diff + " d√≠as restantes";
suscripcionVencida = false;
document.getElementById('modalVencimiento').style.display = 'none';
}
} catch (e) { console.error(e); }
}

// Funci√≥n auxiliar para validar antes de ejecutar tareas premium
function validarAccesoPremium() {
if (suscripcionVencida) {
document.getElementById('modalVencimiento').style.display = 'block';
return false;
}
return true;
}

function abrirWhatsAppSuscripcion() {
const email = auth.currentUser ? auth.currentUser.email : "Usuario no identificado";
const mensaje = encodeURIComponent(`Hola Dr. Charles Reyes, mi correo es ${email} y deseo conocer los planes de suscripci√≥n para Iuris Penal.`);
window.open(`https://wa.me/584247640846?text=${mensaje}`, '_blank');
}

let casos = JSON.parse(localStorage.getItem('casosIuris')) || [];
const DIAS_A√ëO = 360;
const DIAS_MES = 30;

function openTab(evt, tabName) {
    let i, tabcontent, tablinks;
    
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    
    tablinks = document.getElementsByClassName("tab-button");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";

    // ¬°HEMOS ELIMINADO LA CARGA AUTOM√ÅTICA DEL ADMIN AQU√ç!
    // Ahora es manual con el bot√≥n.
}



function exportarDB() {
if (casos.length === 0) return alert("No hay expedientes.");
const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(casos));
const dl = document.createElement('a'); dl.setAttribute("href", dataStr);
dl.setAttribute("download", "C√≥mputos_Iuris_" + new Date().toLocaleDateString() + ".json");
dl.click();
}

function importarDB(event) {
const reader = new FileReader();
reader.onload = (e) => {
try {
const importados = JSON.parse(e.target.result);
if (confirm(`¬øImportar ${importados.length} expedientes?`)) {
casos = importados; localStorage.setItem('casosIuris', JSON.stringify(casos));
listarCasos(); listarCasosGestion(); alert("√âxito.");
}
} catch (err) { alert("Archivo inv√°lido."); }
};
reader.readAsText(event.target.files[0]);
}

// --- FUNCI√ìN DE GUARDADO MEJORADA CON CIFRADO DE BIT√ÅCORA ---
async function guardarCasoCompleto() {
    if (!validarAccesoPremium()) return; // Mantiene tu validaci√≥n de suscripci√≥n
    const userId = auth.currentUser.uid;
    
    // Mantiene tu l√≥gica de identificaci√≥n de caso activo
    let idActivo = document.getElementById('casoActivoId').value || document.getElementById('idCasoGestion').value;
    if (!idActivo) idActivo = "local_" + Date.now();

    const nombre = document.getElementById('gNombre').value || document.getElementById('pNombre').value;
    const cedula = document.getElementById('gCedula').value || document.getElementById('pCedula').value;
    
    if(!nombre || !cedula) return alert("Nombre y C√©dula son obligatorios.");

    // Mantiene tu l√≥gica de recolecci√≥n de datos para uso LOCAL (Sin cifrar en el tel√©fono)
    const datosCasoBase = {
        id: idActivo,
        nombre: nombre,
        cedula: cedula,
        fase: document.getElementById('gFase').value,
        expJud: document.getElementById('gExpJud').value,
        expFis: document.getElementById('gExpFis').value,
        expCar: document.getElementById('gExpCar').value,
        numFis: document.getElementById('gNumFis').value,
        tribunal: document.getElementById('gTribunal').value,
        lugar: document.getElementById('gLugar').value,
        delito: document.getElementById('gDelito').value,
        fIni: document.getElementById('gFechaIni').value,
        familiar: document.getElementById('gFamiliar').value,
        tel: document.getElementById('gTel').value,
        esDrogas: document.getElementById('gEsDrogas').value,
        pTipoDroga: document.getElementById('gTipoDroga').value,
        pCantDroga: document.getElementById('gCantDroga').value,
        cAno: document.getElementById('cAno').value,
        cMes: document.getElementById('cMes').value,
        cDia: document.getElementById('cDia').value,
        esAcum: document.getElementById('esAcum').value,
        fDetencionActual: document.getElementById('fDetencionActual').value,
        eventos: eventosTemporales, 
        fechaMod: Date.now() // Importante para la sincronizaci√≥n incremental
    };

    // Mantiene tu l√≥gica de actualizaci√≥n del array global y localStorage
    const index = casos.findIndex(c => c.id === idActivo);
    if (index !== -1) { casos[index] = datosCasoBase; } else { casos.push(datosCasoBase); }
    localStorage.setItem('casosIuris', JSON.stringify(casos));

    // --- NUEVO M√ìDULO DE SINCRONIZACI√ìN CON CIFRADO TOTAL ---
    const syncActiva = document.getElementById('syncToggle').checked;
    if (syncActiva) {
        try {
            // CIFRAMOS LOS EVENTOS (BIT√ÅCORA)
            const eventosCifrados = eventosTemporales.map(ev => ({
                ...ev,
                minuta: encryptionHelper.encrypt(ev.minuta, userId)
            }));

            // CIFRAMOS TODOS LOS CAMPOS SENSIBLES PARA LA NUBE
            const datosCifrados = {
                ...datosCasoBase,
                nombre: encryptionHelper.encrypt(nombre, userId),
                cedula: encryptionHelper.encrypt(cedula, userId),
                delito: encryptionHelper.encrypt(datosCasoBase.delito, userId),
                fase: encryptionHelper.encrypt(datosCasoBase.fase, userId),
                expJud: encryptionHelper.encrypt(datosCasoBase.expJud, userId),
                expFis: encryptionHelper.encrypt(datosCasoBase.expFis, userId),
                expCar: encryptionHelper.encrypt(datosCasoBase.expCar, userId),
                numFis: encryptionHelper.encrypt(datosCasoBase.numFis, userId),
                tribunal: encryptionHelper.encrypt(datosCasoBase.tribunal, userId),
                lugar: encryptionHelper.encrypt(datosCasoBase.lugar, userId),
                familiar: encryptionHelper.encrypt(datosCasoBase.familiar, userId),
                tel: encryptionHelper.encrypt(datosCasoBase.tel, userId),
                pTipoDroga: encryptionHelper.encrypt(datosCasoBase.pTipoDroga, userId),
                pCantDroga: encryptionHelper.encrypt(datosCasoBase.pCantDroga, userId),
                eventos: eventosCifrados 
            };

            if(idActivo.startsWith("local_")) {
                const docRef = await db.collection('usuarios').doc(userId).collection('expedientes').add(datosCifrados);
                datosCasoBase.id = docRef.id;
                actualizarIdEnPantalla(docRef.id);
                localStorage.setItem('casosIuris', JSON.stringify(casos));
            } else {
                await db.collection('usuarios').doc(userId).collection('expedientes').doc(idActivo).set(datosCifrados);
            }
            alert("Sincronizado con cifrado total ‚úÖ");
        } catch(e) {
            console.error(e);
            alert("Error de conexi√≥n. Guardado local.");
        }
    } else {
        alert("Guardado local exitoso üíæ");
    }
    
    // Mantiene el refresco de tus listas
    listarCasos();
    listarCasosGestion();
}



function actualizarIdEnPantalla(nuevoId) {
    document.getElementById('casoActivoId').value = nuevoId;
    document.getElementById('idCasoGestion').value = nuevoId;
}

// --- SINCRONIZACI√ìN CON DESCIFRADO DE BIT√ÅCORA ---
async function sincronizarConNube() {
    const userId = auth.currentUser.uid;
    const estaSincronizado = document.getElementById('syncToggle').checked;

    if (!estaSincronizado) {
        casos = JSON.parse(localStorage.getItem('casosIuris')) || [];
        listarCasos(); listarCasosGestion();
        return;
    }

    try {
        const ultimaSync = parseInt(localStorage.getItem('ultimaSyncExito')) || 0;
        const snap = await db.collection('usuarios').doc(userId).collection('expedientes')
            .where('fechaMod', '>', ultimaSync).get();

        let casosLocales = JSON.parse(localStorage.getItem('casosIuris')) || [];
        const mapCasos = new Map();
        casosLocales.forEach(c => mapCasos.set(c.id, c));

        if (!snap.empty) {
            snap.forEach(doc => {
                const dataNube = doc.data();
                
                // DESCIFRAMOS LA BIT√ÅCORA
                const eventosDescifrados = (dataNube.eventos || []).map(ev => ({
                    ...ev,
                    minuta: encryptionHelper.decrypt(ev.minuta, userId)
                }));

                // DESCIFRAMOS TODOS LOS CAMPOS AL DESCARGAR
                const casoNubeDecodificado = {
                    ...dataNube,
                    id: doc.id,
                    nombre: encryptionHelper.decrypt(dataNube.nombre, userId),
                    cedula: encryptionHelper.decrypt(dataNube.cedula, userId),
                    delito: encryptionHelper.decrypt(dataNube.delito, userId),
                    fase: encryptionHelper.decrypt(dataNube.fase, userId),
                    expJud: encryptionHelper.decrypt(dataNube.expJud, userId),
                    expFis: encryptionHelper.decrypt(dataNube.expFis, userId),
                    expCar: encryptionHelper.decrypt(dataNube.expCar, userId),
                    numFis: encryptionHelper.decrypt(dataNube.numFis, userId),
                    tribunal: encryptionHelper.decrypt(dataNube.tribunal, userId),
                    lugar: encryptionHelper.decrypt(dataNube.lugar, userId),
                    familiar: encryptionHelper.decrypt(dataNube.familiar, userId),
                    tel: encryptionHelper.decrypt(dataNube.tel, userId),
                    pTipoDroga: encryptionHelper.decrypt(dataNube.pTipoDroga, userId),
                    pCantDroga: encryptionHelper.decrypt(dataNube.pCantDroga, userId),
                    eventos: eventosDescifrados
                };
                mapCasos.set(doc.id, casoNubeDecodificado);
            });

            casos = Array.from(mapCasos.values());
            localStorage.setItem('casosIuris', JSON.stringify(casos));
            localStorage.setItem('ultimaSyncExito', Date.now());
        }

        listarCasos();
        listarCasosGestion();
    } catch(e) {
        console.error("Error en sync:", e);
    }
}


function listarCasos() {
    const b = document.getElementById('busqueda').value.toLowerCase();
    const div = document.getElementById('listaCasos'); 
    if (!div) return;
    
    div.innerHTML = "";

    const casosFiltrados = casos.filter(c => {
        const coincideBusqueda = (c.nombre || "").toLowerCase().includes(b) || (c.cedula || "").includes(b);
        const esEjecucion = (c.fase === "Ejecuci√≥n");
        return coincideBusqueda && esEjecucion;
    });

    casosFiltrados.sort((a, b) => b.fechaMod - a.fechaMod).forEach(c => {
        const card = document.createElement('div'); 
        card.className = "case-card";
        card.innerHTML = `
            <span><b>${c.nombre}</b><br><small>${c.cedula}</small></span>
            <div>
                <button onclick="cargarCaso('${c.id}')" style="background:#1a73e8; color:white; border:none; padding:5px 10px; border-radius:5px;">Abrir</button>
                <button onclick="eliminarCaso('${c.id}')" class="btn-delete">üóëÔ∏è</button>
            </div>`;
        div.appendChild(card);
    });

    if (casosFiltrados.length === 0 && b === "") {
        div.innerHTML = "<p style='text-align:center; color:#666; font-size:0.8em; padding:10px;'>No hay privados en Fase de Ejecuci√≥n registrados.</p>";
    }
}

// --- FUNCI√ìN DE CARGA MEJORADA ---
function cargarCaso(id) {
    const c = casos.find(i => i.id == id); 
    if(!c) return;

    // Sincronizar IDs activos en ambos campos ocultos
    document.getElementById('casoActivoId').value = c.id; 
    document.getElementById('idCasoGestion').value = c.id;

    // --- CARGA EN PESTA√ëA GESTI√ìN ---
    document.getElementById('gNombre').value = c.nombre || "";
    document.getElementById('gCedula').value = c.cedula || "";
    document.getElementById('gExpJud').value = c.expJud || "";
    document.getElementById('gExpFis').value = c.expFis || "";
    document.getElementById('gExpCar').value = c.expCar || "";
    document.getElementById('gNumFis').value = c.numFis || "";
    document.getElementById('gTribunal').value = c.tribunal || "";
    document.getElementById('gLugar').value = c.lugar || "";
    document.getElementById('gFase').value = c.fase || "Preparatoria";
    document.getElementById('gDelito').value = c.delito || "";
    document.getElementById('gFechaIni').value = c.fIni || ""; 
    document.getElementById('gFamiliar').value = c.familiar || "";
    document.getElementById('gTel').value = c.tel || "";
    
    // Cargar Drogas
    document.getElementById('gEsDrogas').value = c.esDrogas || 'no';
    document.getElementById('gTipoDroga').value = c.pTipoDroga || '';
    document.getElementById('gCantDroga').value = c.pCantDroga || '';
    document.getElementById('gDivDrogas').style.display = (c.esDrogas === 'si' ? 'block' : 'none');

    // Cargar Eventos/Bit√°cora
    eventosTemporales = c.eventos || [];
    renderizarEventos();

    // --- CARGA EN PESTA√ëA C√ìMPUTO ---
    document.getElementById('pNombre').value = c.nombre || ""; 
    document.getElementById('pCedula').value = c.cedula || "";
    document.getElementById('pExpJud').value = c.expJud || ""; 
    document.getElementById('pExpCar').value = c.expCar || "";
    document.getElementById('pDelito').value = c.delito || ""; 
    document.getElementById('pLugar').value = c.lugar || "";
    
    // C√≥mputo espec√≠fico
    document.getElementById('cAno').value = c.cAno || ""; 
    document.getElementById('cMes').value = c.cMes || ""; 
    document.getElementById('cDia').value = c.cDia || "";
    document.getElementById('fDetencionUnica').value = c.fIni || ""; // Sincroniza fecha
    document.getElementById('esAcum').value = c.esAcum || "no"; 
    document.getElementById('fDetencionActual').value = c.fDetencionActual || "";

    // Limpiar y cargar Redenciones
    document.getElementById('listaRedenciones').innerHTML = '';
    if(c.redenciones) c.redenciones.forEach(r => agregarFilaRedencion(r.a, r.m, r.d));

    // Limpiar y cargar Periodos Previos
    document.getElementById('contenedorPeriodos').innerHTML = "";
    if(c.periodosPrevios) {
        c.periodosPrevios.forEach(p => {
            const div = document.createElement('div');
            div.className = 'modulo';
            div.style.background = "#f0f7ff";
            div.innerHTML = `<label>Desde:</label><input type="date" class="pInicio" value="${p.inicio}"><label>Hasta:</label><input type="date" class="pFin" value="${p.fin}">`;
            document.getElementById('contenedorPeriodos').appendChild(div);
        });
    }
    
    // Actualizar visibilidad de secciones (Drogas, Acumulaci√≥n, etc.)
    toggleAcumulacion();
    
    // Ocultar resultados previos de la otra pesta√±a si existen
    document.getElementById('resultado').style.display = 'none';

    console.log("Expediente cargado y sincronizado en todas las pesta√±as.");
}

function agregarFilaRedencion(a, m, d) {
const div = document.createElement('div'); div.className = 'grid-red';
div.innerHTML = `<input type="number" class="rAno" value="${a}" placeholder="A"><input type="number" class="rMes" value="${m}" placeholder="M"><input type="number" class="rDia" value="${d}" placeholder="D">
<button class="btn-delete" onclick="this.parentElement.remove()">üóëÔ∏è</button>`;
document.getElementById('listaRedenciones').appendChild(div);
}

function obtenerDiasCalendarioReal(fechaInicio, fechaFin) {
    let f1 = new Date(fechaInicio + "T12:00:00");
    let f2 = new Date(fechaFin + "T12:00:00");
    if (isNaN(f1.getTime()) || isNaN(f2.getTime())) return 0;
    if (f1 > f2) return 0;
    let anio1 = f1.getFullYear();
    let mes1 = f1.getMonth();
    let dia1 = f1.getDate();
    let anio2 = f2.getFullYear();
    let mes2 = f2.getMonth();
    let dia2 = f2.getDate();
    if (dia1 > 30) dia1 = 30;
    if (dia2 > 30) dia2 = 30;
    let d = dia2 - dia1;
    let m = mes2 - mes1;
    let a = anio2 - anio1;
    if (d < 0) { m--; d += 30; }
    if (m < 0) { a--; m += 12; }
    return (a * 360) + (m * 30) + d;
}

function procesarRedencionAutomatica() {
const f1 = new Date(document.getElementById('redInicio').value);
const f2 = new Date(document.getElementById('redFin').value);
const ds = parseInt(document.getElementById('redDiasSemana').value) || 5;
const hd = parseInt(document.getElementById('redHorasDia').value) || 8;
if (isNaN(f1.getTime()) || isNaN(f2.getTime())) return alert("Fechas inv√°lidas");
const diasCronologicos = Math.ceil(Math.abs(f2 - f1) / 86400000);
const totalHoras = (diasCronologicos / 7) * ds * hd;
const diasTrabajados = Math.floor(totalHoras / 8);
const diasRedimidosTotal = Math.floor(diasTrabajados / 2);
if (diasRedimidosTotal >= 0) {
const a√±os = Math.floor(diasRedimidosTotal / 360);
const meses = Math.floor((diasRedimidosTotal % 360) / 30);
const dias = Math.floor((diasRedimidosTotal % 360) % 30);
agregarFilaRedencion(a√±os, meses, dias);
document.getElementById('resultadoMiniRed').innerHTML = `
<div class="info-red">
<b>D√≠as Cronol√≥gicos:</b> ${diasCronologicos}<br><hr>
<b>D√≠as Laborados:</b> ${diasTrabajados}<br><b>Lapso Laborado:</b> ${desglosar(diasTrabajados)}<br><hr>
<b>D√≠as Redimidos (TOTAL):</b> ${diasRedimidosTotal}<br>
<b style="color:#1a73e8;">Lapso a Redimir:</b> ${a√±os}a, ${meses}m, ${dias}d
</div>`;
}
}

function desglosar(t) { 
let a = Math.floor(t / 360); let m = Math.floor((t % 360) / 30); let d = Math.floor((t % 360) % 30);
let res = [];
if (a > 0) res.push(a + (a == 1 ? " a√±o" : " a√±os"));
if (m > 0) res.push(m + (m == 1 ? " mes" : " meses"));
if (d > 0) res.push(d + (d == 1 ? " d√≠a" : " d√≠as"));
return res.length > 0 ? res.join(", ") : "0 d√≠as";
}

function desglosarBreve(totalDias) { 
if (totalDias <= 0) return "0d";
let a = Math.floor(totalDias / 360); let restoDias = totalDias % 360;
let m = Math.floor(restoDias / 30); let d = Math.floor(restoDias % 30);
let resultado = "";
if (a > 0) resultado += a + "a ";
if (m > 0) resultado += m + "m ";
if (d > 0 || resultado === "") resultado += Math.round(d) + "d";
return resultado.trim();
}

function exportarAPDF() {
    const plantilla = document.getElementById('plantilla-pdf');
    const resumenHTML = document.getElementById('resResumen').innerHTML;
    const beneficiosHTML = document.getElementById('resBeneficios').innerHTML;

    if (!resumenHTML || resumenHTML.trim() === "") {
        alert("Primero debe realizar el c√°lculo de la pena para generar un informe.");
        return;
    }

    document.getElementById('pdf-nombre').innerText = document.getElementById('pNombre').value || "No especificado";
    document.getElementById('pdf-cedula').innerText = document.getElementById('pCedula').value || "No especificado";
    document.getElementById('pdf-exp').innerText = document.getElementById('pExpJud').value || "No especificado";
    document.getElementById('pdf-delito').innerText = document.getElementById('pDelito').value || "No especificado";

    const esDrogas = document.getElementById('gEsDrogas').value;
    if(esDrogas === 'si') {
        document.getElementById('pdf-fila-drogas').style.display = 'table-row';
        document.getElementById('pdf-drogas').innerText = 
            (document.getElementById('gTipoDroga').value || "N/A") + " (" + (document.getElementById('gCantDroga').value || "N/A") + ")";
    } else {
        document.getElementById('pdf-fila-drogas').style.display = 'none';
    }

    document.getElementById('pdf-resumen-calculo').innerHTML = resumenHTML;
    document.getElementById('pdf-beneficios').innerHTML = beneficiosHTML;

    const opciones = {
        margin: [15, 15, 15, 15],
        filename: `Informe_Penal_${document.getElementById('pNombre').value || 'Sin_Nombre'}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, logging: false, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    plantilla.style.display = 'block';
    
    html2pdf().set(opciones).from(plantilla).save().then(() => {
        plantilla.style.display = 'none';
    }).catch(err => {
        console.error("Error al generar PDF:", err);
        plantilla.style.display = 'none';
    });
}

function toggleAcumulacion() { const esA = document.getElementById('esAcum').value === 'si'; document.getElementById('seccionUnica').style.display = esA ? 'none' : 'block'; document.getElementById('seccionAcumulada').style.display = esA ? 'block' : 'none'; }
function toggleSubModulo() { const sm = document.getElementById('subModuloRedencion'); sm.style.display = sm.style.display === 'block' ? 'none' : 'block'; }
function agregarPeriodo() {
    const div = document.createElement('div');
    div.className = 'modulo';
    div.style.background = "#f0f7ff";
    div.style.position = "relative";
    div.style.marginBottom = "10px";
    div.innerHTML = `
        <div style="display: flex; justify-content:Âª∫ËÆæ; align-items: center; gap: 10px;">
            <div style="flex-grow: 1;">
                <label>Desde:</label>
                <input type="date" class="pInicio">
                <label>Hasta:</label>
                <input type="date" class="pFin">
            </div>
            <button class="btn-delete" 
                    onclick="this.parentElement.parentElement.remove()" 
                    style="height: fit-content; margin-top: 20px;">
                üóëÔ∏è
            </button>
        </div>
    `;
    
    document.getElementById('contenedorPeriodos').appendChild(div);
}

function abrirWhatsApp() { window.open(`https://wa.me/584247640846`, '_blank'); }

function calcularTodo() {
    const fechaCorteInput = document.getElementById('fFechaCorte').value;
    const hoyStr = fechaCorteInput || new Date().toISOString().split('T')[0];
    
    let df_total_dias = 0; 
    let desgloseHTML = '<div style="font-size: 0.85em; margin-top: 5px; border-top: 1px solid #ccc; padding-top: 5px;">';
    const esAcumulado = document.getElementById('esAcum').value === 'si';

    if (!esAcumulado) {
        const fDetStr = document.getElementById('fDetencionUnica').value;
        if (fDetStr) {
            const dias = obtenerDiasCalendarioReal(fDetStr, hoyStr);
            df_total_dias = dias;
            desgloseHTML += `<b>Detenci√≥n √∫nica:</b> ${formatFechaLatina(fDetStr)} al ${formatFechaLatina(hoyStr)} <br>¬ª Lapso: ${desglosar(dias)}<br>`;
        } else {
            alert("Por favor, ingrese la Fecha de Detenci√≥n.");
            return;
        }
    } else {
        const inis = document.getElementsByClassName('pInicio');
        const fins = document.getElementsByClassName('pFin');
        let contador = 1;

        for (let i = 0; i < inis.length; i++) {
            if (inis[i].value && fins[i].value) {
                const diasLapso = obtenerDiasCalendarioReal(inis[i].value, fins[i].value);
                df_total_dias += diasLapso;
                desgloseHTML += `<b>${contador}¬™ Detenci√≥n:</b> ${formatFechaLatina(inis[i].value)} al ${formatFechaLatina(fins[i].value)} <br>¬ª Lapso: ${desglosar(diasLapso)}<br>`;
                contador++;
            }
        }
        
        const fActStr = document.getElementById('fDetencionActual').value;
        if (fActStr) {
            const diasActual = obtenerDiasCalendarioReal(fActStr, hoyStr);
            df_total_dias += diasActual;
            desgloseHTML += `<b>Detenci√≥n Actual:</b> ${formatFechaLatina(fActStr)} al ${formatFechaLatina(hoyStr)} <br>¬ª Lapso: ${desglosar(diasActual)}<br>`;
        } else {
            alert("En modo acumulado, debe ingresar la 'Detenci√≥n Actual (Desde)'.");
            return;
        }
    }
    desgloseHTML += '</div>';

    let dr = 0;
    const rAnos = document.getElementsByClassName('rAno'),
          rMeses = document.getElementsByClassName('rMes'),
          rDias = document.getElementsByClassName('rDia');
    
    for (let i = 0; i < rAnos.length; i++) {
        dr += (parseInt(rAnos[i].value) || 0) * 360 + 
              (parseInt(rMeses[i].value) || 0) * 30 + 
              (parseInt(rDias[i].value) || 0);
    }

    const pt = (parseInt(document.getElementById('cAno').value) || 0) * 360 + 
               (parseInt(document.getElementById('cMes').value) || 0) * 30 + 
               (parseInt(document.getElementById('cDia').value) || 0);

    if (pt === 0) {
        alert("La pena impuesta no puede ser 0.");
        return;
    }

    const tc = df_total_dias + dr;

    document.getElementById('resultado').style.display = 'block';
    document.getElementById('resTitulo').innerText = "C√≥mputo: " + (document.getElementById('pNombre').value || "S/N");
    document.getElementById('resResumen').innerHTML = `
        <div class="res-box">
            <b>F√≠sico Total:</b> ${desglosar(df_total_dias)}
            ${desgloseHTML}
        </div>
        <div class="res-box"><b>Redimido:</b> ${desglosar(dr)}</div>
        <div class="res-box" style="background:#e6ffed;"><b>TOTAL CUMPLIDO (F√≠sico + Redimido):</b> ${desglosar(tc)}</div>
    `;

    document.getElementById('resBeneficios').innerHTML = `
        ${crearFichaDoble("100% (Fin de Condena)", pt, df_total_dias, dr)}
        ${crearFichaDoble("1/2 (Destacamento de Trabajo)", pt * 0.5, df_total_dias, dr)}
        ${crearFichaDoble("2/3 (R√©gimen Abierto)", pt * (2 / 3), df_total_dias, dr)}
        ${crearFichaDoble("3/4 (Libertad Condicional)", pt * 0.75, df_total_dias, dr)}
    `;
}

function crearFichaDoble(titulo, metaDiasEnBase360, fisicoActual, redimidoActual) {
const fechaCorteInput = document.getElementById('fFechaCorte').value;
let fechaReferencia = fechaCorteInput ? new Date(fechaCorteInput + "T12:00:00") : new Date();
fechaReferencia.setHours(12, 0, 0, 0, 0); 
const opcionesFecha = { day: '2-digit', month: '2-digit', year: 'numeric' };
const diffFisicoTotalDias = Math.round(metaDiasEnBase360 - fisicoActual);
const diffMixtoTotalDias = Math.round(metaDiasEnBase360 - (fisicoActual + redimidoActual));
function proyectarFechaCalendario(diasFaltantes) {
let fechaResultante = new Date(fechaReferencia.getTime());
const signo = diasFaltantes >= 0 ? 1 : -1;
const diasAbs = Math.abs(diasFaltantes);
let anios = Math.floor(diasAbs / 360) * signo;
let meses = Math.floor((diasAbs % 360) / 30) * signo;
let dias = Math.floor(diasAbs % 30) * signo;
fechaResultante.setFullYear(fechaResultante.getFullYear() + anios);
fechaResultante.setMonth(fechaResultante.getMonth() + meses);
fechaResultante.setDate(fechaResultante.getDate() + dias);
return fechaResultante;
}
const fechaFisico = proyectarFechaCalendario(diffFisicoTotalDias);
const fechaMixto = proyectarFechaCalendario(diffMixtoTotalDias);
const diasFisicoTexto = diffFisicoTotalDias > 0 ? diffFisicoTotalDias : 0;
const diasMixtoTexto = diffMixtoTotalDias > 0 ? diffMixtoTotalDias : 0;
return `
<div class="beneficio-item">
<b style="color: #1a73e8; font-size: 1.1em;">${titulo}</b><hr style="border: 0; border-top: 1px solid #eee;">
<div style="margin-bottom: 10px;"><b style="color: #555; font-size: 0.9em;">üîπ Escenario: Solo tiempo f√≠sico</b><br>
<b>Tiempo faltante:</b> ${desglosarBreve(diasFisicoTexto)}<br>
<b>${diffFisicoTotalDias <= 0 ? '‚úÖ Cumplido el:' : 'üìÖ Fecha de cumplimiento:'}</b> 
<span class="${diffFisicoTotalDias <= 0 ? 'txt-cumplido' : 'txt-destaque'}">${fechaFisico.toLocaleDateString('es-ES', opcionesFecha)}</span></div>
<div><b style="color: #555; font-size: 0.9em;">üîπ Escenario: F√≠sico + Redenciones</b><br>
<b>Tiempo faltante:</b> ${desglosarBreve(diasMixtoTexto)}<br>
<b>${diffMixtoTotalDias <= 0 ? '‚úÖ Cumplido el:' : 'üìÖ Fecha de cumplimiento:'}</b> 
<span class="${diffMixtoTotalDias <= 0 ? 'txt-cumplido' : 'txt-destaque'}">${fechaMixto.toLocaleDateString('es-ES', opcionesFecha)}</span></div></div>`;
}

async function eliminarCaso(id) { 
    if(confirm(`¬øEst√° seguro de que desea eliminar este expediente de forma permanente?`)) { 
        try {
            // 1. Intentar eliminar de la nube si el usuario est√° autenticado y tiene ID de Firebase
            if (auth.currentUser && !id.startsWith("local_")) {
                await db.collection('usuarios')
                        .doc(auth.currentUser.uid)
                        .collection('expedientes')
                        .doc(id)
                        .delete();
                console.log("Eliminado de la nube ‚úÖ");
            }

            // 2. ELIMINACI√ìN LOCAL (Obligatoria para que desaparezca de la vista)
            // Filtramos el array global 'casos' para quitar el ID seleccionado
            casos = casos.filter(i => i.id !== id); 
            
            // 3. Actualizar el almacenamiento del navegador
            localStorage.setItem('casosIuris', JSON.stringify(casos));

            // 4. REFRESCAR AMBAS VISTAS
            listarCasos();        // Refresca pesta√±a de C√≥mputo
            listarCasosGestion(); // Refresca pesta√±a de Gesti√≥n
            
            alert("Expediente eliminado con √©xito.");

        } catch(e) {
            console.error("Error al eliminar:", e);
            alert("Hubo un problema al eliminar. Int√©ntelo de nuevo.");
        }
    } 
}


function validarYCalcular() { 
    if (!validarAccesoPremium()) return; // <--- Bloqueo
    if(!document.getElementById('cAno').value) return alert("Ingrese la pena."); 
    calcularTodo(); 
}

function calc71() {
const f1 = new Date(document.getElementById('calc71_inicio').value), f2 = new Date(document.getElementById('calc71_fin').value);
if(isNaN(f1)||isNaN(f2)) return;
let a=f2.getFullYear()-f1.getFullYear(), m=f2.getMonth()-f1.getMonth(), d=f2.getDate()-f1.getDate();
if(d<0){m--;d+=30}if(m<0){a--;m+=12}
document.getElementById('res71').innerText = `Lapso: ${a}a, ${m}m, ${d}d`;
}
function agregarFilaSuma() {
const div = document.createElement('div'); div.className = 'grid-3'; div.style.marginTop = '5px';
div.innerHTML = `<input type="number" class="sa" placeholder="A"><input type="number" class="sm" placeholder="M"><input type="number" class="sd" placeholder="D">`;
document.getElementById('listaLapsosSuma').appendChild(div);
}
function calc72() {
let a=0, m=0, d=0; document.querySelectorAll('.sa').forEach(i=>a+=parseInt(i.value||0)); document.querySelectorAll('.sm').forEach(i=>m+=parseInt(i.value||0)); document.querySelectorAll('.sd').forEach(i=>d+=parseInt(i.value||0));
m+=Math.floor(d/30); d=d%30; a+=Math.floor(m/12); m=m%12; document.getElementById('res72').innerText = `Total: ${a}a, ${m}m, ${d}d`;
}
function calc73() {
const a1 = parseInt(document.getElementById('r1a').value || 0), m1 = parseInt(document.getElementById('r1m').value || 0), d1 = parseInt(document.getElementById('r1d').value || 0);
const a2 = parseInt(document.getElementById('r2a').value || 0), m2 = parseInt(document.getElementById('r2m').value || 0), d2 = parseInt(document.getElementById('r2d').value || 0);
const totalDias1 = (a1 * 360) + (m1 * 30) + d1, totalDias2 = (a2 * 360) + (m2 * 30) + d2;
const diferencia = totalDias1 - totalDias2;
if (diferencia < 0) { document.getElementById('res73').innerText = "Resultado: El segundo lapso no puede ser mayor al primero."; document.getElementById('res73').style.color = "red"; }
else { document.getElementById('res73').innerText = "Resultado: " + desglosar(diferencia); document.getElementById('res73').style.color = "#856404"; }
}
function calc745(op) {
const dateInput = document.getElementById('fBase745').value;
if (!dateInput) return alert("Por favor, seleccione una fecha base.");
const partes = dateInput.split('-'); const anioBase = parseInt(partes[0], 10), mesBase = parseInt(partes[1], 10) - 1, diaBase = parseInt(partes[2], 10);
const a√±osAdd = parseInt(document.getElementById('la745').value || 0), mesesAdd = parseInt(document.getElementById('lm745').value || 0), d√≠asAdd = parseInt(document.getElementById('ld745').value || 0);
let f = new Date(anioBase, mesBase, diaBase);
if (op === 'sumar') { f.setFullYear(f.getFullYear() + a√±osAdd); f.setMonth(f.getMonth() + mesesAdd); f.setDate(f.getDate() + d√≠asAdd); }
else { f.setFullYear(f.getFullYear() - a√±osAdd); f.setMonth(f.getMonth() - mesesAdd); f.setDate(f.getDate() - d√≠asAdd); }
document.getElementById('res745').innerText = "Fecha Resultante: " + f.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
}
function calc76() {
const t = (parseInt(document.getElementById('fra').value||0)*360) + (parseInt(document.getElementById('frm').value||0)*30) + (parseInt(document.getElementById('frd').value||0));
const p = document.getElementById('fraccion').value.split('/'); 
document.getElementById('res76').innerText = "Producto: " + desglosarBreve(Math.floor((t*parseInt(p[0]))/parseInt(p[1])));
}

function generarReporteFiltrado() {
const fDelito = document.getElementById('repDelito').value.toLowerCase();
const fLugar = document.getElementById('repLugar').value.toLowerCase();
const fDesde = document.getElementById('repDesde').value, fHasta = document.getElementById('repHasta').value;
const filtrados = casos.filter(c => {
const cumpleDelito = !fDelito || (c.delito && c.delito.toLowerCase().includes(fDelito));
const cumpleLugar = !fLugar || (c.lugar && c.lugar.toLowerCase().includes(fLugar));
let cumpleFecha = true; if(fDesde || fHasta) { const fechaMod = new Date(c.fechaMod); if(fDesde && fechaMod < new Date(fDesde)) cumpleFecha = false; if(fHasta && fechaMod > new Date(fHasta)) cumpleFecha = false; }
return cumpleDelito && cumpleLugar && cumpleFecha;
});
if (filtrados.length === 0) return alert("No hay datos.");
let html = `<div style="padding:20px; font-family:sans-serif;"><h1 style="color:#1a73e8; text-align:center;">REPORTE DE EXPEDIENTES</h1><table border="1" style="width:100%; border-collapse:collapse; font-size:10px;"><thead><tr style="background:#f2f2f2;"><th>NOMBRE</th><th>C√âDULA</th><th>DELITO</th><th>LUGAR</th><th>CONDENA</th></tr></thead><tbody>${filtrados.map(c => `<tr><td>${c.nombre}</td><td>${c.cedula}</td><td>${c.delito || ''}</td><td>${c.lugar || ''}</td><td>${c.cAno||0}a ${c.cMes||0}m ${c.cDia||0}d</td></tr>`).join('')}</tbody></table></div>`;
const el = document.createElement('div'); el.innerHTML = html;
html2pdf().set({ margin: 10, filename: 'Reporte_Iuris.pdf', html2canvas: { scale: 2 } }).from(el).save();
}

function generarExcelFiltrado() {
const fDelito = document.getElementById('repDelito').value.toLowerCase();
const fLugar = document.getElementById('repLugar').value.toLowerCase();
const fDesde = document.getElementById('repDesde').value, fHasta = document.getElementById('repHasta').value;
const camposSeleccionados = Array.from(document.querySelectorAll('.col-excel:checked')).map(cb => cb.value);
if (camposSeleccionados.length === 0) return alert("Seleccione al menos un campo.");
const filtrados = casos.filter(c => {
const cumpleDelito = !fDelito || (c.delito && c.delito.toLowerCase().includes(fDelito));
const cumpleLugar = !fLugar || (c.lugar && c.lugar.toLowerCase().includes(fLugar));
let cumpleFecha = true; if(fDesde || fHasta) { const fechaMod = new Date(c.fechaMod); if(fDesde && fechaMod < new Date(fDesde)) cumpleFecha = false; if(fHasta && fechaMod > new Date(fHasta)) cumpleFecha = false; }
return cumpleDelito && cumpleLugar && cumpleFecha;
});
const cabeceras = { nombre: "NOMBRE", cedula: "C√âDULA", delito: "DELITO", lugar: "LUGAR", expJud: "EXP. JUDICIAL", expCar: "EXP. CARCELARIO" };
const dataExcel = filtrados.map(c => { let fila = {}; camposSeleccionados.forEach(campo => { fila[cabeceras[campo]] = c[campo] || ""; }); return fila; });
const ws = XLSX.utils.json_to_sheet(dataExcel); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Expedientes");
XLSX.writeFile(wb, `Reporte_Iuris_${new Date().toLocaleDateString()}.xlsx`);
}

document.getElementById('fFechaCorte').value = new Date().toISOString().split('T')[0];
listarCasos();
listarCasosGestion();

// 1. Modificamos el objeto de puntos magn√©ticos para incluir la fracci√≥n exacta
function actualizarLabelRebaja(valor) {
    let val = parseFloat(valor);
    const lblPorcentaje = document.getElementById('labelPorcentaje');
    const lblProporcion = document.getElementById('labelProporcion');
    const slider = document.getElementById('sliderRebaja');
    
    // Definimos la fracci√≥n matem√°tica real para el c√°lculo
    const puntosMagneticos = [
        { valor: 12.5, etiqueta: "1/8", fraccion: 1/8 },
        { valor: 16.66, etiqueta: "1/6", fraccion: 1/6 },
        { valor: 20, etiqueta: "1/5", fraccion: 1/5 },
        { valor: 25, etiqueta: "1/4", fraccion: 1/4 },
        { valor: 33.33, etiqueta: "1/3", fraccion: 1/3 },
        { valor: 50, etiqueta: "1/2", fraccion: 1/2 }
    ];

    let etiquetaActual = "Proporcional";
    let fraccionCalculo = val / 100; // Por defecto usa el porcentaje
    const umbral = 1.5; 

    puntosMagneticos.forEach(punto => {
        if (Math.abs(val - punto.valor) < umbral) {
            val = punto.valor;
            etiquetaActual = punto.etiqueta;
            fraccionCalculo = punto.fraccion; // <--- USAMOS LA FRACCI√ìN EXACTA
            slider.value = val;
        }
    });

    if (val === 0) {
        etiquetaActual = "0";
        fraccionCalculo = 0;
    }

    lblPorcentaje.innerText = val.toFixed(2);
    lblProporcion.innerText = etiquetaActual;
    
    // Guardamos la fracci√≥n exacta en un atributo del slider para usarla en el c√°lculo final
    slider.dataset.fraccionEfectiva = fraccionCalculo;
}

// 2. Ajustamos la funci√≥n de c√°lculo para usar esa fracci√≥n exacta
function calcularAdmision() {
    if (!validarAccesoPremium()) return;
    const totalHoras = aHoras(
        document.getElementById('adm_a').value,
        document.getElementById('adm_m').value,
        document.getElementById('adm_d').value,
        document.getElementById('adm_h').value
    );
    
    // Obtenemos la fracci√≥n exacta guardada o el valor del slider
    const slider = document.getElementById('sliderRebaja');
    const fraccion = slider.dataset.fraccionEfectiva ? parseFloat(slider.dataset.fraccionEfectiva) : (parseFloat(slider.value) / 100);
    
    if (totalHoras <= 0) return alert("Ingrese una pena.");
    
    // Ahora el c√°lculo es: 15 a√±os * (1/3) = 5 a√±os exactos (en horas)
    const rebaja = totalHoras * fraccion;
    const totalFinal = totalHoras - rebaja;

    document.getElementById('resAdmision').innerHTML = 
        `<small>Pena Original: ${desglosarHoras(totalHoras)}</small><br>` +
        `<small>Rebaja: -${desglosarHoras(rebaja)}</small><hr>` +
        `<div style="font-size: 1.2em; color: #27ae60; font-weight: bold;">Final: ${desglosarHoras(totalFinal)}</div>`;
}


function actualizarLabelIncremento(valor) {
    let val = parseFloat(valor);
    const lblPorcentaje = document.getElementById('labelPorcentajeInc');
    const lblProporcion = document.getElementById('labelProporcionInc');
    const slider = document.getElementById('sliderIncremento');

    const puntos = [
        { valor: 12.5, etiqueta: "1/8" },
        { valor: 16.66, etiqueta: "1/6" },
        { valor: 20, etiqueta: "1/5" },
        { valor: 25, etiqueta: "1/4" },
        { valor: 33.33, etiqueta: "1/3" },
        { valor: 50, etiqueta: "1/2" }
    ];

    let etiqueta = "Proporcional";
    const umbral = 1.5;

    puntos.forEach(p => {
        if (Math.abs(val - p.valor) < umbral) {
            val = p.valor;
            etiqueta = p.etiqueta;
            slider.value = val;
        }
    });

    if (val === 0) etiqueta = "0";

    if (lblPorcentaje) lblPorcentaje.innerText = val.toFixed(2);
    if (lblProporcion) lblProporcion.innerText = etiqueta;
}

function agregarFilaPenaReal() {
    const div = document.createElement('div');
    div.className = 'grid-4'; // Cambiado a grid-4
    div.style.marginBottom = '8px';
    div.innerHTML = `
        <input type="number" class="ra" placeholder="A√±os">
        <input type="number" class="rm" placeholder="Meses">
        <input type="number" class="rd" placeholder="D√≠as">
        <input type="number" class="rh" placeholder="Horas">
    `;
    document.getElementById('listaPenasReal').appendChild(div);
}

function calcularConcursoReal() {
    // Asumiendo que usas una funci√≥n aHoras para convertir todo a una unidad com√∫n
    const filas = document.querySelectorAll('#listaPenasReal .grid-4');
    let penasEnHoras = [];

    filas.forEach(fila => {
        const a = fila.querySelector('.ra').value || 0;
        const m = fila.querySelector('.rm').value || 0;
        const d = fila.querySelector('.rd').value || 0;
        const h = fila.querySelector('.rh').value || 0;
        
        // Convertir a horas (usando tu l√≥gica de aHoras)
        penasEnHoras.push(aHoras(a, m, d, h));
    });

    if (penasEnHoras.length === 0) return;

    // Ordenar de mayor a menor
    penasEnHoras.sort((a, b) => b - a);

    const penaMayor = penasEnHoras[0];
    const sumasRestantes = penasEnHoras.slice(1).reduce((acc, curr) => acc + curr, 0);
    
    // Regla: Pena mayor + mitad de la suma de las restantes
    const totalFinalHoras = penaMayor + (sumasRestantes / 2);

    document.getElementById('resReal').innerHTML = 
        `Pena Resultante: ${desglosarHoras(totalFinalHoras)}`; // Usando tu funci√≥n desglosarHoras
}


function exportarTodaLaDataExcel() {
    if (casos.length === 0) return alert("No hay expedientes para exportar.");
    const dataExcel = casos.map(c => {
        return {
            "NOMBRE": c.nombre || "",
            "C√âDULA": c.cedula || "",
            "EXP. JUDICIAL": c.expJud || "",
            "EXP. FISCAL√çA": c.expFis || "",
            "EXP. CARCELARIO": c.expCar || "",
            "FISCAL√çA N¬∫": c.numFis || "",
            "TRIBUNAL": c.tribunal || "",
            "LUGAR DE RECLUSI√ìN": c.lugar || "",
            "FASE PROCESAL": c.fase || "",
            "DELITO": c.delito || "",
            "FECHA DETENCI√ìN": formatFechaLatina(c.fIni),
            "FAMILIAR": c.familiar || "",
            "TEL√âFONO": c.tel || "",
            "FECHA REGISTRO": new Date(c.fechaMod).toLocaleDateString()
        };
    });
    const ws = XLSX.utils.json_to_sheet(dataExcel);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Base de Datos Iuris");
    XLSX.writeFile(wb, `Base_Datos_Completa_Iuris_${new Date().toISOString().split('T')[0]}.xlsx`);
}
async function copiarResultados(event) {
    const nombre = document.getElementById('pNombre')?.value || "N/A";
    const resumen = document.getElementById('resResumen')?.innerText || "";
    const beneficios = document.getElementById('resBeneficios')?.innerText || "";

    const textoACopiar = `INFORME DE C√ìMPUTO PENAL\n` +
                         `Privado: ${nombre}\n\n` +
                         `RESUMEN:\n${resumen}\n\n` +
                         `BENEFICIOS:\n${beneficios}`;

    const btn = event.currentTarget;
    const originalText = btn.innerHTML;

    try {
        await navigator.clipboard.writeText(textoACopiar);
        mostrarExito(btn, originalText);
    } catch (err) {
        try {
            const textArea = document.createElement("textarea");
            textArea.value = textoACopiar;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand("copy");
            document.body.removeChild(textArea);
            mostrarExito(btn, originalText);
        } catch (secondaryErr) {
            console.error('Error definitivo al copiar: ', secondaryErr);
            alert("Error al acceder al portapapeles.");
        }
    }
}

function mostrarExito(btn, textoOriginal) {
    btn.style.background = "#28a745";
    btn.innerHTML = "¬°Copiado con √©xito! ‚úÖ";
    
    setTimeout(() => {
        btn.style.background = "#6c757d";
        btn.innerHTML = textoOriginal;
    }, 2000);
}

function enviarAGoogleCalendar(cliente, descripcion, fechaRecordatorio, expediente) {
    if (!fechaRecordatorio || fechaRecordatorio === "No asignado" || fechaRecordatorio === "") {
        alert("Por favor, asigne una fecha en el campo 'Avisarme el d√≠a' antes de sincronizar.");
        return;
    }

    const fechaLimpia = fechaRecordatorio.replace(/-/g, '');
    const titulo = encodeURIComponent(`IURIS: Exp. ${expediente} - ${cliente}`);
    const detalles = encodeURIComponent(`Gesti√≥n Pendiente: ${descripcion}\n\nGenerado por Calculadora Penal Iuris.`);
    const fechas = `${fechaLimpia}/${fechaLimpia}`;

    const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${titulo}&details=${detalles}&dates=${fechas}`;
    window.open(url, '_blank');
}

function compartirReferido() {
    const emailUsuario = auth.currentUser ? auth.currentUser.email : "mi_correo";
    const mensaje = encodeURIComponent(
        `üìå *INVITACI√ìN ESPECIAL*\n\n` +
        `Colega, le recomiendo la *Calculadora Penal Iuris*. Es una herramienta excelente para c√≥mputos y dosimetr√≠a.\n\n` +
        `Reg√≠strese aqu√≠: https://consultoraiurislegal.github.io/calculadora-penal/\n\n` +
        `üéÅ *Diga que voy de su parte usando mi c√≥digo de referido:* ${emailUsuario}\n` +
        `y pida su mes de regalo al activar su plan.`
    );
    window.open(`https://wa.me/?text=${mensaje}`, '_blank');
}

// LOGICA DE ADMINISTRADOR (A√ëADIDA)
auth.onAuthStateChanged(async (user) => {
    if (user) {
        const doc = await db.collection('usuarios').doc(user.uid).get();
        if (doc.exists && doc.data().rol === 'admin') {
            document.getElementById('tab-admin').style.display = 'block';
        }
    }
});

// Variable para almacenar la clave del localStorage
const KEY_LAST_CHECK = 'admin_ultima_revision';

// Al cargar la p√°gina, mostramos la fecha guardada
document.addEventListener('DOMContentLoaded', () => {
    actualizarLabelFecha();
});

function actualizarLabelFecha() {
    const lastCheck = localStorage.getItem(KEY_LAST_CHECK);
    const lbl = document.getElementById('lblUltimaRev');
    if (lbl) {
        if (lastCheck) {
            const fecha = new Date(lastCheck).toLocaleString();
            lbl.innerText = `√öltima revisi√≥n: ${fecha}`;
        } else {
            lbl.innerText = "A√∫n no has revisado novedades.";
        }
    }
}

// --- FUNCI√ìN PRINCIPAL: VER SOLO LO NUEVO ---
async function verNuevosRegistros() {
    const tbody = document.getElementById('bodyUsuariosAdmin');
    tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>Consultando novedades... ‚è≥</td></tr>";

    // 1. Recuperar la fecha de la √∫ltima vez que diste clic
    // Si no existe (es la primera vez), usamos una fecha muy antigua (a√±o 2020)
    let lastCheck = localStorage.getItem(KEY_LAST_CHECK) || '2020-01-01T00:00:00.000Z';

    try {
        // 2. Consulta INTELIGENTE: Dame solo los que se registraron DESPU√âS de lastCheck
        const snapshot = await db.collection('usuarios')
            .where('fechaRegistro', '>', lastCheck)
            .orderBy('fechaRegistro', 'desc')
            .get();

        if (snapshot.empty) {
            tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; color:#2e7d32; font-weight:bold;'>‚úÖ Est√°s al d√≠a. No hay nuevos registros desde tu √∫ltima visita.</td></tr>";
            // Aunque no haya nuevos, actualizamos la fecha para que la pr√≥xima vez compare desde hoy
            guardarFechaActual();
            return;
        }

        // 3. Si hay nuevos, los mostramos
        renderizarTablaAdmin(snapshot, tbody);
        
        // 4. Guardamos la fecha de HOY como la nueva "√∫ltima revisi√≥n"
        guardarFechaActual();
        alert(`Se encontraron ${snapshot.size} usuarios nuevos.`);

    } catch (e) {
        console.error(e);
        if (e.message.includes("index")) {
            // Esto saldr√° la primera vez: Firebase te pedir√° crear un √≠ndice
            const link = e.message.match(/https:\/\/[^\s]+/)[0];
            tbody.innerHTML = `<tr><td colspan='5' style='color:red; font-size:0.9em;'>
                <b>‚ö†Ô∏è CONFIGURACI√ìN REQUERIDA:</b><br>
                Firebase necesita un √≠ndice para ordenar por fecha.<br>
                <a href="${link}" target="_blank" style="color:blue;">HAGA CLIC AQU√ç PARA CREARLO AUTOM√ÅTICAMENTE</a><br>
                (Espere 2 minutos despu√©s de crearlo y vuelva a intentar).
            </td></tr>`;
        } else {
            tbody.innerHTML = `<tr><td colspan='5' style='color:red;'>Error: ${e.message}</td></tr>`;
        }
    }
}

function guardarFechaActual() {
    localStorage.setItem(KEY_LAST_CHECK, new Date().toISOString());
    actualizarLabelFecha();
}

// Opci√≥n para reiniciar si quieres ver los √∫ltimos 10 sin importar la fecha
function resetearFechaAdmin() {
    if(confirm("¬øDesea borrar la memoria de √∫ltima visita y cargar los 10 √∫ltimos registros hist√≥ricos?")) {
        localStorage.removeItem(KEY_LAST_CHECK);
        actualizarLabelFecha();
        cargarUltimosRegistros(); // Llamamos a la funci√≥n que te di en la respuesta anterior (los 10 √∫ltimos)
    }
}

// MANTENEMOS TU FUNCI√ìN DE B√öSQUEDA (Es vital tenerla aparte)
async function buscarUsuarioAdmin() {
    const emailBusqueda = document.getElementById('adminSearchEmail').value.trim();
    const tbody = document.getElementById('bodyUsuariosAdmin');
    if (!emailBusqueda) return alert("Escriba un correo.");
    tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>Buscando...</td></tr>";

    try {
        const snapshot = await db.collection('usuarios').where('email', '==', emailBusqueda).limit(1).get();
        if (snapshot.empty) {
            tbody.innerHTML = "<tr><td colspan='5' style='color:red; text-align:center;'>No encontrado.</td></tr>";
        } else {
            renderizarTablaAdmin(snapshot, tbody);
        }
    } catch(e) { alert(e.message); }
}

// Funci√≥n auxiliar de pintado (Reutilizable)
function renderizarTablaAdmin(snapshot, tbody) {
    tbody.innerHTML = "";
    snapshot.forEach(doc => {
        const u = doc.data();
        const uid = doc.id;
        const esVigente = new Date(u.vencimiento) > new Date();

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><b>${u.email}</b><br><small>${new Date(u.fechaRegistro).toLocaleDateString()} ${new Date(u.fechaRegistro).toLocaleTimeString()}</small></td>
            <td>${u.referidoPor && u.referidoPor!=="Ninguno" ? `<b style="color:#d93025">${u.referidoPor}</b>` : 'Ninguno'}</td>
            <td style="color:${esVigente?'green':'red'}"><b>${esVigente?'ACTIVO':'VENCIDO'}</b></td>
            <td><input type="date" id="venc-${uid}" value="${u.vencimiento?u.vencimiento.split('T')[0]:''}" style="width:110px;"></td>
            <td><button onclick="actualizarSuscripcionManual('${uid}')">üíæ</button></td>
        `;
        tbody.appendChild(tr);
    });
}


async function actualizarSuscripcionManual(uid) {
    const nuevaFecha = document.getElementById(`venc-${uid}`).value;
    if (!nuevaFecha) return alert("Seleccione una fecha v√°lida.");

    try {
        const fechaISO = new Date(nuevaFecha + "T23:59:59").toISOString();
        await db.collection('usuarios').doc(uid).update({
            vencimiento: fechaISO,
            rol: 'premium'
        });
        alert("Suscripci√≥n actualizada correctamente.");
        cargarUsuariosAdmin();
    } catch (e) {
        alert("Error al actualizar: " + e.message);
    }
}

// --- NUEVAS FUNCIONES PARA MANEJO DE HORAS ---

// Constantes basadas en a√±o de 360 d√≠as (est√°ndar laboral/penal habitual en tu c√≥digo)
const H_DIA = 24;
const H_MES = 30 * 24; // 720 horas
const H_ANO = 360 * 24; // 8640 horas

// Convierte A√±os, Meses, D√≠as, Horas a Total de Horas
function aHoras(a, m, d, h) {
    return (parseInt(a||0) * H_ANO) + 
           (parseInt(m||0) * H_MES) + 
           (parseInt(d||0) * H_DIA) + 
           parseInt(h||0);
}
function desglosarHoras(totalHoras) {
    totalHoras = Math.round(totalHoras); 
    if (totalHoras <= 0) return "0 horas";
    let a = Math.floor(totalHoras / H_ANO);
    let resto = totalHoras % H_ANO;
    let m = Math.floor(resto / H_MES);
    resto = resto % H_MES;
    let d = Math.floor(resto / H_DIA);
    let h = Math.floor(resto % H_DIA);
    let txt = [];
    if(a > 0) txt.push(a + "a");
    if(m > 0) txt.push(m + "m");
    if(d > 0) txt.push(d + "d");
    if(h > 0) txt.push(h + "h");
    return txt.join(" ");
}
function calcularTerminoMedio() {
    const minH = aHoras(
        document.getElementById('tm_min_a').value,
        document.getElementById('tm_min_m').value,
        document.getElementById('tm_min_d').value,
        document.getElementById('tm_min_h').value
    );
    const maxH = aHoras(
        document.getElementById('tm_max_a').value,
        document.getElementById('tm_max_m').value,
        document.getElementById('tm_max_d').value,
        document.getElementById('tm_max_h').value
    );
    if (minH === 0 && maxH === 0) return alert("Ingrese los l√≠mites.");
    const promedioHoras = (minH + maxH) / 2;
    document.getElementById('resTM').innerHTML = 
        `<b>T√©rmino Medio:</b> <br> ${desglosarHoras(promedioHoras)}`;
}
function calcularConcursoIdeal() {
    if (!validarAccesoPremium()) return; 
    const totalHoras = aHoras(
        document.getElementById('ideal_a').value,
        document.getElementById('ideal_m').value,
        document.getElementById('ideal_d').value,
        document.getElementById('ideal_h').value
    );
    const porcentaje = parseFloat(document.getElementById('sliderIncremento').value);
    if (totalHoras <= 0) return alert("Ingrese una pena base.");
    const aumento = totalHoras * (porcentaje / 100);
    const totalFinal = totalHoras + aumento;
    document.getElementById('resIdeal').innerHTML = 
        `Pena Base: ${desglosarHoras(totalHoras)}<br>` +
        `+ Aumento: ${desglosarHoras(aumento)}<br>` +
        `<strong>TOTAL: ${desglosarHoras(totalFinal)}</strong>`;
}
function calcularAdmision() {
    if (!validarAccesoPremium()) return;
    const totalHoras = aHoras(
        document.getElementById('adm_a').value,
        document.getElementById('adm_m').value,
        document.getElementById('adm_d').value,
        document.getElementById('adm_h').value
    );
    const porcentajeRebaja = parseFloat(document.getElementById('sliderRebaja').value);
    if (totalHoras <= 0) return alert("Ingrese una pena.");
    
    const rebaja = totalHoras * (porcentajeRebaja / 100);
    const totalFinal = totalHoras - rebaja;
    document.getElementById('resAdmision').innerHTML = 
        `<small>Pena Original: ${desglosarHoras(totalHoras)}</small><br>` +
        `<small>Rebaja: -${desglosarHoras(rebaja)}</small><hr>` +
        `<div style="font-size: 1.2em; color: #27ae60; font-weight: bold;">Final: ${desglosarHoras(totalFinal)}</div>`;
}
// ==========================================
// M√ìDULO DE GESTI√ìN DE DELITOS Y PRESCRIPCI√ìN
// ==========================================

// 1. CARGAR LISTA DE DELITOS AL INICIAR
// --- C√ìDIGO NUEVO (OPTIMIZADO) ---
// 1. CARGAR LISTA DE DELITOS AL INICIAR
document.addEventListener('DOMContentLoaded', () => {
    
    // === C√ìDIGO DE AUTO-LIMPIEZA PARA TUS 40 USUARIOS ===
    // Cada vez que tengas un problema as√≠, solo cambias "v1" por "v2", "v3", etc.
    const VERSION_ACTUAL = "v1_limpieza_delitos"; 
    
    // Si el usuario no tiene esta marca "v1", significa que tiene la basura vieja
    if (localStorage.getItem('version_cache_seguridad') !== VERSION_ACTUAL) {
        console.log("‚ö†Ô∏è Detectada versi√≥n antigua. Ejecutando limpieza autom√°tica...");
        
        // 1. Borramos la memoria corrupta/vieja
        localStorage.removeItem('catalogoDelitosCache');
        localStorage.removeItem('catalogoFecha');
        
        // 2. Le ponemos la "vacuna" para que no se borre cada vez que entra, solo hoy
        localStorage.setItem('version_cache_seguridad', VERSION_ACTUAL);
    }
    // ====================================================

    cargarDelitosEnSelect(); // Ahora descargar√° la lista limpia
    actualizarLabelFecha();  
});



// Variable global para almacenar delitos en memoria y no gastar lecturas de Firebase
let catalogoDelitos = [];

// --- FUNCIONES DEL ADMINISTRADOR ---

// ==========================================
// NUEVA L√ìGICA DE PRESCRIPCI√ìN (ART. 108 CP)
// ==========================================

// 1. GUARDAR DELITO (ADMIN ACTUALIZADO)
async function guardarDelitoAvanzado() {
    const nombre = document.getElementById('admDelitoNombre').value;
    const ley = document.getElementById('admDelitoLey').value;
    const art = document.getElementById('admDelitoArt').value;
    const min = parseFloat(document.getElementById('admDelitoMin').value);
    const max = parseFloat(document.getElementById('admDelitoMax').value);
    const sancion = document.getElementById('admDelitoSancion').value;
    const tipo = document.getElementById('admDelitoTipo').value;
    const condicion = document.getElementById('admDelitoCondicion').value;

    if (!nombre || isNaN(min) || isNaN(max)) return alert("Complete Nombre y Penas (Min/Max).");

    const datosDelito = {
        nombre: nombre,
        ley: ley,
        articulo: art,
        min: min,
        max: max,
        tipoSancion: sancion,
        tipoAccion: tipo,
        condicion: condicion,
        fechaModificacion: Date.now()
    };

    try {
        if (idDelitoEnEdicion === null) {
            // MODO CREAR NUEVO
            datosDelito.fechaCreacion = Date.now();
            await db.collection('configuracion_global').doc('catalogo_delitos').collection('lista').add(datosDelito);
            alert("Delito GUARDADO correctamente.");
        } else {
            // MODO EDITAR EXISTENTE
            await db.collection('configuracion_global').doc('catalogo_delitos').collection('lista').doc(idDelitoEnEdicion).update(datosDelito);
            alert("Delito ACTUALIZADO correctamente.");
            
            // Resetear modo edici√≥n
            idDelitoEnEdicion = null;
            document.querySelector('#adminPanel h2').innerText = "‚öñÔ∏è Gesti√≥n del Cat√°logo (Nuevo Delito)";
            document.querySelector('#btnGuardarDelito').innerText = "+ GUARDAR EN CAT√ÅLOGO";
            document.querySelector('#btnGuardarDelito').style.background = "#4a148c"; // Volver a morado
        }

        // Limpiar campos
        limpiarFormularioAdmin();
        cargarDelitosEnAdmin();
        
    } catch (e) {
        console.error(e);
        alert("Error: " + e.message);
    }
}

// Funci√≥n auxiliar para limpiar
function limpiarFormularioAdmin() {
    document.getElementById('admDelitoNombre').value = "";
    document.getElementById('admDelitoLey').value = "";
    document.getElementById('admDelitoArt').value = "";
    document.getElementById('admDelitoMin').value = "";
    document.getElementById('admDelitoMax').value = "";
    idDelitoEnEdicion = null;
}


// 2. FILTRADO R√ÅPIDO DE DELITOS (TIPO GOOGLE)
function filtrarDelitosUI() {
    const input = document.getElementById('inputBusquedaDelito');
    const select = document.getElementById('selDelitoPresc');
    
    // Usamos 'normalizarTexto' para quitar acentos y pasar a min√∫sculas
    const textoBusqueda = normalizarTexto(input.value); 
    
    select.innerHTML = "";

    // Filtramos la lista global
    const filtrados = catalogoDelitos.filter(d => 
        normalizarTexto(d.nombre).includes(textoBusqueda)
    );

    if(filtrados.length === 0) {
        const opt = document.createElement('option');
        opt.text = "No se encontraron delitos";
        select.appendChild(opt);
    } else {
        filtrados.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.id;
            opt.text = d.nombre;
            opt.className = "opcion-multilinea"; // <--- IMPORTANTE
            select.appendChild(opt);
        });
    }
}
function actualizarInterfazRebajas() {
    const ejecucion = document.getElementById('selGradoEjecucion').value;
    const divManual = document.getElementById('divFraccionManual');
    const inputFraccion = document.getElementById('fraccionEjecucion');

    if (ejecucion === 'Frustrado') {
        divManual.style.display = 'block';
        inputFraccion.value = "1/3"; // Defecto
    } else if (ejecucion === 'Tentativa') {
        divManual.style.display = 'block';
        inputFraccion.value = "1/2"; // Defecto (puede ser hasta 2/3)
    } else {
        divManual.style.display = 'none';
        inputFraccion.value = "";
    }
}

// 4. C√ÅLCULO INTELIGENTE (EL CORAZ√ìN DEL SISTEMA)
// ==========================================
// C√ÅLCULO ACTUALIZADO (REGLAS 1-6 + SUSPENSI√ìN)
// ==========================================

function calcularPrescripcionInteligente() {
    // 1. VALIDACIONES B√ÅSICAS
    const idDelito = document.getElementById('selDelitoPresc').value;
    const fechaHecho = document.getElementById('fHechoPresc').value;
    
    if (!idDelito) return alert("Por favor, seleccione un delito primero.");
    if (!fechaHecho) return alert("Ingrese la fecha de comisi√≥n del hecho.");

    const delito = catalogoDelitos.find(d => d.id === idDelito);
    
    // Iniciar Iter Procesal (Recibo de explicaci√≥n)
    let iter = `>>> AN√ÅLISIS JUR√çDICO DE PRESCRIPCI√ìN <<<\n`;
    iter += `1. DATOS DEL DELITO\n`;
    iter += `   - Tipo: ${delito.nombre}\n`;
    iter += `   - Sanci√≥n Principal: ${delito.tipoSancion}\n`;
    iter += `   - Rango de Pena: ${delito.min} a ${delito.max} a√±os.\n`;

    // 2. VERIFICAR IMPRESCRIPTIBILIDAD
    if (delito.condicion === 'Imprescriptible') {
        mostrarResultadoImprescriptible(iter);
        return;
    }

    // 3. C√ÅLCULO DE LA PENA APLICABLE (TERM MEDIO + REBAJAS)
    let terminoMedio = (delito.min + delito.max) / 2;
    let penaParaCalculo = terminoMedio;
    iter += `   - T√©rmino Medio Base: ${terminoMedio.toFixed(2)} a√±os.\n\n`;

    // A. Grado de Ejecuci√≥n
    const ejecucion = document.getElementById('selGradoEjecucion').value;
    if (ejecucion !== 'Consumado') {
        const fraccionStr = document.getElementById('fraccionEjecucion').value || "0";
        const [num, den] = fraccionStr.split('/').map(Number);
        if (den > 0) {
            const rebaja = terminoMedio * (num / den);
            penaParaCalculo -= rebaja;
            iter += `2. GRADO DE EJECUCI√ìN (${ejecucion})\n   - Rebaja aplicada: ${fraccionStr} (-${rebaja.toFixed(2)} a√±os)\n   - Subtotal: ${penaParaCalculo.toFixed(2)} a√±os.\n`;
        }
    }

    // B. Grado de Intervenci√≥n
    const intervencion = document.getElementById('selGradoIntervencion').value;
    if (intervencion === 'Complice') {
        const rebajaComplice = penaParaCalculo / 2;
        penaParaCalculo -= rebajaComplice;
        iter += `3. GRADO DE INTERVENCI√ìN (C√≥mplice/Facilitador)\n   - Rebaja legal: 1/2 (-${rebajaComplice.toFixed(2)} a√±os)\n`;
    }
    
    iter += `   >>> PENA APLICABLE FINAL: ${penaParaCalculo.toFixed(2)} A√ëOS <<<\n\n`;

    // 4. DETERMINACI√ìN DEL LAPSO (LAS 6 REGLAS)
    let lapsoPrescripcion = 0;
    const s = delito.tipoSancion; // Presidio, Prisi√≥n, Arresto...
    const p = penaParaCalculo;    // Pena num√©rica

    iter += `4. REGLAS DE PRESCRIPCI√ìN (C√ìDIGO PENAL)\n`;

    // ============================================================
    // L√ìGICA DE LAS REGLAS (CORREGIDA - PRIORIDAD POR GRAVEDAD)
    // ============================================================
    
    // 1. REGLA SUPREMA DE GRAVEDAD (Para evitar errores de etiqueta)
    // Si la pena excede los 10 a√±os, se asume la prescripci√≥n m√°xima (15 a√±os)
    // independientemente de si la base de datos dice "Prisi√≥n" o "Presidio".
    if (p > 10) {
        lapsoPrescripcion = 15;
        iter += `   - Regla 1 (Prioridad por Cuant√≠a): La pena excede 10 a√±os.\n   - PLAZO: 15 A√ëOS.\n`;
    } 
    // 2. Si es menor a 10 a√±os, miramos el tipo de sanci√≥n
    else if (s === 'Presidio') {
        if (p > 7) { 
            // Nota: Como ya filtramos los mayores a 10 arriba, aqu√≠ entran los de 7.01 a 10
            lapsoPrescripcion = 10;
            iter += `   - Regla 2: Presidio > 7 y <= 10 a√±os.\n   - PLAZO: 10 A√ëOS.\n`;
        } else {
            lapsoPrescripcion = 7;
            iter += `   - Regla 3: Presidio <= 7 a√±os.\n   - PLAZO: 7 A√ëOS.\n`;
        }
    } 
    else if (s === 'Prisi√≥n') {
        if (p > 3) {
            lapsoPrescripcion = 5;
            iter += `   - Regla 4: Prisi√≥n > 3 a√±os.\n   - PLAZO: 5 A√ëOS.\n`;
        } else {
            lapsoPrescripcion = 3;
            iter += `   - Regla 5: Prisi√≥n <= 3 a√±os.\n   - PLAZO: 3 A√ëOS.\n`;
        }
    } 
    else if (['Arresto', 'Relegaci√≥n', 'Confinamiento', 'Expulsi√≥n'].includes(s)) {
        if (s === 'Arresto' && p > 0.5) {
            lapsoPrescripcion = 3;
            iter += `   - Regla 5: Arresto > 6 meses.\n   - PLAZO: 3 A√ëOS.\n`;
        } else if (s === 'Arresto' && p <= 0.5) {
            lapsoPrescripcion = 1;
            iter += `   - Regla 6: Arresto 1 a 6 meses.\n   - PLAZO: 1 A√ëO.\n`;
        } else {
            lapsoPrescripcion = 3;
            iter += `   - Regla 5: ${s}.\n   - PLAZO: 3 A√ëOS.\n`;
        }
    } 
    else {
        // Multas, etc.
        lapsoPrescripcion = 1;
        iter += `   - Regla 6: Multa, Suspensi√≥n o Faltas.\n   - PLAZO: 1 A√ëO.\n`;
    }

    // 5. C√ÅLCULO DE FECHAS CON SUSPENSI√ìN
    const fechaBase = new Date(fechaHecho + "T12:00:00"); // Usamos mediod√≠a para evitar errores de zona horaria
    
    // A. Calcular tiempo de suspensi√≥n (Si existe)
    let diasSuspendidos = 0;
    const haySuspension = document.getElementById('chkSuspension').checked;
    
    if (haySuspension) {
        const fSusIni = document.getElementById('fSuspInicio').value;
        const fSusFin = document.getElementById('fSuspFin').value;
        
        if (fSusIni && fSusFin) {
            const d1 = new Date(fSusIni + "T12:00:00");
            const d2 = new Date(fSusFin + "T12:00:00");
            const diffTime = d2 - d1;
            diasSuspendidos = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            
            iter += `\n5. SUSPENSI√ìN DEL LAPSO\n`;
            iter += `   - Desde: ${formatFechaLatina(fSusIni)} Hasta: ${formatFechaLatina(fSusFin)}\n`;
            iter += `   - Total d√≠as suspendidos: ${diasSuspendidos} d√≠as.\n`;
            iter += `   (Este tiempo se suma a la fecha final).\n`;
        }
    }

    // B. Calcular Fechas Finales
    // Ordinaria
    const fOrdinaria = new Date(fechaBase);
    fOrdinaria.setFullYear(fOrdinaria.getFullYear() + lapsoPrescripcion);
    fOrdinaria.setDate(fOrdinaria.getDate() + diasSuspendidos); // Sumamos la suspensi√≥n

    // Extraordinaria (Judicial) = Lapso + Mitad
    const lapsoExtraNumerico = lapsoPrescripcion * 1.5;
    const fExtraordinaria = new Date(fechaBase);
    
    // Sumar a√±os enteros y meses para precisi√≥n matem√°tica
    const anosEnteros = Math.floor(lapsoExtraNumerico);
    const mesesRestantes = (lapsoExtraNumerico - anosEnteros) * 12;
    
    fExtraordinaria.setFullYear(fExtraordinaria.getFullYear() + anosEnteros);
    fExtraordinaria.setMonth(fExtraordinaria.getMonth() + mesesRestantes);
    fExtraordinaria.setDate(fExtraordinaria.getDate() + diasSuspendidos); // Sumamos la suspensi√≥n

    // 6. RENDERIZAR RESULTADOS
    document.getElementById('resPrescripcion').style.display = 'block';
    document.getElementById('resExtraordinarioBox').style.display = 'block';

    document.getElementById('resLapsoOrd').innerHTML = `${lapsoPrescripcion} A√ëOS <br><small>+ ${diasSuspendidos} d√≠as susp.</small>`;
    document.getElementById('resFechaOrd').innerText = fOrdinaria.toLocaleDateString();

    document.getElementById('resLapsoExtra').innerHTML = `${lapsoExtraNumerico} A√ëOS <br><small>+ ${diasSuspendidos} d√≠as susp.</small>`;
    document.getElementById('resFechaExtra').innerText = fExtraordinaria.toLocaleDateString();

    document.getElementById('iterProcesal').innerText = iter;
    document.getElementById('resPrescripcion').scrollIntoView({ behavior: 'smooth', block: 'start' });
}


function mostrarResultadoImprescriptible(iter) {
    document.getElementById('resPrescripcion').style.display = 'block';
    document.getElementById('resLapsoOrd').innerText = "IMPRESCRIPTIBLE";
    document.getElementById('resFechaOrd').innerText = "NUNCA";
    document.getElementById('resExtraordinarioBox').style.display = 'none';
    document.getElementById('iterProcesal').innerText = iter + "   - CONDICI√ìN: El delito es de Lesa Humanidad o contra el Patrimonio P√∫blico (Imprescriptible).";
    document.getElementById('resPrescripcion').scrollIntoView({ behavior: 'smooth', block: 'start' });
}


async function cargarDelitosEnAdmin() {
    const div = document.getElementById('listaDelitosAdmin');
    if(!div) return;
    div.style.display = 'block';
    div.innerHTML = "Cargando...";
    
    try {
        const snapshot = await db.collection('configuracion_global').doc('catalogo_delitos').collection('lista')
                                 .orderBy('nombre', 'asc').get();
        
        div.innerHTML = "";
        if (snapshot.empty) {
            div.innerHTML = "No hay delitos registrados.";
            return;
        }

        snapshot.forEach(doc => {
            const d = doc.data();
            // Creamos un string JSON seguro para pasar los datos a la funci√≥n
            const datosJson = JSON.stringify(d).replace(/"/g, '&quot;');
            
            const item = document.createElement('div');
            item.style.borderBottom = "1px solid #eee";
            item.style.padding = "8px";
            item.style.display = "flex";
            item.style.justifyContent = "space-between";
            item.style.alignItems = "center";
            
            item.innerHTML = `
                <div style="font-size:0.9em;">
                    <b>${d.nombre}</b><br>
                    <span style="color:#666;">${d.min}-${d.max} a√±os | ${d.ley}</span>
                </div>
                <div>
                    <button onclick="prepararEdicion('${doc.id}', ${datosJson})" style="margin-right:10px; cursor:pointer; background:#fff3cd; border:1px solid #ffeeba; border-radius:4px; padding:5px;">
                        ‚úèÔ∏è
                    </button>
                    <button onclick="borrarDelito('${doc.id}')" style="color:white; background:#dc3545; border:none; border-radius:4px; padding:5px 10px; cursor:pointer;">
                        X
                    </button>
                </div>
            `;
            div.appendChild(item);
        });
    } catch (e) {
        console.error(e);
        div.innerHTML = "Error al cargar lista.";
    }
}


async function borrarDelito(id) {
    if(confirm("¬øEliminar este delito del cat√°logo?")) {
        await db.collection('configuracion_global').doc('catalogo_delitos').collection('lista').doc(id).delete();
        cargarDelitosEnAdmin();
        cargarDelitosEnSelect();
    }
}

// --- FUNCIONES DEL USUARIO (PESTA√ëA PRESCRIPCI√ìN) ---

// ==========================================
// OPTIMIZACI√ìN: CARGA DE DELITOS CON CACH√â
// ==========================================

// ==========================================
// CARGA OPTIMIZADA (MODO ARCHIVO MAESTRO)
// ==========================================
// ==========================================
// CARGA OPTIMIZADA: CACH√â INMEDIATO + ACTUALIZACI√ìN SILENCIOSA
// ==========================================
// ==========================================
// FUNCI√ìN DE DIAGN√ìSTICO Y CARGA FORZADA
// ==========================================
// ==========================================
// CARGA DEFINITIVA (MODO SILENCIOSO / PRODUCCI√ìN)
// ==========================================
async function cargarDelitosEnSelect(forzar = false) {
    const selectPresc = document.getElementById('selDelitoPresc');
    const selectsDosim = document.querySelectorAll('.sel-delito-dosim');
    
    // 1. CARGA R√ÅPIDA (CACH√â): Mostrar lo guardado inmediatamente
    // Esto hace que la app parezca instant√°nea
    const memoriaLocal = localStorage.getItem('catalogoDelitosCache');
    if (memoriaLocal) {
        catalogoDelitos = JSON.parse(memoriaLocal);
        actualizarTodosLosSelects(selectPresc, selectsDosim);
        console.log("‚ö° Carga r√°pida desde memoria local.");
    }

    // 2. VERIFICACI√ìN EN SEGUNDO PLANO (SIN AVISOS)
    try {
        // Consultamos la nube calladitos
        const doc = await db.collection('configuracion_global').doc('catalogo_maestro').get();

        if (doc.exists && doc.data().contenido) {
            const jsonNube = doc.data().contenido;
            
            // Si la nube es diferente a lo que tiene el celular, actualizamos
            if (jsonNube !== memoriaLocal || forzar) {
                catalogoDelitos = JSON.parse(jsonNube);
                localStorage.setItem('catalogoDelitosCache', jsonNube); // Guardamos lo nuevo
                
                // Refrescamos la lista visualmente sin interrumpir
                actualizarTodosLosSelects(selectPresc, selectsDosim);
                console.log("‚òÅÔ∏è Base de datos actualizada en segundo plano.");
            } else {
                console.log("‚úÖ El usuario ya tiene la √∫ltima versi√≥n.");
            }
        } else {
            // PLAN B: Si falla el maestro, buscamos la lista individual (En silencio)
            console.warn("‚ö†Ô∏è Maestro no disponible. Usando lista individual...");
            const snap = await db.collection('configuracion_global').doc('catalogo_delitos').collection('lista').get();
            
            if (!snap.empty) {
                catalogoDelitos = [];
                snap.forEach(d => { 
                    let data = d.data(); 
                    data.id = d.id; 
                    catalogoDelitos.push(data); 
                });
                
                // Guardamos y actualizamos
                localStorage.setItem('catalogoDelitosCache', JSON.stringify(catalogoDelitos));
                actualizarTodosLosSelects(selectPresc, selectsDosim);
            }
        }
    } catch (error) {
        console.error("Error de conexi√≥n:", error);
        // NO mostramos alerta. Si falla internet, el usuario sigue feliz con la memoria local (Paso 1).
    }
}



function actualizarTodosLosSelects(selPresc, listaDosim) {
    // A. Actualizar Pesta√±a Prescripciones
    if (selPresc) {
        selPresc.innerHTML = ''; // Limpiamos
        
        // Opci√≥n por defecto
        const defaultOpt = document.createElement('option');
        defaultOpt.text = "-- Busque o seleccione un delito --";
        selPresc.appendChild(defaultOpt);

        // Agregamos los delitos con la clase CSS correcta
        catalogoDelitos.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.id;
            opt.text = d.nombre;
            opt.className = "opcion-multilinea"; // <--- ESTO ARREGLA EL TEXTO CORTADO
            selPresc.appendChild(opt);
        });
    }

    // B. Actualizar Pesta√±a Dosimetr√≠a (Mantiene tu l√≥gica existente)
    if (listaDosim) {
        listaDosim.forEach(sel => {
            const valorPrevio = sel.value; 
            sel.innerHTML = '<option value="">-- Resultados de la b√∫squeda --</option>' + generarOpcionesDelitos();
            sel.value = valorPrevio;
        });
    }
}


// Funci√≥n auxiliar para dibujar (no cuenta como lectura)
function renderizarOpcionesDelito(selectElement) {
    if(!selectElement) return;
    selectElement.innerHTML = '<option value="">-- Busque o seleccione un delito --</option>';
    
    catalogoDelitos.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.id;
        opt.text = d.nombre;
        selectElement.appendChild(opt);
    });
}

// Funci√≥n para poner en un bot√≥n si el usuario quiere actualizar manual
function forzarActualizacionDelitos() {
    if(confirm("¬øDesea descargar la lista m√°s reciente de delitos desde la nube?")) {
        cargarDelitosEnSelect(true); // 'true' obliga a descargar
    }
}


function cargarDatosDelitoSeleccionado() {
    const idSeleccionado = document.getElementById('selDelitoPresc').value;
    const infoDiv = document.getElementById('infoDelito');
    
    if (!idSeleccionado) {
        infoDiv.style.display = 'none';
        return;
    }

    const delito = catalogoDelitos.find(d => d.id === idSeleccionado);
    
    if (delito) {
        infoDiv.style.display = 'block';

        // Llenar datos b√°sicos
        document.getElementById('lblLey').innerText = delito.ley || "N/A";
        document.getElementById('lblArticulo').innerText = delito.articulo || "N/A";
        document.getElementById('lblSancion').innerText = delito.tipoSancion || "No especificada";
        document.getElementById('lblAccion').innerText = delito.tipoAccion || "P√∫blica";
        document.getElementById('lblCondicion').innerText = delito.condicion || "Prescriptible";
        
        // Llenar datos ocultos necesarios para el c√°lculo matem√°tico
        document.getElementById('lblMin').innerText = delito.min;
        document.getElementById('lblMax').innerText = delito.max;
        document.getElementById('lblTiempoPresc').innerText = delito.prescripcionAnos;

        // Mostrar Rango Visual
        document.getElementById('lblRango').innerText = `${delito.min} a ${delito.max} a√±os`;

        // CALCULAR Y MOSTRAR T√âRMINO MEDIO DESGLOSADO (Igual que Dosimetr√≠a)
        const mediaAnos = (delito.min + delito.max) / 2;
        // Usamos tu funci√≥n 'desglosar' multiplicando por 360 d√≠as
        document.getElementById('lblMediaBase').innerText = desglosar(mediaAnos * 360);
    }
}


function calcularPrescripcionExacta() {
    // 1. Validaciones
    const idSeleccionado = document.getElementById('selDelitoPresc').value;
    const fechaHechoStr = document.getElementById('fHechoPresc').value;
    
    if (!idSeleccionado) return alert("Por favor, seleccione un delito de la lista.");
    if (!fechaHechoStr) return alert("Ingrese la fecha de inicio ");

    const delito = catalogoDelitos.find(d => d.id === idSeleccionado);
    const anosBase = parseFloat(delito.prescripcionAnos);

    // 2. Manejo de Fechas
    // Truco: Usar UTC para evitar problemas de zona horaria al sumar a√±os puros
    let fechaInicio = new Date(fechaHechoStr + "T00:00:00"); 

    // 3. Verificar Suspensi√≥n
    let diasSuspension = 0;
    const tieneSuspension = document.getElementById('chkSuspension').checked;
    
    if (tieneSuspension) {
        const fSuspIniStr = document.getElementById('fSuspIni').value;
        const fSuspFinStr = document.getElementById('fSuspFin').value;
        
        if (fSuspIniStr && fSuspFinStr) {
            const fSi = new Date(fSuspIniStr);
            const fSf = new Date(fSuspFinStr);
            const diffTime = Math.abs(fSf - fSi);
            diasSuspension = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        }
    }

    // 4. C√°lculo Ordinario
    // Fecha Base + A√±os de Prescripci√≥n + D√≠as de Suspensi√≥n
    let fOrdinaria = new Date(fechaInicio);
    fOrdinaria.setFullYear(fOrdinaria.getFullYear() + anosBase); // Sumar a√±os
    fOrdinaria.setDate(fOrdinaria.getDate() + diasSuspension); // Sumar suspensi√≥n

    // 5. C√°lculo Extraordinario (Judicial)
    // Lapso es Base + Mitad (1.5)
    const anosExtra = anosBase * 1.5;
    const anosEnteros = Math.floor(anosExtra);
    const mesesRestantes = (anosExtra - anosEnteros) * 12; // Si es 7.5, son 7 a√±os y 6 meses

    let fExtraordinaria = new Date(fechaInicio);
    fExtraordinaria.setFullYear(fExtraordinaria.getFullYear() + anosEnteros);
    fExtraordinaria.setMonth(fExtraordinaria.getMonth() + mesesRestantes);
    fExtraordinaria.setDate(fExtraordinaria.getDate() + diasSuspension); // Sumar suspensi√≥n tambi√©n aqu√≠

    // 6. Mostrar Resultados
    document.getElementById('resPrescripcion').style.display = 'block';
    
    // Formatear fechas para mostrar
    const options = { year: 'numeric', month: 'long', day: 'numeric' };

    document.getElementById('resAnosOrd').innerText = anosBase;
    document.getElementById('resFechaOrd').innerText = fOrdinaria.toLocaleDateString('es-ES', options);

    document.getElementById('resAnosExtra').innerText = anosExtra;
    document.getElementById('resFechaExtra').innerText = fExtraordinaria.toLocaleDateString('es-ES', options);

    // Nota de suspensi√≥n
    const divNota = document.getElementById('resNotaSusp');
    if (diasSuspension > 0) {
        divNota.innerHTML = `‚ö†Ô∏è <b>Nota:</b> Se han sumado <b>${diasSuspension} d√≠as</b> a las fechas de prescripci√≥n debido al periodo de suspensi√≥n indicado.`;
    } else {
        divNota.innerHTML = "";
    }
}
// ==========================================
// M√ìDULO 3: C√ÅLCULO DE PRESCRIPCI√ìN DE LA PENA
// ==========================================

function calcularPrescripcionPena() {
    // 1. OBTENER DATOS
    const a = parseInt(document.getElementById('pen_a').value || 0);
    const m = parseInt(document.getElementById('pen_m').value || 0);
    const d = parseInt(document.getElementById('pen_d').value || 0);
    const tipo = document.getElementById('pen_tipo').value;
    const esConcurso = document.getElementById('chkConcursoPena').checked;
    const fInicioStr = document.getElementById('pen_inicio').value;

    // Validaciones
    if (a === 0 && m === 0 && d === 0) return alert("Ingrese el tiempo de la pena (A√±os, Meses o D√≠as).");
    if (!fInicioStr) return alert("Ingrese la fecha de inicio del c√≥mputo (Sentencia firme o Quebrantamiento).");

    // 2. CONVERTIR PENA A UNIDAD FLOTANTE (A√ëOS DECIMALES) PARA C√ÅLCULO MATEM√ÅTICO
    // Usamos: 1 a√±o = 1, 1 mes = 1/12, 1 d√≠a = 1/360 (Aprox est√°ndar penal para proporciones)
    let penaBaseDecimal = a + (m / 12) + (d / 360);
    
    // Preparar el Iter Procesal
    let iter = `>>> AN√ÅLISIS DE PRESCRIPCI√ìN DE PENA (ART. 112 C.P.) <<<\n`;
    iter += `1. PENA IMPUESTA: ${a} a√±os, ${m} meses, ${d} d√≠as.\n`;
    iter += `   - Tipo de Sanci√≥n: ${tipo}\n\n`;

    // 3. APLICAR REGLAS DEL ART. 112 (FRACCIONES)
    let tiempoOrdinario = 0;
    let explicacionRegla = "";

    if (['Presidio', 'Prisi√≥n', 'Arresto'].includes(tipo)) {
        // Regla: Pena + Mitad (1.5)
        tiempoOrdinario = penaBaseDecimal * 1.5;
        explicacionRegla = "Se suma la MITAD (1/2) de la pena.";
    } else {
        // Relegaci√≥n, Confinamiento: Pena + Tercera Parte (1.3333)
        tiempoOrdinario = penaBaseDecimal + (penaBaseDecimal / 3);
        explicacionRegla = "Se suma la TERCERA PARTE (1/3) de la pena.";
    }

    iter += `2. C√ÅLCULO ORDINARIO\n`;
    iter += `   - Regla aplicada: ${explicacionRegla}\n`;
    iter += `   - Subtotal Ordinario: ${decimalAA√±osMesesDias(tiempoOrdinario)}\n\n`;

    // 4. APLICAR CONCURSO DE DELITOS (INTERRUPTOR)
    let tiempoFinal = tiempoOrdinario;

    if (esConcurso) {
        // Regla Concursal: Al ordinario se le suma una cuarta parte (1/4)
        const incrementoConcurso = tiempoOrdinario / 4;
        tiempoFinal = tiempoOrdinario + incrementoConcurso;
        
        iter += `3. REGLA DE CONCURSO (VARIOS DELITOS)\n`;
        iter += `   - Se suma 1/4 parte a la prescripci√≥n ordinaria.\n`;
        iter += `   - Incremento: +${decimalAA√±osMesesDias(incrementoConcurso)}\n`;
        iter += `   - TOTAL FINAL: ${decimalAA√±osMesesDias(tiempoFinal)}\n\n`;
    } else {
        iter += `3. CONCURSO: No aplica (Delito √∫nico).\n   - TOTAL FINAL: ${decimalAA√±osMesesDias(tiempoFinal)}\n\n`;
    }

    // 5. CALCULAR FECHA FINAL
    // Convertimos el tiempo final (a√±os decimales) a d√≠as totales para sumar a la fecha
    // Nota: Para precisi√≥n calendario, sumamos A√±os enteros, luego Meses, luego D√≠as.
    
    const objTiempo = desglosarDecimal(tiempoFinal); // Devuelve {a, m, d}
    const fechaInicio = new Date(fInicioStr + "T12:00:00");
    const fechaFinal = new Date(fechaInicio);

    fechaFinal.setFullYear(fechaFinal.getFullYear() + objTiempo.a);
    fechaFinal.setMonth(fechaFinal.getMonth() + objTiempo.m);
    fechaFinal.setDate(fechaFinal.getDate() + objTiempo.d);

    iter += `4. C√ìMPUTO DE FECHAS\n`;
    iter += `   - Inicio (Firmeza/Quebrantamiento): ${new Date(fInicioStr).toLocaleDateString()}\n`;
    iter += `   - Tiempo a transcurrir: ${objTiempo.a}a, ${objTiempo.m}m, ${objTiempo.d}d.\n`;
    
    // 6. MOSTRAR RESULTADOS
    document.getElementById('resPenaBox').style.display = 'block';
    
    document.getElementById('lblTiempoPena').innerText = `${objTiempo.a} A√±os, ${objTiempo.m} Meses, ${objTiempo.d} D√≠as`;
    document.getElementById('lblFechaPena').innerText = fechaFinal.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    
    document.getElementById('iterPena').innerText = iter;
    
    // Scroll autom√°tico al resultado
    document.getElementById('resPenaBox').scrollIntoView({ behavior: 'smooth' });
}

// --- FUNCIONES AUXILIARES MATEM√ÅTICAS ---

function desglosarDecimal(anosDecimales) {
    const a = Math.floor(anosDecimales);
    const restoAnos = anosDecimales - a;
    
    const mesesDecimales = restoAnos * 12;
    const m = Math.floor(mesesDecimales);
    
    const diasDecimales = (mesesDecimales - m) * 30;
    const d = Math.round(diasDecimales);
    
    return { a, m, d };
}

function decimalAA√±osMesesDias(val) {
    const o = desglosarDecimal(val);
    return `${o.a}a, ${o.m}m, ${o.d}d`;
}
// ==========================================
// C√ìDIGO JS PARA LA NUEVA DOSIMETR√çA AVANZADA
// ==========================================

let modificadoresTemporales = []; // Para el admin
let contadorDelitosUI = 0; // Para generar IDs √∫nicos

// --- B. INTERFAZ DE USUARIO (DOSIMETR√çA DIN√ÅMICA) ---

function agregarBloqueDelito() {
    contadorDelitosUI++;
    const idBloque = `delitoUI_${contadorDelitosUI}`;
    const idSelect = `sel_${contadorDelitosUI}`; 
    const contenedor = document.getElementById('contenedorDelitosDosimetria');
    
    const div = document.createElement('div');
    div.className = "sub-modulo";
    div.style.display = "block"; 
    div.style.borderLeft = "5px solid #1a73e8";
    div.style.marginBottom = "15px";
    div.id = idBloque;

    div.innerHTML = `
        <style>
            .opcion-multilinea {
                white-space: normal !important;
                word-wrap: break-word !important;
                border-bottom: 1px solid #f0f0f0;
                padding: 6px;
                font-size: 0.9em;
            }
        </style>

        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0;">Delito #${contadorDelitosUI}</h3>
            <button onclick="document.getElementById('${idBloque}').remove(); verificarConcursoUI();" style="color:red; border:none; background:none; font-weight:bold; cursor:pointer;">üóëÔ∏è Eliminar</button>
        </div>
        
        <label>Buscar delito:</label>
        <input type="text" placeholder="Escriba para filtrar (ej: robo...)" 
               onkeyup="filtrarDelitosDosimetria(this, '${idSelect}')" 
               style="margin-bottom:5px; background:#f0f8ff;">
        
        <select id="${idSelect}" class="sel-delito-dosim" onchange="cargarInfoDelitoDosimetria(this, '${idBloque}')" size="7" style="height: auto; min-height: 180px;">
            <option value="">-- Resultados de la b√∫squeda --</option>
            ${generarOpcionesDelitos()} 
        </select>
        <small style="color:#666; display:block; margin-top:2px;">üëÜ Seleccione el delito en la lista</small>

        <div class="info-base-dosim" style="background:#e8f0fe; padding:10px; margin-top:10px; border-radius:8px; font-size:0.9em; display:none; border: 1px solid #b6d4fe;">
            <div class="grid-2">
                <div><b>Ley:</b> <span class="lbl-ley"></span></div>
                <div><b>Art√≠culo:</b> <span class="lbl-art"></span></div>
            </div>
            
            <div style="margin-top:5px; padding-top:5px; border-top:1px dashed #ccc;">
                <b>Tipo de Pena:</b> <span class="lbl-sancion" style="color:#d93025; font-weight:bold; text-transform: uppercase;"></span>
            </div>

            <div style="margin-top:5px;">
                <b>L√≠mites:</b> <span class="lbl-rango"></span> <br>
                <b>T√©rmino Medio:</b> <span class="lbl-media" style="color:#1a73e8; font-weight:bold;"></span>
            </div>
        </div>

        <div style="margin-top:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
            <label style="color:#333; font-weight:bold;">1. Pena Base Individualizada (Art. 37 CP):</label>
            <div class="grid-3">
                <input type="number" class="pi-a" placeholder="A√±os">
                <input type="number" class="pi-m" placeholder="Meses">
                <input type="number" class="pi-d" placeholder="D√≠as">
            </div>
            <small style="color:#666;">(Resultado tras compensar atenuantes/agravantes gen√©ricas y especificas)</small>
        </div>

        <div style="margin-top:10px; background:#f9f9f9; padding:10px; border-radius:8px;">
            
            <div class="area-modificadores" style="display:none; margin-bottom:15px;">
                <label style="color:#6a1b9a;">Circunstancias Ley Especial:</label>
                <div class="lista-checks-mod"></div>
            </div>

            <div style="margin-bottom:15px;">
                <label>Grado de Ejecuci√≥n:</label>
                <select class="sel-ejecucion" onchange="toggleFraccionTentativa(this)">
                    <option value="Consumado">Delito Consumado (Sin rebaja)</option>
                    <option value="Frustrado">Delito Frustrado (Rebaja 1/3)</option>
                    <option value="Tentativa">Tentativa (Rebaja Variable)</option>
                </select>

                <div class="box-tentativa" style="display:none; background:#fff3cd; padding:10px; margin-top:5px; border-radius:5px; border:1px solid #ffeeba;">
                    <label style="color:#856404; font-size:0.9em; margin-top:0;">Fracci√≥n de rebaja a aplicar:</label>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <input type="text" class="input-fraccion-tentativa" value="1/2" placeholder="Ej: 1/2" style="background:white;">
                        <small style="color:#666; line-height:1.2;">(Edite ej: 1/2, 1/3, 2/3)</small>
                    </div>
                </div>
            </div>

            <div>
                <label>Grado de Intervenci√≥n:</label>
                <select class="sel-participacion" onchange="toggleFraccionParticipacion(this)">
                    <option value="Perpetrador">Autor / Coautor / Coop. Inmediato (Igual pena)</option>
                    <option value="Complice">C√≥mplice Simple / Facilitador (Rebaja 1/2)</option>
                    <option value="Variable">Complicidad Correspectiva / Otro (Rebaja Variable)</option>
                </select>

                <div class="box-participacion-var" style="display:none; background:#d1e7dd; padding:10px; margin-top:5px; border-radius:5px; border:1px solid #badbcc;">
                    <label style="color:#0f5132; font-size:0.9em; margin-top:0;">Fracci√≥n de rebaja por Participaci√≥n:</label>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <input type="text" class="input-fraccion-part" value="1/2" placeholder="Ej: 1/4" style="background:white;">
                        <small style="color:#666; line-height:1.2;">(Ingrese fracci√≥n ej: 1/4, 1/6)</small>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    contenedor.appendChild(div);
    verificarConcursoUI();
}

// === AGREGA ESTA PEQUE√ëA FUNCI√ìN NUEVA DEBAJO DE LA ANTERIOR ===
function toggleFraccionParticipacion(select) {
    const parentDiv = select.parentNode;
    const box = parentDiv.querySelector('.box-participacion-var');
    if (select.value === 'Variable') {
        box.style.display = 'block';
    } else {
        box.style.display = 'none';
    }
}

// ==========================================
// HELPER PARA B√öSQUEDAS (Ignora acentos y may√∫sculas)
// ==========================================
function normalizarTexto(texto) {
    if (!texto) return "";
    return texto.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
}



function generarOpcionesDelitos() {
    // Agregamos la clase 'opcion-multilinea' para que el CSS funcione
    return catalogoDelitos.map(d => `<option value="${d.id}" class="opcion-multilinea">${d.nombre}</option>`).join('');
}


function cargarInfoDelitoDosimetria(select, idBloque) {
    const bloque = document.getElementById(idBloque);
    const idDelito = select.value;
    const delito = catalogoDelitos.find(d => d.id === idDelito);
    
    if(!delito) return;

    bloque.querySelector('.info-base-dosim').style.display = 'block';
    
    // AQU√ç MOSTRAMOS LOS DATOS NUEVOS
    bloque.querySelector('.lbl-ley').innerText = delito.ley || "N/A";
    bloque.querySelector('.lbl-art').innerText = delito.articulo || "N/A";
    
    // CAMBIO: MOSTRAR EL TIPO DE SANCI√ìN (Presidio, Prisi√≥n, etc.)
    bloque.querySelector('.lbl-sancion').innerText = delito.tipoSancion || "No especificada";

    bloque.querySelector('.lbl-rango').innerText = `${delito.min} a ${delito.max} a√±os`;
    
    // Convertimos a√±os a d√≠as (* 360) y usamos 'desglosar'
    const mediaAnos = (delito.min + delito.max) / 2;
    bloque.querySelector('.lbl-media').innerText = desglosar(mediaAnos * 360);

    // Carga de modificadores espec√≠ficos
    const areaMod = bloque.querySelector('.area-modificadores');
    const listaMod = bloque.querySelector('.lista-checks-mod');
    listaMod.innerHTML = "";
    
    if(delito.modificadores && delito.modificadores.length > 0) {
        areaMod.style.display = 'block';
        delito.modificadores.forEach((m, i) => {
            const divCheck = document.createElement('div');
            divCheck.innerHTML = `
                <label style="display:inline; font-weight:normal;">
                    <input type="checkbox" class="chk-mod" data-tipo="${m.tipo}" data-fraccion="${m.fraccion}" data-nombre="${m.nombre}">
                    ${m.nombre} (${m.tipo === 'Aumento' ? '+' : '-'}${m.fraccion})
                </label>
            `;
            listaMod.appendChild(divCheck);
        });
    } else {
        areaMod.style.display = 'none';
    }
}


function verificarConcursoUI() {
    const num = document.getElementById('contenedorDelitosDosimetria').childElementCount;
    document.getElementById('seccionConcurso').style.display = (num > 1) ? 'block' : 'none';
}

function actualizarUIConcurso() {
    const tipo = document.getElementById('tipoConcurso').value;
    document.getElementById('uiConcursoIdeal').style.display = (tipo === 'Ideal') ? 'block' : 'none';
}

// --- C. L√ìGICA DE C√ÅLCULO (CON REORDENAMIENTO) ---

function calcularDosimetriaFinal() {
    const bloques = document.querySelectorAll('#contenedorDelitosDosimetria .sub-modulo');
    if(bloques.length === 0) return alert("Agregue al menos un delito.");

    let penasIndividuales = [];
    let iter = ">>> ITER DOSIM√âTRICO <<<\n\n";

    bloques.forEach((bloque, index) => {
        let nombreDelito = "Delito Desconocido";
        if(bloque.querySelector('.sel-delito-dosim').selectedIndex > 0) {
            nombreDelito = bloque.querySelector('.sel-delito-dosim').selectedOptions[0].text;
        }
        
        // A. Obtener pena base manual
        const a = parseFloat(bloque.querySelector('.pi-a').value) || 0;
        const m = parseFloat(bloque.querySelector('.pi-m').value) || 0;
        const d = parseFloat(bloque.querySelector('.pi-d').value) || 0;
        let penaHoras = aHoras(a, m, d, 0);

        iter += `DELITO ${index+1}: ${nombreDelito.toUpperCase()}\n`;
        iter += `   [BASE] Art. 37 CP: ${desglosarHoras(penaHoras)}\n`;

        // B. C√ÅLCULO EN CASCADA

        // 1. Modificadores Espec√≠ficos
        const checks = bloque.querySelectorAll('.chk-mod:checked');
        if(checks.length > 0) {
            checks.forEach(chk => {
                const fraccionStr = chk.dataset.fraccion; 
                const [num, den] = fraccionStr.split('/').map(Number);
                const cantidad = penaHoras * (num/den); 
                
                if(chk.dataset.tipo === 'Aumento') {
                    penaHoras += cantidad;
                    iter += `   [MOD] Agravante Esp. (${chk.dataset.nombre}): +${desglosarHoras(cantidad)}\n`;
                } else {
                    penaHoras -= cantidad;
                    iter += `   [MOD] Atenuante Esp. (${chk.dataset.nombre}): -${desglosarHoras(cantidad)}\n`;
                }
            });
        }

        // 2. Grado de Ejecuci√≥n
        const ejecucion = bloque.querySelector('.sel-ejecucion').value;
        if(ejecucion !== 'Consumado') {
            let rebaja = 0;
            let desc = "";
            let fraccionUsada = "";

            if(ejecucion === 'Frustrado') { 
                fraccionUsada = "1/3";
                rebaja = penaHoras / 3; 
                desc = "Frustraci√≥n"; 
            } else if (ejecucion === 'Tentativa') { 
                const inputFraccion = bloque.querySelector('.input-fraccion-tentativa').value || "1/2";
                const [num, den] = inputFraccion.split('/').map(Number);
                if (den > 0) {
                    fraccionUsada = inputFraccion;
                    rebaja = penaHoras * (num / den);
                    desc = "Tentativa";
                }
            }

            if (rebaja > 0) {
                penaHoras -= rebaja;
                iter += `   [EJECUCI√ìN] ${desc} (${fraccionUsada}): -${desglosarHoras(rebaja)}\n`;
            }
        }

        // 3. Participaci√≥n (ACTUALIZADO CON OPCI√ìN VARIABLE)
        const part = bloque.querySelector('.sel-participacion').value;
        if(part !== 'Perpetrador') {
            let rebaja = 0;
            let desc = "";
            let fracVis = "";

            if (part === 'Complice') {
                // C√≥mplice Simple (Fijo 1/2)
                rebaja = penaHoras / 2;
                desc = "C√≥mplice Simple";
                fracVis = "1/2";
            } else if (part === 'Variable') {
                // Opci√≥n Variable
                const inputFraccion = bloque.querySelector('.input-fraccion-part').value || "1/2";
                const [num, den] = inputFraccion.split('/').map(Number);
                if (den > 0) {
                    rebaja = penaHoras * (num / den);
                    desc = "Participaci√≥n Variable";
                    fracVis = inputFraccion;
                } else {
                    iter += `   [ERROR] Fracci√≥n de participaci√≥n inv√°lida. Se omite.\n`;
                }
            }

            if(rebaja > 0) {
                penaHoras -= rebaja;
                iter += `   [PARTICIPACI√ìN] ${desc} (${fracVis}): -${desglosarHoras(rebaja)}\n`;
            }
        }

        iter += `   = SUB-TOTAL ${nombreDelito}: ${desglosarHoras(penaHoras)}\n\n`;
        penasIndividuales.push(penaHoras);
    });

    // 2. CONCURSO (ACTUALIZADO CON "SIN CONCURSO")
    let penaTotalHoras = 0;
    
    if(penasIndividuales.length > 1) {
        penasIndividuales.sort((a, b) => b - a);
        const penaMayor = penasIndividuales[0];
        const tipoConcurso = document.getElementById('tipoConcurso').value;

        iter += `--- REGLAS DE CONCURSO (${tipoConcurso.toUpperCase()}) ---\n`;

        if(tipoConcurso === 'Real') {
            iter += `   - Pena m√°s grave: ${desglosarHoras(penaMayor)}\n`;
            let sumaOtras = 0;
            for(let i=1; i < penasIndividuales.length; i++) sumaOtras += penasIndividuales[i];
            const aumento = sumaOtras / 2;
            penaTotalHoras = penaMayor + aumento;
            iter += `   - Aumento (1/2 de restante): +${desglosarHoras(aumento)}\n`;
        
        } else if (tipoConcurso === 'SinConcurso') {
            // SUMA ARITM√âTICA SIMPLE
            iter += `   - Acumulaci√≥n Material (Suma Simple):\n`;
            penasIndividuales.forEach((p, i) => {
                iter += `     + Delito ${i+1}: ${desglosarHoras(p)}\n`;
                penaTotalHoras += p;
            });
            iter += `   - (Se recuerda el l√≠mite constitucional de 30 a√±os)\n`;

        } else {
            // Concurso Ideal
            iter += `   - Pena m√°s grave: ${desglosarHoras(penaMayor)}\n`;
            const fracInput = document.getElementById('fraccionIdeal').value || "0";
            let aumento = 0;
            if(fracInput.includes('/')) {
                const [n, d] = fracInput.split('/').map(Number);
                if(d>0) aumento = penaMayor * (n/d);
            }
            penaTotalHoras = penaMayor + aumento;
            iter += `   - Aumento Ideal (${fracInput}): +${desglosarHoras(aumento)}\n`;
        }
    } else {
        penaTotalHoras = penasIndividuales[0];
        iter += `--- DELITO √öNICO ---\n`;
    }

    // 3. ADMISI√ìN DE HECHOS
    if(document.getElementById('chkAdmision').checked) {
        const fracAdm = document.getElementById('fraccionAdmision').value || "1/3";
        const [n, d] = fracAdm.split('/').map(Number);
        if(d>0) {
            const rebaja = penaTotalHoras * (n/d);
            penaTotalHoras -= rebaja;
            iter += `--- ADMISI√ìN DE LOS HECHOS ---\n`;
            iter += `   - Rebaja solicitada (${fracAdm}): -${desglosarHoras(rebaja)}\n`;
        }
    }

    // 4. RESULTADO
    document.getElementById('resDosimetria').style.display = 'block';
    document.getElementById('lblPenaFinal').innerText = desglosarHoras(penaTotalHoras);
    document.getElementById('iterDosimetria').innerText = iter;
    
    const hoy = new Date();
    const horasEnDias = Math.floor(penaTotalHoras / 24); 
    hoy.setDate(hoy.getDate() + horasEnDias);
    document.getElementById('lblFechaFinal').innerText = hoy.toLocaleDateString();
}


// NUEVA FUNCI√ìN VISUAL
function toggleFraccionTentativa(select) {
    // Buscamos la cajita amarilla que est√° justo debajo del select
    const parentDiv = select.parentNode; 
    const box = parentDiv.querySelector('.box-tentativa');
    
    if (select.value === 'Tentativa') {
        box.style.display = 'block';
    } else {
        box.style.display = 'none';
    }
}
// ==========================================
// FUNCI√ìN FALTANTE: FILTRADO EN DOSIMETR√çA
// ==========================================

function filtrarDelitosDosimetria(input, selectId) {
    const texto = normalizarTexto(input.value); // <--- USAMOS NORMALIZAR
    const select = document.getElementById(selectId);
    if(!select) return;
    
    select.innerHTML = "";
    const filtrados = catalogoDelitos.filter(d => normalizarTexto(d.nombre).includes(texto));

    if(filtrados.length === 0) {
        const opt = document.createElement('option');
        opt.text = "No se encontraron coincidencias";
        select.appendChild(opt);
    } else {
        filtrados.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.id;
            opt.text = d.nombre;
            opt.className = "opcion-multilinea"; 
            select.appendChild(opt);
        });
    }
}

// L√ìGICA DE CONVERSIONES Y CONMUTACIONES
// ==========================================

function calcularEquivalencia() {
    // 1. Obtener d√≠as totales
    const a = parseInt(document.getElementById('conv_a').value || 0);
    const m = parseInt(document.getElementById('conv_m').value || 0);
    const d = parseInt(document.getElementById('conv_d').value || 0);
    
    // Usamos 360 y 30 para estandarizar
    let totalDiasOrigen = (a * 360) + (m * 30) + d;

    if (totalDiasOrigen <= 0) return alert("Ingrese el tiempo a convertir.");

    const regla = document.getElementById('tipoConversion').value;
    let diasResultantes = 0;
    let explicacion = "";

    // 2. Aplicar Reglas Matem√°ticas
    switch(regla) {
        // HACIA PRISI√ìN
        case 'arr_pri': // 2 Arresto = 1 Prisi√≥n
            diasResultantes = totalDiasOrigen / 2;
            explicacion = "Regla: 2 d√≠as de Arresto equivalen a 1 de Prisi√≥n (Entre 2).";
            break;
        case 'rel_pri': // 2 Rel/Conf = 1 Prisi√≥n
            diasResultantes = totalDiasOrigen / 2;
            explicacion = "Regla: 2 d√≠as de Releg/Conf equivalen a 1 de Prisi√≥n (Entre 2).";
            break;
        
        // HACIA PRESIDIO
        case 'arr_pres': // 3 Arresto = 1 Presidio
            diasResultantes = totalDiasOrigen / 3;
            explicacion = "Regla: 3 d√≠as de Arresto equivalen a 1 de Presidio (Entre 3).";
            break;
        case 'rel_pres': // 4 Relegaci√≥n = 1 Presidio
            diasResultantes = totalDiasOrigen / 4;
            explicacion = "Regla: 4 d√≠as de Relegaci√≥n equivalen a 1 de Presidio (Entre 4).";
            break;
        case 'conf_pres': // 5 Conf/Exp = 1 Presidio
            diasResultantes = totalDiasOrigen / 5;
            explicacion = "Regla: 5 d√≠as de Conf/Exp equivalen a 1 de Presidio (Entre 5).";
            break;
        case 'pri_pres': // 2 Prisi√≥n = 1 Presidio
            diasResultantes = totalDiasOrigen / 2;
            explicacion = "Regla: 2 d√≠as de Prisi√≥n equivalen a 1 de Presidio (Entre 2).";
            break;
    }

    // 3. Mostrar Resultado
    const div = document.getElementById('resEquivalencia');
    div.style.display = 'block';
    
    div.innerHTML = `
        <strong>Tiempo Origen:</strong> ${desglosar(totalDiasOrigen)}<br>
        <small>${explicacion}</small><hr>
        <strong style="color:#e67e22; font-size:1.2em;">EQUIVALE A: ${desglosar(Math.floor(diasResultantes))}</strong>
        <br><small>(D√≠as exactos: ${diasResultantes.toFixed(2)})</small>
    `;
}


function calcularConmutacion() {
    // 1. Obtener d√≠as totales
    const a = parseInt(document.getElementById('conm_a').value || 0);
    const m = parseInt(document.getElementById('conm_m').value || 0);
    const d = parseInt(document.getElementById('conm_d').value || 0);
    
    let diasBase = (a * 360) + (m * 30) + d;
    if (diasBase <= 0) return alert("Ingrese la pena original.");

    const tipo = document.getElementById('tipoConmutacion').value;
    let aumento = 0;
    let reglaTxt = "";

    // 2. Calcular Aumento
    if (tipo === 'pres_a_pri') {
        // Aumento de 1/3
        aumento = diasBase / 3;
        reglaTxt = "Aumento de una tercera parte (1/3)";
    } else if (tipo === 'pri_a_arr') {
        // Aumento de 1/4
        aumento = diasBase / 4;
        reglaTxt = "Aumento de una cuarta parte (1/4)";
    } else if (tipo === 'pri_a_conf') {
        // Aumento de 1/3
        aumento = diasBase / 3;
        reglaTxt = "Aumento de una tercera parte (1/3)";
    }

    const totalFinal = diasBase + aumento;

    // 3. Mostrar Resultado
    const div = document.getElementById('resConmutacion');
    div.style.display = 'block';
    
    div.innerHTML = `
        <strong>Pena Original:</strong> ${desglosar(diasBase)}<br>
        <small>${reglaTxt}: +${desglosar(Math.floor(aumento))}</small><hr>
        <strong style="color:#2980b9; font-size:1.2em;">NUEVA PENA: ${desglosar(Math.floor(totalFinal))}</strong>
    `;
}

function calcularOperacionFraccion() {
    // 1. Obtener Lapso Base
    const a = parseInt(document.getElementById('op_a').value || 0);
    const m = parseInt(document.getElementById('op_m').value || 0);
    const d = parseInt(document.getElementById('op_d').value || 0);
    
    // Convertir a d√≠as (Base 360)
    const totalBase = (a * 360) + (m * 30) + d;
    
    if (totalBase <= 0) return alert("Ingrese el lapso base.");

    // 2. Obtener Fracci√≥n
    const fracStr = document.getElementById('op_frac').value;
    if (!fracStr.includes('/')) return alert("Ingrese una fracci√≥n v√°lida (Ej: 1/3)");
    
    const [num, den] = fracStr.split('/').map(Number);
    if (!den || den === 0) return alert("Fracci√≥n inv√°lida.");

    // 3. Calcular la porci√≥n (La fracci√≥n del tiempo)
    const porcionDias = Math.floor(totalBase * (num / den));

    // 4. Realizar la Suma o Resta
    const operacion = document.getElementById('op_tipo').value;
    let totalFinal = 0;
    let signo = "";

    if (operacion === 'sumar') {
        totalFinal = totalBase + porcionDias;
        signo = "+ SUMA";
    } else {
        totalFinal = totalBase - porcionDias;
        signo = "- RESTA";
    }

    // 5. Mostrar Resultado
    const div = document.getElementById('resOperacionFrac');
    div.style.display = 'block';
    
    div.innerHTML = `
        <div style="font-size:0.9em;">
            <b>Base:</b> ${desglosar(totalBase)}<br>
            <b>El ${fracStr} es:</b> ${desglosar(porcionDias)}
        </div>
        <hr>
        <div style="font-size:1.1em; color:#8e44ad; font-weight:bold;">
            RESULTADO (${signo}):<br>
            ${desglosar(totalFinal)}
        </div>
    `;
}
// ==========================================
// FUNCI√ìN ADMIN: CREAR ARCHIVO MAESTRO
// ==========================================
async function publicarCatalogoMaestro() {
    if(!confirm("¬øDesea empaquetar todos los delitos en un Archivo Maestro?\nEsto permitir√° que 1000 usuarios descarguen todo gastando solo 1 lectura cada uno.")) return;

    try {
        console.log("Leyendo todos los delitos individuales...");
        // 1. Leemos (gastamos lecturas nosotros una sola vez)
        const snapshot = await db.collection('configuracion_global').doc('catalogo_delitos').collection('lista').get();
        
        let listaMaestra = [];
        snapshot.forEach(doc => {
            let d = doc.data();
            d.id = doc.id; // Guardamos el ID original
            listaMaestra.push(d);
        });

        console.log(`Empaquetando ${listaMaestra.length} delitos...`);

        // 2. Guardamos el PAQUETE COMPLETO en un solo documento
        // Usamos JSON.stringify para guardarlo como texto simple (es m√°s barato y r√°pido)
        const jsonString = JSON.stringify(listaMaestra);

        await db.collection('configuracion_global').doc('catalogo_maestro').set({
            contenido: jsonString,
            fechaPublicacion: Date.now(),
            totalDelitos: listaMaestra.length
        });

        alert(`‚úÖ ¬°√âXITO!\nSe ha publicado el Archivo Maestro con ${listaMaestra.length} delitos.\n\nAhora los usuarios descargar√°n este √∫nico archivo en lugar de consultar toda la base de datos.`);

    } catch (e) {
        console.error(e);
        alert("Error al publicar: " + e.message);
    }
}
function descargarPlantillaDelitos() {
    const data = [
        {
            "NOMBRE": "Ej: Homicidio Intencional",
            "LEY": "C√≥digo Penal",
            "ARTICULO": "405",
            "MIN_ANOS": 12,
            "MAX_ANOS": 18,
            "SANCION": "Presidio",   // Opciones: Presidio, Prisi√≥n, Arresto
            "ACCION": "P√∫blica",     // Opciones: P√∫blica, Privada
            "CONDICION": "Prescriptible" // Opciones: Prescriptible, Imprescriptible
        }
    ];
    
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Plantilla_Delitos");
    XLSX.writeFile(wb, "Plantilla_Carga_Masiva_Iuris.xlsx");
}
async function procesarExcelDelitos() {
    const input = document.getElementById('inputExcelDelitos');
    const status = document.getElementById('statusExcel');
    
    if(!input.files[0]) return;

    status.innerText = "‚è≥ Leyendo archivo...";
    
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet);

            if(jsonData.length === 0) return alert("El archivo est√° vac√≠o.");

            if(!confirm(`Se encontraron ${jsonData.length} delitos. ¬øDesea subirlos a la base de datos?`)) {
                input.value = ""; // Limpiar
                status.innerText = "";
                return;
            }

            status.innerText = "üöÄ Subiendo a Firebase... Por favor espere.";
            
            let contador = 0;
            const batchSize = 400; // Firebase permite lotes de 500 max
            let batch = db.batch();

            for (let i = 0; i < jsonData.length; i++) {
                const row = jsonData[i];
                
                // Validamos que tenga al menos nombre
                if(!row.NOMBRE) continue;

                // Referencia a documento nuevo
                const docRef = db.collection('configuracion_global').doc('catalogo_delitos').collection('lista').doc();
                
                batch.set(docRef, {
                    nombre: row.NOMBRE || "Sin Nombre",
                    ley: row.LEY || "N/A",
                    articulo: row.ARTICULO ? String(row.ARTICULO) : "N/A",
                    min: parseFloat(row.MIN_ANOS) || 0,
                    max: parseFloat(row.MAX_ANOS) || 0,
                    tipoSancion: row.SANCION || "Prisi√≥n",
                    tipoAccion: row.ACCION || "P√∫blica",
                    condicion: row.CONDICION || "Prescriptible",
                    fechaCreacion: Date.now()
                });

                contador++;

                // Si llegamos al l√≠mite del lote o es el √∫ltimo, enviamos
                if (contador % batchSize === 0 || i === jsonData.length - 1) {
                    await batch.commit();
                    batch = db.batch(); // Reiniciar lote
                    status.innerText = `‚úÖ Procesados ${contador} de ${jsonData.length}...`;
                }
            }

            alert(`¬°√âxito! Se importaron ${contador} delitos correctamente.`);
            status.innerText = "Carga completada.";
            input.value = ""; // Limpiar input
            
            // Actualizar lista visual
            cargarDelitosEnAdmin(); 

        } catch (error) {
            console.error(error);
            alert("Error al procesar el archivo. Verifique que use la plantilla correcta.");
            status.innerText = "Error en la carga.";
        }
    };
    reader.readAsArrayBuffer(input.files[0]);
}
function prepararEdicion(id, datos) {
    // 1. Llenar los campos con los datos del delito seleccionado
    document.getElementById('admDelitoNombre').value = datos.nombre || "";
    document.getElementById('admDelitoLey').value = datos.ley || "";
    document.getElementById('admDelitoArt').value = datos.articulo || "";
    document.getElementById('admDelitoMin').value = datos.min || "";
    document.getElementById('admDelitoMax').value = datos.max || "";
    document.getElementById('admDelitoSancion').value = datos.tipoSancion || "Prisi√≥n";
    document.getElementById('admDelitoTipo').value = datos.tipoAccion || "P√∫blica";
    document.getElementById('admDelitoCondicion').value = datos.condicion || "Prescriptible";

    // 2. Cambiar estado global a "EDITANDO"
    idDelitoEnEdicion = id;

    // 3. Cambiar visualmente el bot√≥n para que se note
    const btn = document.querySelector('#adminPanel button[onclick="guardarDelitoAvanzado()"]');
    if(btn) {
        btn.id = "btnGuardarDelito"; // Asegurar que tenga ID
        btn.innerText = "üíæ ACTUALIZAR DATOS DELITO";
        btn.style.background = "#e67e22"; // Naranja para indicar edici√≥n
    }
    
    // 4. Scroll hacia arriba para ver el formulario
    document.getElementById('adminPanel').scrollIntoView({ behavior: 'smooth' });
    
    alert(`Modo Edici√≥n Activado para: ${datos.nombre}`);
}
// ==========================================
// UX: ANIMACI√ìN "EMPUJONCITO" DEL MEN√ö
// ==========================================
document.addEventListener('DOMContentLoaded', () => {
    // Esperamos 1.5 segundos a que el usuario se ubique
    setTimeout(() => {
        const menu = document.querySelector('.tabs-container');
        if(menu) {
            // 1. Deslizar suavemente a la derecha (mostrar que hay m√°s)
            menu.scrollBy({ left: 80, behavior: 'smooth' });
            
            // 2. Regresar al inicio autom√°ticamente
            setTimeout(() => {
                menu.scrollBy({ left: -80, behavior: 'smooth' });
            }, 800);
        }
    }, 1500);
});

</script>
</body>
</html>
